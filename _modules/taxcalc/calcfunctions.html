
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>taxcalc.calcfunctions &#8212; Tax-Calculator</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/taxcalc/calcfunctions';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/PSL.svg" class="logo__image only-light" alt="Tax-Calculator - Home"/>
    <script>document.write(`<img src="../../_static/PSL.svg" class="logo__image only-dark" alt="Tax-Calculator - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Tax-Calculator
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../usage/starting.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/overview.html">Structural overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/data.html">Data for Tax-Calculator</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../guide/index.html">User guide</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide/python_interface.html">Python interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/cli.html">Command-line interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/policy_params.html">Policy parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/input_vars.html">Input variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/output_vars.html">Output variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/assumption_params.html">Assumption parameters</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../recipes/index.html">Recipes</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../recipes/recipe00.html">Basic Recipe: Static Analysis of a Simple Reform</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../recipes/recipe01.html">Recipe 1: Directly Comparing Two Reforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../recipes/recipe02.html">Recipe 2: Estimating Behavioral Response to Reform</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../recipes/recipe03.html">Recipe 3: Creating a Custom Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../recipes/recipe04.html">Recipe 4: Estimating Differential Reform Response</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../recipes/recipe04_pandas.html">Recipe 4: Estimating Differential Reform Response - pandas version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../recipes/recipe05.html">Recipe 5: Redefining Expanded Income</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../recipes/recipe06.html">Recipe 6: Analyzing a Non-Parametric Reform</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage/tcja_after_2025.html">OBBBA: TCJA after 2025</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../about/history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/releases.html">Release history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/LICENSE.html">License</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../contributing/contributor_guide.html">Contributor guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/pr_workflow.html">Pull request workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/param_naming.html">Policy parameter naming and placing conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/RELEASING.html">Releasing Tax-Caclculator Packages</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/public_api.html">Tax-Calculator Python API</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/calcfunctions.html">Tax-Calculator CalcFunctions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/calculator.html">Tax-Calculator Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/consumption.html">Tax-Calculator Consumption</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/data.html">Tax-Calculator Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/decorators.html">Tax-Calculator Decorators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/growdiff.html">Tax-Calculator GrowDiff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/growfactors.html">Tax-Calculator GrowFactors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/parameters.html">Tax-Calculator Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/policy.html">Tax-Calculator Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/records.html">Tax-Calculator Records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/taxcalcio.html">Tax-Calculator IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/utils.html">Tax-Calculator Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/utilsprvt.html">Tax-Calculator Private Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/calcfunctions.html">Tax-Calculator CalcFunctions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/calculator.html">Tax-Calculator Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/consumption.html">Tax-Calculator Consumption</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/data.html">Tax-Calculator Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/decorators.html">Tax-Calculator Decorators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/growdiff.html">Tax-Calculator GrowDiff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/growfactors.html">Tax-Calculator GrowFactors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/parameters.html">Tax-Calculator Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/policy.html">Tax-Calculator Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/records.html">Tax-Calculator Records</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/taxcalcio.html">Tax-Calculator IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/utils.html">Tax-Calculator Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/utilsprvt.html">Tax-Calculator Private Utilities</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tax-Calculator use cases</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../use_cases.html">Recorded use cases</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/PSLmodels/Tax-Calculator" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/PSLmodels/Tax-Calculator/issues/new?title=Issue%20on%20page%20%2F_modules/taxcalc/calcfunctions.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for taxcalc.calcfunctions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Tax-Calculator functions that calculate payroll and individual income taxes.</span>

<span class="sd">These functions are imported into the Calculator class.</span>

<span class="sd">Note: the parameter_indexing_CPI_offset parameter is no longer used.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># CODING-STYLE CHECKS:</span>
<span class="c1"># pycodestyle calcfunctions.py</span>
<span class="c1"># pylint --disable=locally-disabled calcfunctions.py</span>
<span class="c1">#</span>
<span class="c1"># pylint: disable=too-many-lines</span>
<span class="c1"># pylint: disable=invalid-name</span>
<span class="c1"># pylint: disable=too-many-arguments</span>
<span class="c1"># pylint: disable=too-many-positional-arguments</span>
<span class="c1"># pylint: disable=too-many-locals</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">taxcalc.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">iterate_jit</span><span class="p">,</span> <span class="n">JIT</span>


<div class="viewcode-block" id="BenefitPrograms">
<a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.BenefitPrograms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">BenefitPrograms</span><span class="p">(</span><span class="n">calc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate total government cost and consumption value of benefits</span>
<span class="sd">    delivered by non-repealed benefit programs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    calc: Calculator object</span>
<span class="sd">        calc represents the reform while self represents the baseline</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None:</span>
<span class="sd">        The function modifies calc</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># zero out benefits delivered by repealed programs</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">array_len</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_housing_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;housing_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_ssi_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ssi_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_snap_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;snap_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_tanf_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;tanf_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_vet_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;vet_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_wic_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;wic_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_mcare_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcare_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_mcaid_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcaid_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_oasdi_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02400&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_ui_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02300&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_other_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;other_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="c1"># calculate government cost of all benefits</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;housing_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ssi_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;snap_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;tanf_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;vet_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;wic_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcare_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcaid_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02400&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02300&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ubi&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;other_ben&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;benefit_cost_total&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
    <span class="c1"># calculate consumption value of all benefits</span>
    <span class="c1"># (assuming that cash benefits have full value)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;housing_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_housing_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ssi_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;snap_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_snap_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;tanf_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_tanf_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;vet_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_vet_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;wic_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_wic_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcare_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_mcare_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcaid_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_mcaid_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02400&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02300&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ubi&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;other_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_other_value&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;benefit_value_total&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>



<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">EI_PayrollTax</span><span class="p">(</span><span class="n">SS_Earnings_c</span><span class="p">,</span> <span class="n">e00200p</span><span class="p">,</span> <span class="n">e00200s</span><span class="p">,</span> <span class="n">pencon_p</span><span class="p">,</span> <span class="n">pencon_s</span><span class="p">,</span>
                  <span class="n">FICA_ss_trt_employer</span><span class="p">,</span> <span class="n">FICA_ss_trt_employee</span><span class="p">,</span>
                  <span class="n">FICA_mc_trt_employer</span><span class="p">,</span> <span class="n">FICA_mc_trt_employee</span><span class="p">,</span>
                  <span class="n">ALD_SelfEmploymentTax_hc</span><span class="p">,</span> <span class="n">SS_Earnings_thd</span><span class="p">,</span> <span class="n">SECA_Earnings_thd</span><span class="p">,</span>
                  <span class="n">e00900p</span><span class="p">,</span> <span class="n">e00900s</span><span class="p">,</span> <span class="n">e02100p</span><span class="p">,</span> <span class="n">e02100s</span><span class="p">,</span> <span class="n">k1bx14p</span><span class="p">,</span>
                  <span class="n">k1bx14s</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span> <span class="n">setax</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span> <span class="n">ptax_oasdi</span><span class="p">,</span>
                  <span class="n">sey</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span>
                  <span class="n">was_plus_sey_p</span><span class="p">,</span> <span class="n">was_plus_sey_s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute part of total OASDI+HI payroll taxes and earned income variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    SS_Earnings_c: float</span>
<span class="sd">        Maximum taxable earnings for Social Security.</span>
<span class="sd">        Individual earnings below this amount are subjected to</span>
<span class="sd">          OASDI payroll tax.</span>
<span class="sd">        This parameter is indexed by rate of growth in average wages not by</span>
<span class="sd">          the price inflation rate.</span>
<span class="sd">    e00200p: float</span>
<span class="sd">        Wages, salaries, and tips for taxpayer net of pension contributions</span>
<span class="sd">    e00200s: float</span>
<span class="sd">        Wages, salaries, and tips for spouse net of pension contributions</span>
<span class="sd">    pencon_p: float</span>
<span class="sd">        Contributions to defined-contribution pension plans for taxpayer</span>
<span class="sd">    pencon_s: float</span>
<span class="sd">        Contributions to defined-contribution pension plans for spouse</span>
<span class="sd">    FICA_ss_trt_employer: float</span>
<span class="sd">        Employer side social security payroll tax rate</span>
<span class="sd">    FICA_ss_trt_employee: float</span>
<span class="sd">        Employee side social security payroll tax rate</span>
<span class="sd">    FICA_mc_trt_employer: float</span>
<span class="sd">        Employer side medicare payroll tax rate</span>
<span class="sd">    FICA_mc_trt_employee: float</span>
<span class="sd">        Employee side medicare payroll tax rate</span>
<span class="sd">    ALD_SelfEmploymentTax_hc: float</span>
<span class="sd">        Adjustment for self-employment tax haircut</span>
<span class="sd">        If greater than zero, reduces the employer equivalent portion</span>
<span class="sd">          of self-employment adjustment</span>
<span class="sd">        Final adjustment amount = (1-Haircut)*SelfEmploymentTaxAdjustment</span>
<span class="sd">    SS_Earnings_thd: float</span>
<span class="sd">        Additional taxable earnings threshold for Social Security</span>
<span class="sd">        Individual earnings above this threshold are subjected to</span>
<span class="sd">        OASDI payroll tax, in addtion to earnings below the</span>
<span class="sd">        maximum taxable earnings threshold.</span>
<span class="sd">    SECA_Earnings_thd: float</span>
<span class="sd">        Threshold value for self-employment income below which there is</span>
<span class="sd">        no SECA tax liability</span>
<span class="sd">    e00900p: float</span>
<span class="sd">        Schedule C business net profit/loss for taxpayer</span>
<span class="sd">    e00900s: float</span>
<span class="sd">        Schedule C business net profit/loss for spouse</span>
<span class="sd">    e02100p: float</span>
<span class="sd">        Farm net income/loss for taxpayer</span>
<span class="sd">    e02100s: float</span>
<span class="sd">        Farm net income/loss for spouse</span>
<span class="sd">    k1bx14p: float</span>
<span class="sd">        Partner self-employment earnings/loss for taxpayer</span>
<span class="sd">        (included in e26270 total)</span>
<span class="sd">    k1bx14s: float</span>
<span class="sd">        Partner self-employment earnings/loss for spouse</span>
<span class="sd">        (included in e26270 total)</span>
<span class="sd">    payrolltax: float</span>
<span class="sd">        Total (employee and employer) payroll tax liability</span>
<span class="sd">        payrolltax = ptax_was</span>
<span class="sd">    ptax_was: float</span>
<span class="sd">        Employee and employer OASDI plus HI FICA tax</span>
<span class="sd">    setax: float</span>
<span class="sd">        Self-employment tax (included in othertaxes and iitax)</span>
<span class="sd">    c03260: float</span>
<span class="sd">        Deductible part of self-employment tax</span>
<span class="sd">        c03260 = (1 - ALD_SelfEmploymentTax_hc) * 0.5 * setax</span>
<span class="sd">    ptax_oasdi: float</span>
<span class="sd">        Employee and employer OASDI FICA tax plus self employment tax</span>
<span class="sd">        Excludes HI FICA so positive ptax_oasdi is less than ptax_was + setax</span>
<span class="sd">    sey: float</span>
<span class="sd">        Total self-employment income for filing unit</span>
<span class="sd">    earned: float</span>
<span class="sd">        Earned income for filing unit</span>
<span class="sd">    earned_p: float</span>
<span class="sd">        Earned income for taxpayer</span>
<span class="sd">    earned_s: float</span>
<span class="sd">        Earned income for spouse</span>
<span class="sd">    was_plus_sey_p: float</span>
<span class="sd">        Wage and salary income plus taxable self employment income for taxpayer</span>
<span class="sd">    was_plus_sey_s: float</span>
<span class="sd">        Wage and salary income plus taxable self employment income for spouse</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sey: float</span>
<span class="sd">        Total self-employment income for filing unit</span>
<span class="sd">    payrolltax: float</span>
<span class="sd">        Total (employee and employer) payroll tax liability</span>
<span class="sd">        payrolltax = ptax_was</span>
<span class="sd">    ptax_was: float</span>
<span class="sd">        Employee and employer OASDI plus HI FICA tax</span>
<span class="sd">    setax: float</span>
<span class="sd">        Self-employment tax (included in othertaxes and iitax)</span>
<span class="sd">    c03260: float</span>
<span class="sd">        Deductible part of self-employment tax</span>
<span class="sd">        c03260 = (1 - ALD_SelfEmploymentTax_hc) * 0.5 * setax</span>
<span class="sd">    ptax_oasdi: float</span>
<span class="sd">        Employee and employer OASDI FICA tax plus self employment tax</span>
<span class="sd">        Excludes HI FICA so positive ptax_oasdi is less than ptax_was + setax</span>
<span class="sd">    earned: float</span>
<span class="sd">        Earned income for filing unit</span>
<span class="sd">    earned_p: float</span>
<span class="sd">        Earned income for taxpayer</span>
<span class="sd">    earned_s: float</span>
<span class="sd">        Earned income for spouse</span>
<span class="sd">    was_plus_sey_p: float</span>
<span class="sd">        Wage and salary income plus taxable self employment income for taxpayer</span>
<span class="sd">    was_plus_sey_s: float</span>
<span class="sd">        Wage and salary income plus taxable self employment income for spouse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># compute sey and its individual components</span>
    <span class="n">sey_p</span> <span class="o">=</span> <span class="n">e00900p</span> <span class="o">+</span> <span class="n">e02100p</span> <span class="o">+</span> <span class="n">k1bx14p</span>
    <span class="n">sey_s</span> <span class="o">=</span> <span class="n">e00900s</span> <span class="o">+</span> <span class="n">e02100s</span> <span class="o">+</span> <span class="n">k1bx14s</span>
    <span class="n">sey</span> <span class="o">=</span> <span class="n">sey_p</span> <span class="o">+</span> <span class="n">sey_s</span>  <span class="c1"># total self-employment income for filing unit</span>

    <span class="c1"># compute gross wage and salary income (&#39;was&#39; denotes &#39;wage and salary&#39;)</span>
    <span class="n">gross_ws_p</span> <span class="o">=</span> <span class="n">e00200p</span> <span class="o">+</span> <span class="n">pencon_p</span>
    <span class="n">gross_ws_s</span> <span class="o">=</span> <span class="n">e00200s</span> <span class="o">+</span> <span class="n">pencon_s</span>

    <span class="c1"># compute taxable gross earnings for OASDI FICA</span>
    <span class="n">txearn_was_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">SS_Earnings_c</span><span class="p">,</span> <span class="n">gross_ws_p</span><span class="p">)</span>
    <span class="n">txearn_was_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">SS_Earnings_c</span><span class="p">,</span> <span class="n">gross_ws_s</span><span class="p">)</span>

    <span class="c1"># compute OASDI and HI payroll taxes on wage-and-salary income, FICA</span>
    <span class="n">ptax_ss_ws_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span><span class="p">)</span> <span class="o">*</span> <span class="n">txearn_was_p</span>
    <span class="n">ptax_ss_ws_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span><span class="p">)</span> <span class="o">*</span> <span class="n">txearn_was_s</span>
    <span class="n">ptax_mc_ws_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">FICA_mc_trt_employer</span> <span class="o">+</span> <span class="n">FICA_mc_trt_employee</span><span class="p">)</span> <span class="o">*</span> <span class="n">gross_ws_p</span>
    <span class="n">ptax_mc_ws_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">FICA_mc_trt_employer</span> <span class="o">+</span> <span class="n">FICA_mc_trt_employee</span><span class="p">)</span> <span class="o">*</span> <span class="n">gross_ws_s</span>
    <span class="n">ptax_was</span> <span class="o">=</span> <span class="n">ptax_ss_ws_p</span> <span class="o">+</span> <span class="n">ptax_ss_ws_s</span> <span class="o">+</span> <span class="n">ptax_mc_ws_p</span> <span class="o">+</span> <span class="n">ptax_mc_ws_s</span>

    <span class="c1"># compute taxable self-employment income for OASDI SECA</span>
    <span class="n">sey_frac</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span>
        <span class="p">(</span><span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span> <span class="o">+</span>
         <span class="n">FICA_mc_trt_employer</span> <span class="o">+</span> <span class="n">FICA_mc_trt_employee</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">txearn_sey_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_p</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">),</span> <span class="n">SS_Earnings_c</span> <span class="o">-</span> <span class="n">txearn_was_p</span><span class="p">)</span>
    <span class="n">txearn_sey_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_s</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">),</span> <span class="n">SS_Earnings_c</span> <span class="o">-</span> <span class="n">txearn_was_s</span><span class="p">)</span>

    <span class="c1"># compute self-employment tax on taxable self-employment income, SECA</span>
    <span class="n">setax_ss_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span><span class="p">)</span> <span class="o">*</span> <span class="n">txearn_sey_p</span>
    <span class="n">setax_ss_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span><span class="p">)</span> <span class="o">*</span> <span class="n">txearn_sey_s</span>
    <span class="n">setax_mc_p</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">FICA_mc_trt_employer</span> <span class="o">+</span> <span class="n">FICA_mc_trt_employee</span><span class="p">)</span> <span class="o">*</span>
        <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_p</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">setax_mc_s</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">FICA_mc_trt_employer</span> <span class="o">+</span> <span class="n">FICA_mc_trt_employee</span><span class="p">)</span> <span class="o">*</span>
        <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_s</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">setax_p</span> <span class="o">=</span> <span class="n">setax_ss_p</span> <span class="o">+</span> <span class="n">setax_mc_p</span>
    <span class="n">setax_s</span> <span class="o">=</span> <span class="n">setax_ss_s</span> <span class="o">+</span> <span class="n">setax_mc_s</span>
    <span class="n">setax</span> <span class="o">=</span> <span class="n">setax_p</span> <span class="o">+</span> <span class="n">setax_s</span>
    <span class="c1"># no setax if self-employment income is low</span>
    <span class="k">if</span> <span class="n">sey</span> <span class="o">*</span> <span class="n">sey_frac</span> <span class="o">&gt;</span> <span class="n">SECA_Earnings_thd</span><span class="p">:</span>
        <span class="n">setax</span> <span class="o">=</span> <span class="n">setax_p</span> <span class="o">+</span> <span class="n">setax_s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">setax</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># compute extra OASDI payroll taxes on the portion of the sum</span>
    <span class="c1"># of wage-and-salary income and taxable self employment income</span>
    <span class="c1"># that exceeds SS_Earnings_thd</span>
    <span class="n">sey_frac</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span><span class="p">)</span>
    <span class="n">was_plus_sey_p</span> <span class="o">=</span> <span class="n">gross_ws_p</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_p</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">)</span>
    <span class="n">was_plus_sey_s</span> <span class="o">=</span> <span class="n">gross_ws_s</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_s</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">)</span>
    <span class="n">extra_ss_income_p</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">was_plus_sey_p</span> <span class="o">-</span> <span class="n">SS_Earnings_thd</span><span class="p">)</span>
    <span class="n">extra_ss_income_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">was_plus_sey_s</span> <span class="o">-</span> <span class="n">SS_Earnings_thd</span><span class="p">)</span>
    <span class="n">extra_payrolltax</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">extra_ss_income_p</span> <span class="o">*</span> <span class="p">(</span><span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">extra_ss_income_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># compute part of total payroll taxes for filing unit</span>
    <span class="n">payrolltax</span> <span class="o">=</span> <span class="n">ptax_was</span> <span class="o">+</span> <span class="n">extra_payrolltax</span>

    <span class="c1"># compute OASDI part of payroll taxes</span>
    <span class="n">ptax_oasdi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptax_ss_ws_p</span> <span class="o">+</span> <span class="n">ptax_ss_ws_s</span> <span class="o">+</span>
                  <span class="n">setax_ss_p</span> <span class="o">+</span> <span class="n">setax_ss_s</span> <span class="o">+</span>
                  <span class="n">extra_payrolltax</span><span class="p">)</span>

    <span class="c1"># compute earned* variables and AGI deduction for</span>
    <span class="c1"># &quot;employer share&quot; of self-employment tax, c03260</span>
    <span class="c1"># Note: c03260 is the amount on 2015 Form 1040, line 27</span>
    <span class="n">c03260</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_SelfEmploymentTax_hc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">setax</span>
    <span class="n">earned</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00200p</span> <span class="o">+</span> <span class="n">e00200s</span> <span class="o">+</span> <span class="n">sey</span> <span class="o">-</span> <span class="n">c03260</span><span class="p">)</span>
    <span class="n">earned_p</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">e00200p</span> <span class="o">+</span> <span class="n">sey_p</span> <span class="o">-</span>
                        <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_SelfEmploymentTax_hc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">setax_p</span><span class="p">))</span>
    <span class="n">earned_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">e00200s</span> <span class="o">+</span> <span class="n">sey_s</span> <span class="o">-</span>
                        <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_SelfEmploymentTax_hc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">setax_s</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sey</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span> <span class="n">setax</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span> <span class="n">ptax_oasdi</span><span class="p">,</span>
            <span class="n">earned</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span> <span class="n">was_plus_sey_p</span><span class="p">,</span> <span class="n">was_plus_sey_s</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">DependentCare</span><span class="p">(</span><span class="n">nu13</span><span class="p">,</span> <span class="n">elderly_dependents</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span>
                  <span class="n">MARS</span><span class="p">,</span> <span class="n">ALD_Dependents_thd</span><span class="p">,</span> <span class="n">ALD_Dependents_hc</span><span class="p">,</span>
                  <span class="n">ALD_Dependents_Child_c</span><span class="p">,</span> <span class="n">ALD_Dependents_Elder_c</span><span class="p">,</span>
                  <span class="n">care_deduction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes dependent-care above-the-line deduction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nu13: int</span>
<span class="sd">        Number of dependents under 13 years old</span>
<span class="sd">    elderly_dependents: int</span>
<span class="sd">        Number of elderly dependents age 65+ in filing unit other than</span>
<span class="sd">        taxpayer and spouse</span>
<span class="sd">    earned: float</span>
<span class="sd">        Earned income for filing unit</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    ALD_Dependents_thd: list</span>
<span class="sd">        Maximum income to qualify for dependent care deduction</span>
<span class="sd">    ALD_Dependents_hc: float</span>
<span class="sd">        Deduction for childcare costs haircut</span>
<span class="sd">    ALD_Dependents_Child_c: float</span>
<span class="sd">        National weighted average cost of childcare, ceiling for</span>
<span class="sd">        available childcare deduction</span>
<span class="sd">    ALD_Dependents_Elder_c: float</span>
<span class="sd">        Eldercare deduction ceiling</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    care_deduction: float</span>
<span class="sd">        Total above the line deductions for dependent care.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">earned</span> <span class="o">&lt;=</span> <span class="n">ALD_Dependents_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">care_deduction</span> <span class="o">=</span> <span class="p">(((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_Dependents_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">nu13</span> <span class="o">*</span>
                           <span class="n">ALD_Dependents_Child_c</span><span class="p">)</span> <span class="o">+</span>
                          <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_Dependents_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">elderly_dependents</span> <span class="o">*</span>
                           <span class="n">ALD_Dependents_Elder_c</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">care_deduction</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">care_deduction</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">Adj</span><span class="p">(</span><span class="n">e03150</span><span class="p">,</span> <span class="n">e03210</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span>
        <span class="n">e03270</span><span class="p">,</span> <span class="n">e03300</span><span class="p">,</span> <span class="n">e03400</span><span class="p">,</span> <span class="n">e03500</span><span class="p">,</span> <span class="n">e00800</span><span class="p">,</span>
        <span class="n">e03220</span><span class="p">,</span> <span class="n">e03230</span><span class="p">,</span> <span class="n">e03240</span><span class="p">,</span> <span class="n">e03290</span><span class="p">,</span> <span class="n">care_deduction</span><span class="p">,</span>
        <span class="n">ALD_StudentLoan_hc</span><span class="p">,</span> <span class="n">ALD_SelfEmp_HealthIns_hc</span><span class="p">,</span> <span class="n">ALD_KEOGH_SEP_hc</span><span class="p">,</span>
        <span class="n">ALD_EarlyWithdraw_hc</span><span class="p">,</span> <span class="n">ALD_AlimonyPaid_hc</span><span class="p">,</span> <span class="n">ALD_AlimonyReceived_hc</span><span class="p">,</span>
        <span class="n">ALD_EducatorExpenses_hc</span><span class="p">,</span> <span class="n">ALD_HSADeduction_hc</span><span class="p">,</span> <span class="n">ALD_IRAContributions_hc</span><span class="p">,</span>
        <span class="n">ALD_DomesticProduction_hc</span><span class="p">,</span> <span class="n">ALD_Tuition_hc</span><span class="p">,</span>
        <span class="n">MARS</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span>
        <span class="n">overtime_income</span><span class="p">,</span> <span class="n">ALD_OvertimeIncome_hc</span><span class="p">,</span> <span class="n">ALD_OvertimeIncome_c</span><span class="p">,</span>
        <span class="n">ALD_OvertimeIncome_ps</span><span class="p">,</span> <span class="n">ALD_OvertimeIncome_prt</span><span class="p">,</span>
        <span class="n">tip_income</span><span class="p">,</span> <span class="n">ALD_TipIncome_hc</span><span class="p">,</span> <span class="n">ALD_TipIncome_c</span><span class="p">,</span>
        <span class="n">ALD_TipIncome_ps</span><span class="p">,</span> <span class="n">ALD_TipIncome_prt</span><span class="p">,</span>
        <span class="n">c02900</span><span class="p">,</span> <span class="n">ALD_OvertimeIncome</span><span class="p">,</span> <span class="n">ALD_TipIncome</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adj calculates Form 1040 AGI adjustments (i.e., Above-the-Line Deductions).</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----</span>
<span class="sd">    e03210: float</span>
<span class="sd">        Student loan interest paid</span>
<span class="sd">    e03220: float</span>
<span class="sd">        Educator expenses</span>
<span class="sd">    e03150: float</span>
<span class="sd">        Total deductible IRA plan contributions</span>
<span class="sd">    e03230: float</span>
<span class="sd">        Tuition and fees (Form 8917)</span>
<span class="sd">    e03240: float</span>
<span class="sd">        Domestic production activity deduction (Form 8903)</span>
<span class="sd">    c03260: float</span>
<span class="sd">        Self-employment tax deduction (after haircut)</span>
<span class="sd">    e03270: float</span>
<span class="sd">        Self-employed health insurance premiums</span>
<span class="sd">    e03290: float</span>
<span class="sd">        HSA deduction (Form 8889)</span>
<span class="sd">    e03300: float</span>
<span class="sd">        Total deductible KEOGH/SEP/SIMPLE/etc. plan contributions</span>
<span class="sd">    e03400: float</span>
<span class="sd">        Penalty on early withdrawal of savings deduction</span>
<span class="sd">    e03500: float</span>
<span class="sd">        Alimony paid</span>
<span class="sd">    e00800: float</span>
<span class="sd">        Alimony received</span>
<span class="sd">    care_deduction: float</span>
<span class="sd">        Dependent care expense deduction</span>
<span class="sd">    ALD_StudentLoan_hc: float</span>
<span class="sd">        Student loan interest deduction haircut</span>
<span class="sd">    ALD_SelfEmp_HealthIns_hc: float</span>
<span class="sd">        Self-employed h.i. deduction haircut</span>
<span class="sd">    ALD_KEOGH_SEP_hc: float</span>
<span class="sd">        KEOGH/etc. plan contribution deduction haircut</span>
<span class="sd">    ALD_EarlyWithdraw_hc: float</span>
<span class="sd">        Penalty on early withdrawal deduction haricut</span>
<span class="sd">    ALD_AlimonyPaid_hc: float</span>
<span class="sd">        Alimony paid deduction haircut</span>
<span class="sd">    ALD_AlimonyReceived_hc: float</span>
<span class="sd">        Alimony received deduction haircut</span>
<span class="sd">    ALD_EducatorExpenses_hc: float</span>
<span class="sd">        Eductor expenses haircut</span>
<span class="sd">    ALD_HSADeduction_hc: float</span>
<span class="sd">        HSA Deduction haircut</span>
<span class="sd">    ALD_IRAContributions_hc: float</span>
<span class="sd">        IRA Contribution haircut</span>
<span class="sd">    ALD_DomesticProduction_hc: float</span>
<span class="sd">        Domestic production haircut</span>
<span class="sd">    ALD_Tuition_hc: float</span>
<span class="sd">        Tuition and fees haircut</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    earned: float</span>
<span class="sd">        Earned income used to phase-out ALD_OvertimeIncome and ALD_TipIncome</span>
<span class="sd">    overtime_income: float</span>
<span class="sd">        Overtime income qualified for an above-the-line deduction</span>
<span class="sd">    ALD_OvertimeIncome_hc: float</span>
<span class="sd">        ALD_OvertimeIncome haircut</span>
<span class="sd">    ALD_OvertimeIncome_c: list[float]</span>
<span class="sd">        ALD_OvertimeIncome cap</span>
<span class="sd">    ALD_OvertimeIncome_ps: list[float]</span>
<span class="sd">        ALD_OvertimeIncome phase-out earned income start</span>
<span class="sd">    ALD_OvertimeIncome_prt: float</span>
<span class="sd">        ALD_OvertimeIncome phase-out rate</span>
<span class="sd">    tip_income: float</span>
<span class="sd">        Tip income qualified for an above-the-line deduction</span>
<span class="sd">    ALD_TipIncome_hc: float</span>
<span class="sd">        ALD_TipIncome haircut</span>
<span class="sd">    ALD_TipIncome_c: list[float]</span>
<span class="sd">        ALD_TipIncome cap</span>
<span class="sd">    ALD_TipIncome_ps: list[float]</span>
<span class="sd">        ALD_TipIncome phase-out earned income start</span>
<span class="sd">    ALD_TipIncome_prt: float</span>
<span class="sd">        ALD_TipIncome phase-out rate</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c02900: float</span>
<span class="sd">        Total of all &quot;above the line&quot; income adjustments to get AGI</span>
<span class="sd">    ALD_OvertimeIncome: float</span>
<span class="sd">        Overtime ALD amount included in c02900</span>
<span class="sd">    ALD_TipIncome: float</span>
<span class="sd">        Tip ALD amount included in c02900</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Form 2555 foreign earned income exclusion is assumed to be zero</span>
    <span class="c1"># Form 1040 adjustments that are included in expanded income:</span>
    <span class="n">c02900</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_StudentLoan_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03210</span> <span class="o">+</span>
              <span class="n">c03260</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_EarlyWithdraw_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03400</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_AlimonyPaid_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03500</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_AlimonyReceived_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e00800</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_EducatorExpenses_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03220</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_Tuition_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03230</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_DomesticProduction_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03240</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_HSADeduction_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03290</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_SelfEmp_HealthIns_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03270</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_IRAContributions_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03150</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_KEOGH_SEP_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03300</span> <span class="o">+</span>
              <span class="n">care_deduction</span><span class="p">)</span>
    <span class="c1"># calculate ALD_OvertimeIncome</span>
    <span class="n">ALD_OvertimeIncome</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">overtime_income</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">ALD_OvertimeIncome_hc</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">ded</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">overtime_income</span><span class="p">,</span> <span class="n">ALD_OvertimeIncome_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">po_start</span> <span class="o">=</span> <span class="n">ALD_OvertimeIncome_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">earned</span> <span class="o">&gt;</span> <span class="n">po_start</span><span class="p">:</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="n">earned</span> <span class="o">-</span> <span class="n">po_start</span>
            <span class="n">po_amount</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">*</span> <span class="n">ALD_OvertimeIncome_prt</span>
            <span class="n">ded</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ded</span> <span class="o">-</span> <span class="n">po_amount</span><span class="p">)</span>
        <span class="n">ALD_OvertimeIncome</span> <span class="o">=</span> <span class="n">ded</span>
    <span class="c1"># calculate ALD_TipIncome</span>
    <span class="n">ALD_TipIncome</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">tip_income</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">ALD_TipIncome_hc</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">ded</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tip_income</span><span class="p">,</span> <span class="n">ALD_TipIncome_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">po_start</span> <span class="o">=</span> <span class="n">ALD_TipIncome_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">earned</span> <span class="o">&gt;</span> <span class="n">po_start</span><span class="p">:</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="n">earned</span> <span class="o">-</span> <span class="n">po_start</span>
            <span class="n">po_amount</span> <span class="o">=</span> <span class="n">excess</span> <span class="o">*</span> <span class="n">ALD_TipIncome_prt</span>
            <span class="n">ded</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ded</span> <span class="o">-</span> <span class="n">po_amount</span><span class="p">)</span>
        <span class="n">ALD_TipIncome</span> <span class="o">=</span> <span class="n">ded</span>
    <span class="c1"># return results</span>
    <span class="n">c02900</span> <span class="o">+=</span> <span class="n">ALD_OvertimeIncome</span> <span class="o">+</span> <span class="n">ALD_TipIncome</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c02900</span><span class="p">,</span> <span class="n">ALD_OvertimeIncome</span><span class="p">,</span> <span class="n">ALD_TipIncome</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ALD_InvInc_ec_base</span><span class="p">(</span><span class="n">p22250</span><span class="p">,</span> <span class="n">p23250</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span>
                       <span class="n">e00300</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e01200</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
                       <span class="n">invinc_ec_base</span><span class="p">,</span> <span class="n">Capital_loss_limitation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes invinc_ec_base.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p22250: float</span>
<span class="sd">        Net short-term capital gails/losses (Schedule D)</span>
<span class="sd">    p23250: float</span>
<span class="sd">        Net long-term capital gains/losses (Schedule D)</span>
<span class="sd">    sep: int</span>
<span class="sd">        2 when MARS is 3 (married filing separately); otherwise 1</span>
<span class="sd">    e00300: float</span>
<span class="sd">        Taxable interest income</span>
<span class="sd">    e00600: float</span>
<span class="sd">        Ordinary dividends included in AGI</span>
<span class="sd">    e01100: float</span>
<span class="sd">        Capital gains distributions not reported on Schedule D</span>
<span class="sd">    e01200: float</span>
<span class="sd">        Other net gain/loss from Form 4797</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    invinc_ec_base: float</span>
<span class="sd">        Exclusion of investment income from AGI</span>
<span class="sd">    Capital_loss_limitation: float</span>
<span class="sd">        Limitation on capital losses that are deductible</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    invinc_ec_base: float</span>
<span class="sd">        Exclusion of investment income from AGI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># limitation on net short-term and long-term capital losses</span>
    <span class="n">cgain</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Capital_loss_limitation</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">sep</span><span class="p">),</span> <span class="n">p22250</span> <span class="o">+</span> <span class="n">p23250</span>
    <span class="p">)</span>
    <span class="c1"># compute exclusion of investment income from AGI</span>
    <span class="n">invinc_ec_base</span> <span class="o">=</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span> <span class="n">cgain</span> <span class="o">+</span> <span class="n">e01100</span> <span class="o">+</span> <span class="n">e01200</span>
    <span class="k">return</span> <span class="n">invinc_ec_base</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CapGains</span><span class="p">(</span><span class="n">p23250</span><span class="p">,</span> <span class="n">p22250</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">ALD_StudentLoan_hc</span><span class="p">,</span>
             <span class="n">ALD_InvInc_ec_rt</span><span class="p">,</span> <span class="n">invinc_ec_base</span><span class="p">,</span>
             <span class="n">e00200</span><span class="p">,</span> <span class="n">e00300</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span> <span class="n">e00650</span><span class="p">,</span> <span class="n">e00700</span><span class="p">,</span> <span class="n">e00800</span><span class="p">,</span>
             <span class="n">CG_nodiff</span><span class="p">,</span> <span class="n">CG_ec</span><span class="p">,</span> <span class="n">CG_reinvest_ec_rt</span><span class="p">,</span> <span class="n">Capital_loss_limitation</span><span class="p">,</span>
             <span class="n">ALD_BusinessLosses_c</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
             <span class="n">e00900</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e01200</span><span class="p">,</span> <span class="n">e01400</span><span class="p">,</span> <span class="n">e01700</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span> <span class="n">e02100</span><span class="p">,</span>
             <span class="n">e02300</span><span class="p">,</span> <span class="n">e00400</span><span class="p">,</span> <span class="n">e02400</span><span class="p">,</span> <span class="n">c02900</span><span class="p">,</span> <span class="n">e03210</span><span class="p">,</span> <span class="n">e03230</span><span class="p">,</span> <span class="n">e03240</span><span class="p">,</span>
             <span class="n">c01000</span><span class="p">,</span> <span class="n">c23650</span><span class="p">,</span> <span class="n">ymod</span><span class="p">,</span> <span class="n">ymod1</span><span class="p">,</span> <span class="n">invinc_agi_ec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CapGains function: ...</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p23250: float</span>
<span class="sd">        Net long-term capital gains/losses (Schedule D)</span>
<span class="sd">    p22250: float</span>
<span class="sd">        Net short-term capital gails/losses (Schedule D)</span>
<span class="sd">    sep: int</span>
<span class="sd">        2 when MARS is 3 (married filing separately); otherwise 1</span>
<span class="sd">    ALD_StudentLoan_hc: float</span>
<span class="sd">        Student loan interest deduction haircut</span>
<span class="sd">    ALD_InvInc_ec_rt: float</span>
<span class="sd">        Investment income exclusion rate haircut</span>
<span class="sd">    invinc_ec_base: float</span>
<span class="sd">        Exclusion of investment income from AGI</span>
<span class="sd">    e00200: float</span>
<span class="sd">        Wages, salaries, tips for filing unit net of pension contributions</span>
<span class="sd">    e00300: float</span>
<span class="sd">        Taxable interest income</span>
<span class="sd">    e00600: float</span>
<span class="sd">        Ordinary dividends included in AGI</span>
<span class="sd">    e00650: float</span>
<span class="sd">        Qualified dividends included in ordinary dividends</span>
<span class="sd">    e00700: float</span>
<span class="sd">        Taxable refunds of state and local income taxes</span>
<span class="sd">    e00800: float</span>
<span class="sd">        Alimony received</span>
<span class="sd">    CG_nodiff: bool</span>
<span class="sd">        Long term capital gains and qualified dividends taxed no</span>
<span class="sd">        differently than regular taxable income</span>
<span class="sd">    CG_ec: float</span>
<span class="sd">        Dollar amount of all capital gains and qualified dividends that are</span>
<span class="sd">        excluded from AGI</span>
<span class="sd">    CG_reinvest_ec_rt: float</span>
<span class="sd">        Fraction of all capital gains and qualified dividends in excess</span>
<span class="sd">        of the dollar exclusion that are excluded from AGI</span>
<span class="sd">    Capital_loss_limitation: float</span>
<span class="sd">        Limitation on capital losses that are deductible</span>
<span class="sd">    ALD_BusinessLosses_c: list</span>
<span class="sd">        Maximm amount of business losses deductible</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    e00900: float</span>
<span class="sd">        Schedule C business net profit/loss for filing unit</span>
<span class="sd">    e01100: float</span>
<span class="sd">        Capital gain distributions not reported on Schedule D</span>
<span class="sd">    e01200: float</span>
<span class="sd">        Other net gain/loss from Form 4797</span>
<span class="sd">    e01400: float</span>
<span class="sd">        Taxable IRA distributions</span>
<span class="sd">    e01700: float</span>
<span class="sd">        Taxable pensions and annunities</span>
<span class="sd">    e02000: float</span>
<span class="sd">        Schedule E total rental, royalty, partnership, S-corporation,</span>
<span class="sd">        etc, income/loss (includes e26270 and e27200)</span>
<span class="sd">    e02100: float</span>
<span class="sd">        Farm net income/loss for filing unit from Schedule F</span>
<span class="sd">    e02300: float</span>
<span class="sd">        Unemployment insurance benefits</span>
<span class="sd">    e00400: float</span>
<span class="sd">        Tax-exempt interest income</span>
<span class="sd">    e02400: float</span>
<span class="sd">        Total social security (OASDI) benefits</span>
<span class="sd">    c02900: float</span>
<span class="sd">        Total of all &quot;above the line&quot; income adjustments to get AGI</span>
<span class="sd">    e03210: float</span>
<span class="sd">        Student loan interest</span>
<span class="sd">    e03230: float</span>
<span class="sd">        Tuition and fees from Form 8917</span>
<span class="sd">    e03240: float</span>
<span class="sd">        Domestic production activities from Form 8903</span>
<span class="sd">    c01000: float</span>
<span class="sd">        Limitation on capital losses</span>
<span class="sd">    c23650: float</span>
<span class="sd">        Net capital gains (long and short term) before exclusion</span>
<span class="sd">    ymod: float</span>
<span class="sd">        Variable that is used in OASDI benefit taxation logic</span>
<span class="sd">    ymod1: float</span>
<span class="sd">        Variable that is included in AGI</span>
<span class="sd">    invinc_agi_ec: float</span>
<span class="sd">        Exclusion of investment income from AGI</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c01000: float</span>
<span class="sd">        Limitation on capital losses</span>
<span class="sd">    c23650: float</span>
<span class="sd">        Net capital gains (long and short term) before exclusion</span>
<span class="sd">    ymod: float</span>
<span class="sd">        Variable that is used in OASDI benefit taxation logic</span>
<span class="sd">    ymod1: float</span>
<span class="sd">        Variable that is included in AGI</span>
<span class="sd">    invinc_agi_ec: float</span>
<span class="sd">        Exclusion of investment income from AGI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># net capital gain (long term + short term) before exclusion</span>
    <span class="n">c23650</span> <span class="o">=</span> <span class="n">p23250</span> <span class="o">+</span> <span class="n">p22250</span>
    <span class="c1"># limitation on capital losses</span>
    <span class="n">c01000</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">Capital_loss_limitation</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">sep</span><span class="p">),</span> <span class="n">c23650</span><span class="p">)</span>
    <span class="c1"># compute total investment income</span>
    <span class="n">invinc</span> <span class="o">=</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span> <span class="n">c01000</span> <span class="o">+</span> <span class="n">e01100</span> <span class="o">+</span> <span class="n">e01200</span>
    <span class="c1"># compute exclusion of investment income from AGI</span>
    <span class="n">invinc_agi_ec</span> <span class="o">=</span> <span class="n">ALD_InvInc_ec_rt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">invinc_ec_base</span><span class="p">)</span>
    <span class="c1"># compute ymod1 variable that is included in AGI</span>
    <span class="n">ymod1</span> <span class="o">=</span> <span class="p">(</span><span class="n">e00200</span> <span class="o">+</span> <span class="n">e00700</span> <span class="o">+</span> <span class="n">e00800</span> <span class="o">+</span> <span class="n">e01400</span> <span class="o">+</span> <span class="n">e01700</span> <span class="o">+</span>
             <span class="n">invinc</span> <span class="o">-</span> <span class="n">invinc_agi_ec</span> <span class="o">+</span> <span class="n">e02100</span> <span class="o">+</span> <span class="n">e02300</span> <span class="o">+</span>
             <span class="nb">max</span><span class="p">(</span><span class="n">e00900</span> <span class="o">+</span> <span class="n">e02000</span><span class="p">,</span> <span class="o">-</span><span class="n">ALD_BusinessLosses_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">CG_nodiff</span><span class="p">:</span>
        <span class="c1"># apply QDIV+CG exclusion if QDIV+LTCG receive no special tax treatment</span>
        <span class="n">qdcg_pos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00650</span> <span class="o">+</span> <span class="n">c01000</span><span class="p">)</span>
        <span class="n">qdcg_exclusion</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">CG_ec</span><span class="p">,</span> <span class="n">qdcg_pos</span><span class="p">)</span> <span class="o">+</span>
                          <span class="n">CG_reinvest_ec_rt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">qdcg_pos</span> <span class="o">-</span> <span class="n">CG_ec</span><span class="p">))</span>
        <span class="n">ymod1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ymod1</span> <span class="o">-</span> <span class="n">qdcg_exclusion</span><span class="p">)</span>
        <span class="n">invinc_agi_ec</span> <span class="o">+=</span> <span class="n">qdcg_exclusion</span>
    <span class="c1"># compute ymod variable that is used in OASDI benefit taxation logic</span>
    <span class="n">ymod2</span> <span class="o">=</span> <span class="n">e00400</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.50</span> <span class="o">*</span> <span class="n">e02400</span><span class="p">)</span> <span class="o">-</span> <span class="n">c02900</span>
    <span class="n">ymod3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_StudentLoan_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03210</span> <span class="o">+</span> <span class="n">e03230</span> <span class="o">+</span> <span class="n">e03240</span>
    <span class="n">ymod</span> <span class="o">=</span> <span class="n">ymod1</span> <span class="o">+</span> <span class="n">ymod2</span> <span class="o">+</span> <span class="n">ymod3</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c01000</span><span class="p">,</span> <span class="n">c23650</span><span class="p">,</span> <span class="n">ymod</span><span class="p">,</span> <span class="n">ymod1</span><span class="p">,</span> <span class="n">invinc_agi_ec</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">SSBenefits</span><span class="p">(</span><span class="n">MARS</span><span class="p">,</span> <span class="n">ymod</span><span class="p">,</span> <span class="n">e02400</span><span class="p">,</span> <span class="n">SS_all_in_agi</span><span class="p">,</span> <span class="n">SS_thd1</span><span class="p">,</span> <span class="n">SS_thd2</span><span class="p">,</span>
               <span class="n">SS_percentage1</span><span class="p">,</span> <span class="n">SS_percentage2</span><span class="p">,</span> <span class="n">c02500</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates OASDI benefits included in AGI, c02500.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    ymod: float</span>
<span class="sd">        Variable that is used in OASDI benefit taxation logic</span>
<span class="sd">    e02400: float</span>
<span class="sd">        Total social security (OASDI) benefits</span>
<span class="sd">    SS_all_in_agi: bool</span>
<span class="sd">        Whether all social security benefits are included in AGI</span>
<span class="sd">    SS_thd1: list</span>
<span class="sd">        Threshold for social security benefit taxability (1)</span>
<span class="sd">    SS_thd2: list</span>
<span class="sd">        Threshold for social security benefit taxability (2)</span>
<span class="sd">    SS_percentage1: float</span>
<span class="sd">        Social security taxable income decimal fraction (1)</span>
<span class="sd">    SS_percentage2: float</span>
<span class="sd">        Social security taxable income decimal fraction (2)</span>
<span class="sd">    c02500: float</span>
<span class="sd">        Social security (OASDI) benefits included in AGI</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c02500: float</span>
<span class="sd">        Social security (OASDI) benefits included in AGI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ymod</span> <span class="o">&lt;</span> <span class="n">SS_thd1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">c02500</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">ymod</span> <span class="o">&lt;</span> <span class="n">SS_thd2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">c02500</span> <span class="o">=</span> <span class="n">SS_percentage1</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymod</span> <span class="o">-</span> <span class="n">SS_thd1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">e02400</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c02500</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">SS_percentage2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymod</span> <span class="o">-</span> <span class="n">SS_thd2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                     <span class="n">SS_percentage1</span> <span class="o">*</span>
                     <span class="nb">min</span><span class="p">(</span><span class="n">e02400</span><span class="p">,</span> <span class="n">SS_thd2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                         <span class="n">SS_thd1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">SS_percentage2</span> <span class="o">*</span> <span class="n">e02400</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">SS_all_in_agi</span><span class="p">:</span>
        <span class="n">c02500</span> <span class="o">=</span> <span class="n">e02400</span>
    <span class="k">return</span> <span class="n">c02500</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">UBI</span><span class="p">(</span><span class="n">nu18</span><span class="p">,</span> <span class="n">n1820</span><span class="p">,</span> <span class="n">n21</span><span class="p">,</span> <span class="n">UBI_u18</span><span class="p">,</span> <span class="n">UBI_1820</span><span class="p">,</span> <span class="n">UBI_21</span><span class="p">,</span> <span class="n">UBI_ecrt</span><span class="p">,</span>
        <span class="n">ubi</span><span class="p">,</span> <span class="n">taxable_ubi</span><span class="p">,</span> <span class="n">nontaxable_ubi</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates total and taxable Universal Basic Income (UBI) amount.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nu18: int</span>
<span class="sd">        Number of people in the tax unit under 18</span>
<span class="sd">    n1820: int</span>
<span class="sd">        Number of people in the tax unit age 18-20</span>
<span class="sd">    n21: int</span>
<span class="sd">        Number of people in the tax unit age 21+</span>
<span class="sd">    UBI_u18: float</span>
<span class="sd">        UBI benefit for those under 18</span>
<span class="sd">    UBI_1820: float</span>
<span class="sd">        UBI benefit for those between 18 to 20</span>
<span class="sd">    UBI_21: float</span>
<span class="sd">        UBI benefit for those 21 or more</span>
<span class="sd">    UBI_ecrt: float</span>
<span class="sd">        Fraction of UBI benefits that are not included in AGI</span>
<span class="sd">    ubi: float</span>
<span class="sd">        Total UBI received by the tax unit (is included in expanded_income)</span>
<span class="sd">    taxable_ubi: float</span>
<span class="sd">        Amount of UBI that is taxable (is added to AGI)</span>
<span class="sd">    nontaxable_ubi: float</span>
<span class="sd">        Amount of UBI that is nontaxable</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ubi: float</span>
<span class="sd">        Total UBI received by the tax unit (is included in expanded_income)</span>
<span class="sd">    taxable_ubi: float</span>
<span class="sd">        Amount of UBI that is taxable (is added to AGI)</span>
<span class="sd">    nontaxable_ubi: float</span>
<span class="sd">        Amount of UBI that is nontaxable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ubi</span> <span class="o">=</span> <span class="n">nu18</span> <span class="o">*</span> <span class="n">UBI_u18</span> <span class="o">+</span> <span class="n">n1820</span> <span class="o">*</span> <span class="n">UBI_1820</span> <span class="o">+</span> <span class="n">n21</span> <span class="o">*</span> <span class="n">UBI_21</span>
    <span class="n">taxable_ubi</span> <span class="o">=</span> <span class="n">ubi</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">UBI_ecrt</span><span class="p">)</span>
    <span class="n">nontaxable_ubi</span> <span class="o">=</span> <span class="n">ubi</span> <span class="o">-</span> <span class="n">taxable_ubi</span>
    <span class="k">return</span> <span class="n">ubi</span><span class="p">,</span> <span class="n">taxable_ubi</span><span class="p">,</span> <span class="n">nontaxable_ubi</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">AGI</span><span class="p">(</span><span class="n">ymod1</span><span class="p">,</span> <span class="n">c02500</span><span class="p">,</span> <span class="n">c02900</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">DSI</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">nu18</span><span class="p">,</span> <span class="n">taxable_ubi</span><span class="p">,</span>
        <span class="n">II_em</span><span class="p">,</span> <span class="n">II_em_ps</span><span class="p">,</span> <span class="n">II_em_prt</span><span class="p">,</span> <span class="n">II_no_em_nu18</span><span class="p">,</span>
        <span class="n">e02300</span><span class="p">,</span> <span class="n">UI_thd</span><span class="p">,</span> <span class="n">UI_em</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">pre_c04600</span><span class="p">,</span> <span class="n">c04600</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Adjusted Gross Income (AGI), c00100, and</span>
<span class="sd">    compute personal exemption amount, c04600.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ymod1: float</span>
<span class="sd">        Variable that is included in AGI</span>
<span class="sd">    c02500: float</span>
<span class="sd">        Social security (OASDI) benefits included in AGI</span>
<span class="sd">    c02900: float</span>
<span class="sd">        Total of all &quot;above the line&quot; income adjustments to get AGI</span>
<span class="sd">    XTOT: int</span>
<span class="sd">        Total number of exemptions for filing unit</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    sep: int</span>
<span class="sd">        2 when MARS is 3 (married filing separately); otherwise 1</span>
<span class="sd">    DSI: int</span>
<span class="sd">        1 if claimed as dependent on another return; otherwise 0</span>
<span class="sd">    exact: int</span>
<span class="sd">        Whether or not to do rounding of phaseout fraction</span>
<span class="sd">    nu18: int</span>
<span class="sd">        Number of people in the tax unit under 18</span>
<span class="sd">    taxable_ubi: float</span>
<span class="sd">        Amount of UBI that is taxable (is added to AGI)</span>
<span class="sd">    II_em: float</span>
<span class="sd">        Personal and dependent exemption amount</span>
<span class="sd">    II_em_ps: list</span>
<span class="sd">        Personal exemption phaseout starting income</span>
<span class="sd">    II_em_prt: float</span>
<span class="sd">        Personal exemption phaseout rate</span>
<span class="sd">    II_no_em_nu18: float</span>
<span class="sd">        Repeal personal exemptions for dependents under age 18</span>
<span class="sd">    e02300: float</span>
<span class="sd">        Unemployment compensation</span>
<span class="sd">    UI_thd: list</span>
<span class="sd">        AGI threshold for unemployment compensation exclusion</span>
<span class="sd">    UI_em: float</span>
<span class="sd">        Amount of unemployment compensation excluded from AGI</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    pre_c04600: float</span>
<span class="sd">        Personal exemption before phase-out</span>
<span class="sd">    c04600: float</span>
<span class="sd">        Personal exemptions after phase-out</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    pre_c04600: float</span>
<span class="sd">        Personal exemption before phase-out</span>
<span class="sd">    c04600: float</span>
<span class="sd">        Personal exemptions after phase-out</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate AGI assuming no foreign earned income exclusion</span>
    <span class="n">c00100</span> <span class="o">=</span> <span class="n">ymod1</span> <span class="o">+</span> <span class="n">c02500</span> <span class="o">-</span> <span class="n">c02900</span> <span class="o">+</span> <span class="n">taxable_ubi</span>
    <span class="c1"># calculate UI exclusion (e.g., from 2020 AGI due to ARPA)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">e02300</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">UI_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">ui_excluded</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e02300</span><span class="p">,</span> <span class="n">UI_em</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ui_excluded</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">c00100</span> <span class="o">-=</span> <span class="n">ui_excluded</span>
    <span class="c1"># calculate personal exemption amount</span>
    <span class="k">if</span> <span class="n">II_no_em_nu18</span><span class="p">:</span>  <span class="c1"># repeal of personal exemptions for deps. under 18</span>
        <span class="n">pre_c04600</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">XTOT</span> <span class="o">-</span> <span class="n">nu18</span><span class="p">)</span> <span class="o">*</span> <span class="n">II_em</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pre_c04600</span> <span class="o">=</span> <span class="n">XTOT</span> <span class="o">*</span> <span class="n">II_em</span>
    <span class="k">if</span> <span class="n">DSI</span><span class="p">:</span>
        <span class="n">pre_c04600</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># phase-out personal exemption amount</span>
    <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
        <span class="n">line5</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">II_em_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">line6</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">line5</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2500.</span> <span class="o">/</span> <span class="n">sep</span><span class="p">))</span>
        <span class="n">line7</span> <span class="o">=</span> <span class="n">II_em_prt</span> <span class="o">*</span> <span class="n">line6</span>
        <span class="n">c04600</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pre_c04600</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">line7</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># smoothed calculation needed for sensible mtr calculation</span>
        <span class="n">dispc_numer</span> <span class="o">=</span> <span class="n">II_em_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">II_em_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">dispc_denom</span> <span class="o">=</span> <span class="mf">2500.</span> <span class="o">/</span> <span class="n">sep</span>
        <span class="n">dispc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dispc_numer</span> <span class="o">/</span> <span class="n">dispc_denom</span><span class="p">))</span>
        <span class="n">c04600</span> <span class="o">=</span> <span class="n">pre_c04600</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">dispc</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="n">pre_c04600</span><span class="p">,</span> <span class="n">c04600</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">MiscDed</span><span class="p">(</span><span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span>
            <span class="n">SeniorDed_c</span><span class="p">,</span> <span class="n">SeniorDed_ps</span><span class="p">,</span> <span class="n">SeniorDed_prt</span><span class="p">,</span>
            <span class="n">auto_loan_interest</span><span class="p">,</span>
            <span class="n">AutoLoanInterestDed_c</span><span class="p">,</span>
            <span class="n">AutoLoanInterestDed_ps</span><span class="p">,</span>
            <span class="n">AutoLoanInterestDed_po_step_size</span><span class="p">,</span>
            <span class="n">AutoLoanInterestDed_po_rate_per_step</span><span class="p">,</span>
            <span class="n">senior_deduction</span><span class="p">,</span> <span class="n">auto_loan_interest_deduction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates below-the-line deduction for elderly head/spouse and</span>
<span class="sd">    deduction on qualified auto loan interest paid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    age_head: int</span>
<span class="sd">        Age of tax unit head</span>
<span class="sd">    age_head: int</span>
<span class="sd">        Age of tax unit spouse</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted gross income</span>
<span class="sd">    exact: int</span>
<span class="sd">        Whether or not to smooth deduction phase out</span>
<span class="sd">    SeniorDed_c: float</span>
<span class="sd">        Maximum amount of senior deduction per head/spouse aged 65+</span>
<span class="sd">    SeniorDed_ps: list[float]</span>
<span class="sd">        Senior deduction AGI phase-out start level</span>
<span class="sd">    SeniorDed_prt: float</span>
<span class="sd">        Senior deduction phase-out rate</span>
<span class="sd">    auto_loan_interest: float</span>
<span class="sd">        Qualified auto loan interest paid</span>
<span class="sd">    AutoLoanInterestDed_c: float</span>
<span class="sd">        Deduction cap</span>
<span class="sd">    AutoLoanInterestDed_ps: float</span>
<span class="sd">        Deduction phase-out starts above this AGI</span>
<span class="sd">    AutoLoanInterestDed_po_step_size: float</span>
<span class="sd">        Deduction phase-out AGI step size</span>
<span class="sd">    AutoLoanInterestDed_po_rate_per_step: float</span>
<span class="sd">        Deduction phase-out rate per AGI step</span>
<span class="sd">    auto_loan_interest_deduction: float</span>
<span class="sd">        Deduction available to both itemizers and nonitemizers</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    senior_deduction: float</span>
<span class="sd">        Deduction available to both itemizers and nonitemizers</span>
<span class="sd">    auto_loan_interest_deduction: float</span>
<span class="sd">        Deduction available to both itemizers and nonitemizers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate senior deduction</span>
    <span class="n">senior_deduction</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">SeniorDed_c</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">seniors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
            <span class="n">seniors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
            <span class="n">seniors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">seniors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ded</span> <span class="o">=</span> <span class="n">seniors</span> <span class="o">*</span> <span class="n">SeniorDed_c</span>
            <span class="n">po_start</span> <span class="o">=</span> <span class="n">SeniorDed_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">po_start</span><span class="p">:</span>
                <span class="n">excess_agi</span> <span class="o">=</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">po_start</span>
                <span class="n">po_amount</span> <span class="o">=</span> <span class="n">excess_agi</span> <span class="o">*</span> <span class="n">SeniorDed_prt</span>
                <span class="n">ded</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ded</span> <span class="o">-</span> <span class="n">po_amount</span><span class="p">)</span>
            <span class="n">senior_deduction</span> <span class="o">=</span> <span class="n">ded</span>
    <span class="c1"># calculate auto loan interest deduction</span>
    <span class="n">auto_loan_interest_deduction</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">AutoLoanInterestDed_c</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">auto_loan_interest</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="c1"># cap deduction</span>
        <span class="n">ded</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">auto_loan_interest</span><span class="p">,</span> <span class="n">AutoLoanInterestDed_c</span><span class="p">)</span>
        <span class="n">po_start</span> <span class="o">=</span> <span class="n">AutoLoanInterestDed_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">po_start</span><span class="p">:</span>
            <span class="c1"># phase out deduction</span>
            <span class="n">excess_agi</span> <span class="o">=</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">po_start</span>
            <span class="n">po_rate</span> <span class="o">=</span> <span class="n">AutoLoanInterestDed_po_rate_per_step</span>
            <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
                <span class="n">step_size</span> <span class="o">=</span> <span class="n">AutoLoanInterestDed_po_step_size</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">excess_agi</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
                <span class="n">po_amount</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">*</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">po_rate</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># smoothed calculation needed for sensible mtr calculation</span>
                <span class="n">po_amount</span> <span class="o">=</span> <span class="n">excess_agi</span> <span class="o">*</span> <span class="n">po_rate</span>
            <span class="n">ded</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ded</span> <span class="o">-</span> <span class="n">po_amount</span><span class="p">)</span>
        <span class="n">auto_loan_interest_deduction</span> <span class="o">=</span> <span class="n">ded</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">senior_deduction</span><span class="p">,</span> <span class="n">auto_loan_interest_deduction</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ItemDed</span><span class="p">(</span><span class="n">e17500</span><span class="p">,</span> <span class="n">e18400</span><span class="p">,</span> <span class="n">e18500</span><span class="p">,</span> <span class="n">e19200</span><span class="p">,</span>
            <span class="n">e19800</span><span class="p">,</span> <span class="n">e20100</span><span class="p">,</span> <span class="n">e20400</span><span class="p">,</span> <span class="n">g20500</span><span class="p">,</span>
            <span class="n">MARS</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">c04600</span><span class="p">,</span> <span class="n">c04470</span><span class="p">,</span> <span class="n">c21040</span><span class="p">,</span> <span class="n">c21060</span><span class="p">,</span>
            <span class="n">c17000</span><span class="p">,</span> <span class="n">c18300</span><span class="p">,</span> <span class="n">c19200</span><span class="p">,</span> <span class="n">c19700</span><span class="p">,</span> <span class="n">c20500</span><span class="p">,</span> <span class="n">c20800</span><span class="p">,</span> <span class="n">II_brk6</span><span class="p">,</span>
            <span class="n">ID_ps</span><span class="p">,</span> <span class="n">ID_Medical_frt</span><span class="p">,</span> <span class="n">ID_Medical_frt_add4aged</span><span class="p">,</span> <span class="n">ID_Medical_hc</span><span class="p">,</span>
            <span class="n">ID_Casualty_frt</span><span class="p">,</span> <span class="n">ID_Casualty_hc</span><span class="p">,</span> <span class="n">ID_Miscellaneous_frt</span><span class="p">,</span>
            <span class="n">ID_Miscellaneous_hc</span><span class="p">,</span> <span class="n">ID_Charity_crt_all</span><span class="p">,</span> <span class="n">ID_Charity_crt_noncash</span><span class="p">,</span>
            <span class="n">ID_prt</span><span class="p">,</span> <span class="n">ID_crt</span><span class="p">,</span> <span class="n">ID_c</span><span class="p">,</span> <span class="n">ID_StateLocalTax_hc</span><span class="p">,</span> <span class="n">ID_Charity_frt</span><span class="p">,</span>
            <span class="n">ID_Charity_hc</span><span class="p">,</span> <span class="n">ID_InterestPaid_hc</span><span class="p">,</span> <span class="n">ID_RealEstate_hc</span><span class="p">,</span>
            <span class="n">ID_Medical_c</span><span class="p">,</span> <span class="n">ID_StateLocalTax_c</span><span class="p">,</span> <span class="n">ID_RealEstate_c</span><span class="p">,</span>
            <span class="n">ID_InterestPaid_c</span><span class="p">,</span> <span class="n">ID_Charity_c</span><span class="p">,</span> <span class="n">ID_Casualty_c</span><span class="p">,</span>
            <span class="n">ID_Miscellaneous_c</span><span class="p">,</span> <span class="n">ID_AllTaxes_c</span><span class="p">,</span> <span class="n">ID_AllTaxes_hc</span><span class="p">,</span>
            <span class="n">ID_AllTaxes_c_ps</span><span class="p">,</span> <span class="n">ID_AllTaxes_c_po_rate</span><span class="p">,</span> <span class="n">ID_AllTaxes_c_po_floor</span><span class="p">,</span>
            <span class="n">ID_StateLocalTax_crt</span><span class="p">,</span> <span class="n">ID_RealEstate_crt</span><span class="p">,</span> <span class="n">ID_Charity_f</span><span class="p">,</span>
            <span class="n">ID_reduction_rate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates itemized deductions, Form 1040, Schedule A.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    e17500: float</span>
<span class="sd">        Schedule A: medical expenses</span>
<span class="sd">    e18400: float</span>
<span class="sd">        Schedule A: state and local income taxes deductlbe</span>
<span class="sd">    e18500: float</span>
<span class="sd">        Schedule A: state and local real estate taxes deductible</span>
<span class="sd">    e19200: float</span>
<span class="sd">        Schedule A: interest deduction deductible</span>
<span class="sd">    e19800: float</span>
<span class="sd">        Schedule A: charity cash contributions deductible</span>
<span class="sd">    e20100: float</span>
<span class="sd">        Schedule A: charity noncash contributions deductible</span>
<span class="sd">    e20400: float</span>
<span class="sd">        Schedule A: gross miscellaneous deductions deductible</span>
<span class="sd">    g20500: float</span>
<span class="sd">        Schedule A: gross casualty or theft loss deductible</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    age_head: int</span>
<span class="sd">        Age in years of taxpayer</span>
<span class="sd">    age_spouse: int</span>
<span class="sd">        Age in years of spouse</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted gross income (AGI)</span>
<span class="sd">    c04600: float</span>
<span class="sd">        Personal exemptions after phase out</span>
<span class="sd">    c04470: float</span>
<span class="sd">        Itemized deductions after all limitations (0 for non-itemizers)</span>
<span class="sd">    c21040: float</span>
<span class="sd">        Itemized deductions that are limited under the Pease limitations</span>
<span class="sd">    c21060: float</span>
<span class="sd">        Itemized deductions before limitation (0 for non-itemizers)</span>
<span class="sd">    c17000: float</span>
<span class="sd">        Schedule A: medical expenses deducted</span>
<span class="sd">    c18300: float</span>
<span class="sd">        Schedule A: state and local taxes plus real estate taxes deducted</span>
<span class="sd">    c19200: float</span>
<span class="sd">        Schedule A: interest deducted</span>
<span class="sd">    c19700: float</span>
<span class="sd">        Schedule A: charity contributions deducted</span>
<span class="sd">    c20500: float</span>
<span class="sd">        Schedule A: net casualty or theft loss deducted</span>
<span class="sd">    c20800: float</span>
<span class="sd">        Schedule A: net limited miscellaneous deductions deducted</span>
<span class="sd">    II_brk6: list</span>
<span class="sd">        Bottom of top income tax rate bracket</span>
<span class="sd">    ID_ps: list</span>
<span class="sd">        Itemized deduction phaseout AGI start (Pease)</span>
<span class="sd">    ID_Medical_frt: float</span>
<span class="sd">        Floor (as decimal fraction of AGI) for deductible medical expenses</span>
<span class="sd">    ID_Medical_frt_add4aged: float</span>
<span class="sd">        Add on floor (as decimal fraction of AGI) for deductible</span>
<span class="sd">        medical expenses for elderly filing units</span>
<span class="sd">    ID_Medical_hc: float</span>
<span class="sd">        Medical expense deduction haircut</span>
<span class="sd">    ID_Casualty_frt: float</span>
<span class="sd">        Floor (as decimal fraction of AGI) for deductible casualty loss</span>
<span class="sd">    ID_Casualty_hc: float</span>
<span class="sd">        Casualty expense deduction haircut</span>
<span class="sd">    ID_Miscellaneous_frt: float</span>
<span class="sd">        Floor (as decimal fraction of AGI) for deductible</span>
<span class="sd">        miscellaneous expenses</span>
<span class="sd">    ID_Miscellaneous_hc: float</span>
<span class="sd">        Miscellaneous expense deduction haircut</span>
<span class="sd">    ID_Charity_crt_all: float</span>
<span class="sd">        Ceiling (as decimal fraction of AGI) for all charitable</span>
<span class="sd">        contribution deductions</span>
<span class="sd">    ID_Charity_crt_noncash: float</span>
<span class="sd">        Ceiling (as decimal fraction of AGI) for noncash charitable</span>
<span class="sd">        contribution deductions</span>
<span class="sd">    ID_prt: float</span>
<span class="sd">        Itemized deduction phaseout rate (Pease)</span>
<span class="sd">    ID_crt: float</span>
<span class="sd">        Itemized deduction maximum phaseout as a decimal fraction of total</span>
<span class="sd">        itemized deductions (Pease)</span>
<span class="sd">    ID_c: list</span>
<span class="sd">        Ceiling on the amount of itemized deductions allowed (dollars)</span>
<span class="sd">    ID_StateLocalTax_hc: float</span>
<span class="sd">        State and local income and sales taxes deduction haircut</span>
<span class="sd">    ID_Charity_frt: float</span>
<span class="sd">        Floor (as decimal fraction of AGI) for deductible charitable</span>
<span class="sd">        contributions</span>
<span class="sd">    ID_Charity_hc: float</span>
<span class="sd">        Charity expense deduction haircut</span>
<span class="sd">    ID_InterestPaid_hc: float</span>
<span class="sd">        Interest paid deduction haircut</span>
<span class="sd">    ID_RealEstate_hc: float</span>
<span class="sd">        State, local, and foreign real estate taxes deductions haircut</span>
<span class="sd">    ID_Medical_c: list</span>
<span class="sd">        Ceiling on the amount of medical expense deduction allowed (dollars)</span>
<span class="sd">    ID_StateLocalTax_c: list</span>
<span class="sd">        Ceiling on the amount of state and local income and sales taxes</span>
<span class="sd">        deduction allowed (dollars)</span>
<span class="sd">    ID_RealEstate_c: list</span>
<span class="sd">        Ceiling on the amount of state, local, and foreign real estate taxes</span>
<span class="sd">        deduction allowed (dollars)</span>
<span class="sd">    ID_InterestPaid_c: list</span>
<span class="sd">        Ceiling on the amount of interest paid deduction allowed (dollars)</span>
<span class="sd">    ID_Charity_c: list</span>
<span class="sd">        Ceiling on the amount of charity expense deduction allowed (dollars)</span>
<span class="sd">    ID_Casualty_c: list</span>
<span class="sd">        Ceiling on the amount of casualty expense deduction allowed (dollars)</span>
<span class="sd">    ID_Miscellaneous_c: list</span>
<span class="sd">        Ceiling on the amount of miscellaneous expense deduction</span>
<span class="sd">        allowed (dollars)</span>
<span class="sd">    ID_AllTaxes_c: list</span>
<span class="sd">        Cap on the amount of state and local income, sales, and</span>
<span class="sd">        real estate deductions allowed (dollars)</span>
<span class="sd">    ID_AllTaxes_hc: float</span>
<span class="sd">        State and local income, sales, and real estate tax deduciton haircut</span>
<span class="sd">    ID_AllTaxes_c_ps: float</span>
<span class="sd">        AGI level above which ID_AllTaxes_c is reduced</span>
<span class="sd">    ID_AllTaxes_c_po_rate: float</span>
<span class="sd">        ID_AllTaxes_c reduction rate when AGI is above ID_AllTaxes_c_ps</span>
<span class="sd">    ID_AllTaxes_c_po_floor: float</span>
<span class="sd">        Floor below which ID_AllTaxes_c cannot be reduced</span>
<span class="sd">    ID_StateLocalTax_crt: float</span>
<span class="sd">        Ceiling (as decimal fraction of AGI) for the combination of all</span>
<span class="sd">        state and local income and sales tax deductions</span>
<span class="sd">    ID_RealEstate_crt: float</span>
<span class="sd">        Ceiling (as decimal fraction of AGI) for the combination of all</span>
<span class="sd">        state, local, and foreign real estate tax deductions</span>
<span class="sd">    ID_Charity_f: list</span>
<span class="sd">        Floor on the amount of charity expense deduction allowed (dollars)</span>
<span class="sd">    ID_reduction_rate: float</span>
<span class="sd">        OBBBA reduction rate for all itemized deductions</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c17000: float</span>
<span class="sd">        Schedule A: medical expenses deducted</span>
<span class="sd">    c18300: float</span>
<span class="sd">        Schedule A: state and local taxes plus real estate taxes deducted</span>
<span class="sd">    c19200: float</span>
<span class="sd">        Schedule A: interest deducted</span>
<span class="sd">    c19700: float</span>
<span class="sd">        Schedule A: charity contributions deducted</span>
<span class="sd">    c20500: float</span>
<span class="sd">        Schedule A: net casualty or theft loss deducted</span>
<span class="sd">    c20800: float</span>
<span class="sd">        Schedule A: net limited miscellaneous deductions deducted</span>
<span class="sd">    c21040: float</span>
<span class="sd">        Itemized deductions that are phased out under Pease limitation</span>
<span class="sd">    c21060: float</span>
<span class="sd">        Itemized deductions before any limitation (0 for non-itemizers)</span>
<span class="sd">    c04470: float</span>
<span class="sd">        Itemized deductions after all limitations (0 for non-itemizers)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-statements</span>
    <span class="n">posagi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="c1"># Medical</span>
    <span class="n">medical_frt</span> <span class="o">=</span> <span class="n">ID_Medical_frt</span>
    <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="ow">or</span> <span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">):</span>
        <span class="n">medical_frt</span> <span class="o">+=</span> <span class="n">ID_Medical_frt_add4aged</span>
    <span class="n">c17750</span> <span class="o">=</span> <span class="n">medical_frt</span> <span class="o">*</span> <span class="n">posagi</span>
    <span class="n">c17000</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e17500</span> <span class="o">-</span> <span class="n">c17750</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_Medical_hc</span><span class="p">)</span>
    <span class="n">c17000</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c17000</span><span class="p">,</span> <span class="n">ID_Medical_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># State and local taxes</span>
    <span class="n">c18400</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_StateLocalTax_hc</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">e18400</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                 <span class="n">ID_StateLocalTax_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">c18500</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_RealEstate_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e18500</span><span class="p">,</span>
                 <span class="n">ID_RealEstate_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># following two statements implement a cap on c18400 and c18500 in a way</span>
    <span class="c1"># that those with negative AGI, c00100, are not capped under current law,</span>
    <span class="c1"># hence the 0.0001 rather than zero</span>
    <span class="n">c18400</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c18400</span><span class="p">,</span> <span class="n">ID_StateLocalTax_crt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">))</span>
    <span class="n">c18500</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c18500</span><span class="p">,</span> <span class="n">ID_RealEstate_crt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">))</span>
    <span class="n">c18300</span> <span class="o">=</span> <span class="p">(</span><span class="n">c18400</span> <span class="o">+</span> <span class="n">c18500</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_AllTaxes_hc</span><span class="p">)</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="n">ID_AllTaxes_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">posagi</span> <span class="o">&gt;</span> <span class="n">ID_AllTaxes_c_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">excess_agi</span> <span class="o">=</span> <span class="n">posagi</span> <span class="o">-</span> <span class="n">ID_AllTaxes_c_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cap</span> <span class="o">-</span> <span class="n">excess_agi</span> <span class="o">*</span> <span class="n">ID_AllTaxes_c_po_rate</span><span class="p">)</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">ID_AllTaxes_c_po_floor</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">c18300</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c18300</span><span class="p">,</span> <span class="n">cap</span><span class="p">)</span>
    <span class="c1"># Interest paid</span>
    <span class="n">c19200</span> <span class="o">=</span> <span class="n">e19200</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_InterestPaid_hc</span><span class="p">)</span>
    <span class="n">c19200</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c19200</span><span class="p">,</span> <span class="n">ID_InterestPaid_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Charity</span>
    <span class="n">floor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ID_Charity_frt</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">,</span> <span class="n">ID_Charity_f</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">noncash_ded</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e20100</span> <span class="o">-</span> <span class="n">floor</span><span class="p">)</span>
    <span class="n">charity_ded_noncash</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ID_Charity_crt_noncash</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">,</span> <span class="n">noncash_ded</span><span class="p">)</span>
    <span class="n">remaining_floor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">floor</span> <span class="o">-</span> <span class="n">e20100</span><span class="p">)</span>
    <span class="n">charity_ded_cash</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e19800</span> <span class="o">-</span> <span class="n">remaining_floor</span><span class="p">)</span>
    <span class="n">c19700</span> <span class="o">=</span> <span class="n">charity_ded_noncash</span> <span class="o">+</span> <span class="n">charity_ded_cash</span>
    <span class="n">c19700</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c19700</span><span class="p">,</span> <span class="n">ID_Charity_crt_all</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_Charity_hc</span><span class="p">)</span>
    <span class="n">c19700</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c19700</span><span class="p">,</span> <span class="n">ID_Charity_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Casualty</span>
    <span class="n">c20500</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">g20500</span> <span class="o">-</span> <span class="n">ID_Casualty_frt</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">)</span> <span class="o">*</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_Casualty_hc</span><span class="p">))</span>
    <span class="n">c20500</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c20500</span><span class="p">,</span> <span class="n">ID_Casualty_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Miscellaneous</span>
    <span class="n">c20400</span> <span class="o">=</span> <span class="n">e20400</span>
    <span class="n">c20750</span> <span class="o">=</span> <span class="n">ID_Miscellaneous_frt</span> <span class="o">*</span> <span class="n">posagi</span>
    <span class="n">c20800</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c20400</span> <span class="o">-</span> <span class="n">c20750</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_Miscellaneous_hc</span><span class="p">)</span>
    <span class="n">c20800</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c20800</span><span class="p">,</span> <span class="n">ID_Miscellaneous_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Gross total itemized deductions</span>
    <span class="n">c21060</span> <span class="o">=</span> <span class="n">c17000</span> <span class="o">+</span> <span class="n">c18300</span> <span class="o">+</span> <span class="n">c19200</span> <span class="o">+</span> <span class="n">c19700</span> <span class="o">+</span> <span class="n">c20500</span> <span class="o">+</span> <span class="n">c20800</span>
    <span class="c1"># Pease limitation on total itemized deductions</span>
    <span class="c1"># (no attempt to adjust c04470 components for limitation)</span>
    <span class="n">nonlimited</span> <span class="o">=</span> <span class="n">c17000</span> <span class="o">+</span> <span class="n">c20500</span>
    <span class="n">limitstart</span> <span class="o">=</span> <span class="n">ID_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">c21060</span> <span class="o">&gt;</span> <span class="n">nonlimited</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">limitstart</span><span class="p">:</span>
        <span class="n">dedmin</span> <span class="o">=</span> <span class="n">ID_crt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c21060</span> <span class="o">-</span> <span class="n">nonlimited</span><span class="p">)</span>
        <span class="n">dedpho</span> <span class="o">=</span> <span class="n">ID_prt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">posagi</span> <span class="o">-</span> <span class="n">limitstart</span><span class="p">)</span>
        <span class="n">c21040</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dedmin</span><span class="p">,</span> <span class="n">dedpho</span><span class="p">)</span>
        <span class="n">c04470</span> <span class="o">=</span> <span class="n">c21060</span> <span class="o">-</span> <span class="n">c21040</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c21040</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">c04470</span> <span class="o">=</span> <span class="n">c21060</span>
    <span class="c1"># OBBBA limitation on total itemized deductions</span>
    <span class="c1"># (no attempt to adjust c04470 components for limitation)</span>
    <span class="n">reduction</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">ID_reduction_rate</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">c21040</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;Pease and OBBBA cannot both be in effect&#39;</span>
        <span class="n">tincome</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">c04600</span><span class="p">)</span>
        <span class="n">texcess</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tincome</span> <span class="o">-</span> <span class="n">II_brk6</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">reduction</span> <span class="o">=</span> <span class="n">ID_reduction_rate</span> <span class="o">*</span> <span class="n">texcess</span>
    <span class="n">c04470</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c04470</span> <span class="o">-</span> <span class="n">reduction</span><span class="p">)</span>
    <span class="c1"># Cap total itemized deductions</span>
    <span class="c1"># (no attempt to adjust c04470 components for limitation)</span>
    <span class="n">c04470</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c04470</span><span class="p">,</span> <span class="n">ID_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Return total itemized deduction amounts and pre-limitation components</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c17000</span><span class="p">,</span> <span class="n">c18300</span><span class="p">,</span> <span class="n">c19200</span><span class="p">,</span> <span class="n">c19700</span><span class="p">,</span> <span class="n">c20500</span><span class="p">,</span> <span class="n">c20800</span><span class="p">,</span>
            <span class="n">c21040</span><span class="p">,</span> <span class="n">c21060</span><span class="p">,</span> <span class="n">c04470</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">AdditionalMedicareTax</span><span class="p">(</span><span class="n">e00200</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
                          <span class="n">AMEDT_ec</span><span class="p">,</span> <span class="n">sey</span><span class="p">,</span> <span class="n">AMEDT_rt</span><span class="p">,</span>
                          <span class="n">FICA_mc_trt_employer</span><span class="p">,</span> <span class="n">FICA_mc_trt_employee</span><span class="p">,</span>
                          <span class="n">FICA_ss_trt_employer</span><span class="p">,</span> <span class="n">FICA_ss_trt_employee</span><span class="p">,</span>
                          <span class="n">ptax_amc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Additional Medicare Tax (Form 8959) included in othertaxes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing marital status (1=single, 2=joint, 3=separate,</span>
<span class="sd">                               4=household-head, 5=widow(er))</span>
<span class="sd">    AMEDT_ec: list</span>
<span class="sd">        Additional Medicare Tax earnings exclusion</span>
<span class="sd">    AMEDT_rt: float</span>
<span class="sd">        Additional Medicare Tax rate</span>
<span class="sd">    FICA_ss_trt_employer: float</span>
<span class="sd">        Employer side FICA Social Security tax rate</span>
<span class="sd">    FICA_ss_trt_employee: float</span>
<span class="sd">        Employee side FICA Social Security tax rate</span>
<span class="sd">    FICA_mc_trt_employer: float</span>
<span class="sd">        Employer side FICA Medicare tax rate</span>
<span class="sd">    FICA_mc_trt_employee: float</span>
<span class="sd">        Employee side FICA Medicare tax rate</span>
<span class="sd">    e00200: float</span>
<span class="sd">        Wages and salaries</span>
<span class="sd">    sey: float</span>
<span class="sd">        Self-employment income</span>
<span class="sd">    ptax_amc: float</span>
<span class="sd">        Additional Medicare Tax (included in othertaxes and iitax)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ptax_amc: float</span>
<span class="sd">        Additional Medicare Tax (included in othertaxes and iitax)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line8</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
        <span class="mf">1.</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">FICA_mc_trt_employer</span> <span class="o">+</span> <span class="n">FICA_mc_trt_employee</span> <span class="o">+</span>
                    <span class="n">FICA_ss_trt_employer</span> <span class="o">+</span> <span class="n">FICA_ss_trt_employee</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">line11</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMEDT_ec</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e00200</span><span class="p">)</span>
    <span class="n">ptax_amc</span> <span class="o">=</span> <span class="n">AMEDT_rt</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00200</span> <span class="o">-</span> <span class="n">AMEDT_ec</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                           <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line8</span> <span class="o">-</span> <span class="n">line11</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ptax_amc</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">StdDed</span><span class="p">(</span><span class="n">DSI</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span> <span class="n">STD</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">STD_Aged</span><span class="p">,</span> <span class="n">STD_Dep</span><span class="p">,</span>
           <span class="n">MARS</span><span class="p">,</span> <span class="n">MIDR</span><span class="p">,</span> <span class="n">blind_head</span><span class="p">,</span> <span class="n">blind_spouse</span><span class="p">,</span> <span class="n">standard</span><span class="p">,</span>
           <span class="n">STD_allow_charity_ded_nonitemizers</span><span class="p">,</span> <span class="n">e19800</span><span class="p">,</span> <span class="n">ID_Charity_crt_all</span><span class="p">,</span>
           <span class="n">c00100</span><span class="p">,</span> <span class="n">STD_charity_ded_nonitemizers_max</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates standard deduction, including standard deduction for</span>
<span class="sd">    dependents, aged and bind.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----</span>
<span class="sd">    DSI: int</span>
<span class="sd">        1 if claimed as dependent on another return; otherwise 0</span>
<span class="sd">    earned: float</span>
<span class="sd">        Earned income for filing unit</span>
<span class="sd">    STD: list</span>
<span class="sd">        Standard deduction amount</span>
<span class="sd">    age_head: int</span>
<span class="sd">        Age in years of taxpayer</span>
<span class="sd">    age_spouse: int</span>
<span class="sd">        Age in years of spouse</span>
<span class="sd">    STD_Aged: list</span>
<span class="sd">        Additional standard deduction for blind and aged</span>
<span class="sd">    STD_Dep: float</span>
<span class="sd">        Standard deduction for dependents</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    MIDR: int</span>
<span class="sd">        1 if separately filing spouse itemizes, 0 otherwise</span>
<span class="sd">    blind_head: int</span>
<span class="sd">        1 if taxpayer is blind, 0 otherwise</span>
<span class="sd">    blind_spouse: int</span>
<span class="sd">        1 if spouse is blind, 0 otherwise</span>
<span class="sd">    standard: float</span>
<span class="sd">        Standard deduction (zero for itemizers)</span>
<span class="sd">    STD_allow_charity_ded_nonitemizers: bool</span>
<span class="sd">        Allow standard deduction filers to take the charitable contributions</span>
<span class="sd">        deduction</span>
<span class="sd">    e19800: float</span>
<span class="sd">        Schedule A: cash charitable contributions</span>
<span class="sd">    ID_Charity_crt_all: float</span>
<span class="sd">        Fraction of AGI cap on all charitable deductions</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Federal AGI</span>
<span class="sd">    STD_charity_ded_nonitemizers_max: float</span>
<span class="sd">        Ceiling amount (in dollars) for charitable deductions for nonitemizers</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    standard: float</span>
<span class="sd">        Standard deduction (zero for itemizers)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate deduction for dependents</span>
    <span class="k">if</span> <span class="n">DSI</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">c15100</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">350.</span> <span class="o">+</span> <span class="n">earned</span><span class="p">,</span> <span class="n">STD_Dep</span><span class="p">)</span>
        <span class="n">basic_stded</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">STD</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c15100</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c15100</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">MIDR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">basic_stded</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basic_stded</span> <span class="o">=</span> <span class="n">STD</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># calculate extra standard deduction for aged and blind</span>
    <span class="n">num_extra_stded</span> <span class="o">=</span> <span class="n">blind_head</span> <span class="o">+</span> <span class="n">blind_spouse</span>
    <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
        <span class="n">num_extra_stded</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
        <span class="n">num_extra_stded</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">extra_stded</span> <span class="o">=</span> <span class="n">num_extra_stded</span> <span class="o">*</span> <span class="n">STD_Aged</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># calculate the total standard deduction</span>
    <span class="n">standard</span> <span class="o">=</span> <span class="n">basic_stded</span> <span class="o">+</span> <span class="n">extra_stded</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">MIDR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">standard</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># calculate CARES cash charity deduction for nonitemizers</span>
    <span class="k">if</span> <span class="n">STD_allow_charity_ded_nonitemizers</span><span class="p">:</span>
        <span class="n">capped_ded</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e19800</span><span class="p">,</span> <span class="n">ID_Charity_crt_all</span> <span class="o">*</span> <span class="n">c00100</span><span class="p">)</span>
        <span class="n">standard</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">capped_ded</span><span class="p">,</span> <span class="n">STD_charity_ded_nonitemizers_max</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">standard</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">TaxInc</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="n">standard</span><span class="p">,</span> <span class="n">c04470</span><span class="p">,</span> <span class="n">c04600</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span>
           <span class="n">e02100</span><span class="p">,</span> <span class="n">e27200</span><span class="p">,</span> <span class="n">e00650</span><span class="p">,</span> <span class="n">c01000</span><span class="p">,</span>
           <span class="n">senior_deduction</span><span class="p">,</span> <span class="n">auto_loan_interest_deduction</span><span class="p">,</span>
           <span class="n">PT_SSTB_income</span><span class="p">,</span> <span class="n">PT_binc_w2_wages</span><span class="p">,</span> <span class="n">PT_ubia_property</span><span class="p">,</span>
           <span class="n">PT_qbid_rt</span><span class="p">,</span> <span class="n">PT_qbid_limited</span><span class="p">,</span>
           <span class="n">PT_qbid_taxinc_thd</span><span class="p">,</span> <span class="n">PT_qbid_taxinc_gap</span><span class="p">,</span> <span class="n">PT_qbid_w2_wages_rt</span><span class="p">,</span>
           <span class="n">PT_qbid_alt_w2_wages_rt</span><span class="p">,</span> <span class="n">PT_qbid_alt_property_rt</span><span class="p">,</span>
           <span class="n">PT_qbid_ps</span><span class="p">,</span> <span class="n">PT_qbid_prt</span><span class="p">,</span> <span class="n">PT_qbid_min_ded</span><span class="p">,</span> <span class="n">PT_qbid_min_qbi</span><span class="p">,</span>
           <span class="n">c04800</span><span class="p">,</span> <span class="n">qbided</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates taxable income, c04800, and</span>
<span class="sd">    qualified business income deduction, qbided.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    standard: float</span>
<span class="sd">        Standard deduction (zero for itemizers)</span>
<span class="sd">    c04470: float</span>
<span class="sd">        Itemized deductions after phase-out (zero for non-itemizers)</span>
<span class="sd">    c04600: float</span>
<span class="sd">        Personal exemptions after phase-out</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    e00900: float</span>
<span class="sd">        Schedule C business net profit/loss for filing unit</span>
<span class="sd">    c03260: float</span>
<span class="sd">        Self-employment (SECA) tax above-the-line deduction</span>
<span class="sd">    e26270: float</span>
<span class="sd">        Schedule E: combined partnership and S-corporation net income/loss</span>
<span class="sd">    e02100: float</span>
<span class="sd">        Farm net income/loss for filing unit from Schedule F</span>
<span class="sd">    e27200: float</span>
<span class="sd">        Schedule E: farm rent net income or loss</span>
<span class="sd">    e00650: float</span>
<span class="sd">        Qualified dividends included in ordinary dividends</span>
<span class="sd">    c01000: float</span>
<span class="sd">        Limitation on capital losses</span>
<span class="sd">    senior_deduction: float</span>
<span class="sd">        Deduction for elderly head/spouse</span>
<span class="sd">    auto_loan_interest_deduction: float</span>
<span class="sd">        Deduction for qualified auto loan interest paid</span>
<span class="sd">    PT_SSTB_income: int</span>
<span class="sd">        Value of one implies business income is from a specified service</span>
<span class="sd">          trade or business (SSTB)</span>
<span class="sd">        Value of zero implies business income is from a qualified trade or</span>
<span class="sd">          business</span>
<span class="sd">    PT_binc_w2_wages: float</span>
<span class="sd">        Filing unit&#39;s share of total W-2 wages paid by the</span>
<span class="sd">        pass-through business</span>
<span class="sd">    PT_ubia_property: float</span>
<span class="sd">        Filing unit&#39;s share of total business property owned by the</span>
<span class="sd">        pass-through business</span>
<span class="sd">    PT_qbid_rt: float</span>
<span class="sd">        Pass-through qualified business income deduction rate</span>
<span class="sd">    PT_qbid_limited: bool</span>
<span class="sd">        Whether or not TCJA QBID limits are active</span>
<span class="sd">    PT_qbid_taxinc_thd: list</span>
<span class="sd">        Lower threshold of pre-QBID taxable income</span>
<span class="sd">    PT_qbid_taxinc_gap: list</span>
<span class="sd">        Dollar gap between upper and lower threshold of pre-QBID taxable income</span>
<span class="sd">    PT_qbid_w2_wages_rt: float</span>
<span class="sd">        QBID cap rate on pass-through business W-2 wages paid</span>
<span class="sd">    PT_qbid_alt_w2_wages_rt: float</span>
<span class="sd">        Alternative QBID cap rate on pass-through business W-2 wages paid</span>
<span class="sd">    PT_qbid_alt_property_rt: float</span>
<span class="sd">        Alternative QBID cap rate on pass-through business property owned</span>
<span class="sd">    PT_qbid_ps: list</span>
<span class="sd">        QBID phaseout taxable income start</span>
<span class="sd">    PT_qbid_prt: float</span>
<span class="sd">        QBID phaseout rate</span>
<span class="sd">    PT_qbid_min_ded: float</span>
<span class="sd">        Minimum QBID amount</span>
<span class="sd">    PT_qbid_min_qbi: float</span>
<span class="sd">        Minimum QBI necessary to get QBID no less than PT_qbid_min_ded</span>
<span class="sd">    c04800: float</span>
<span class="sd">        Regular taxable income</span>
<span class="sd">    qbided: float</span>
<span class="sd">        Qualified Business Income (QBI) deduction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c04800: float</span>
<span class="sd">        Regular taxable income</span>
<span class="sd">    qbided: float</span>
<span class="sd">        Qualified Business Income (QBI) deduction</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate taxable income before qualified business income deduction,</span>
    <span class="c1"># which is assumed to be stacked last in the list of deductions</span>
    <span class="n">odeds</span> <span class="o">=</span> <span class="n">senior_deduction</span> <span class="o">+</span> <span class="n">auto_loan_interest_deduction</span>
    <span class="n">pre_qbid_taxinc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c00100</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">c04470</span><span class="p">,</span> <span class="n">standard</span><span class="p">)</span> <span class="o">-</span> <span class="n">c04600</span> <span class="o">-</span> <span class="n">odeds</span><span class="p">)</span>
    <span class="c1"># calculate qualified business income deduction</span>
    <span class="n">qbinc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00900</span> <span class="o">-</span> <span class="n">c03260</span> <span class="o">+</span> <span class="n">e26270</span> <span class="o">+</span> <span class="n">e02100</span> <span class="o">+</span> <span class="n">e27200</span><span class="p">)</span>
    <span class="n">qbid_before_limits</span> <span class="o">=</span> <span class="n">qbinc</span> <span class="o">*</span> <span class="n">PT_qbid_rt</span>
    <span class="k">if</span> <span class="n">PT_qbid_limited</span><span class="p">:</span>
        <span class="n">lower_thd</span> <span class="o">=</span> <span class="n">PT_qbid_taxinc_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&lt;=</span> <span class="n">lower_thd</span><span class="p">:</span>
            <span class="n">qbided</span> <span class="o">=</span> <span class="n">qbid_before_limits</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pre_qbid_taxinc_gap</span> <span class="o">=</span> <span class="n">PT_qbid_taxinc_gap</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">upper_thd</span> <span class="o">=</span> <span class="n">lower_thd</span> <span class="o">+</span> <span class="n">pre_qbid_taxinc_gap</span>
            <span class="k">if</span> <span class="n">PT_SSTB_income</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&gt;=</span> <span class="n">upper_thd</span><span class="p">:</span>
                <span class="n">qbided</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wage_cap</span> <span class="o">=</span> <span class="n">PT_binc_w2_wages</span> <span class="o">*</span> <span class="n">PT_qbid_w2_wages_rt</span>
                <span class="n">alt_cap</span> <span class="o">=</span> <span class="p">(</span><span class="n">PT_binc_w2_wages</span> <span class="o">*</span> <span class="n">PT_qbid_alt_w2_wages_rt</span> <span class="o">+</span>
                           <span class="n">PT_ubia_property</span> <span class="o">*</span> <span class="n">PT_qbid_alt_property_rt</span><span class="p">)</span>
                <span class="n">full_cap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wage_cap</span><span class="p">,</span> <span class="n">alt_cap</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">PT_SSTB_income</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&gt;=</span> <span class="n">upper_thd</span><span class="p">:</span>
                    <span class="c1"># apply full cap</span>
                    <span class="n">qbided</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">full_cap</span><span class="p">,</span> <span class="n">qbid_before_limits</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">PT_SSTB_income</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&lt;</span> <span class="n">upper_thd</span><span class="p">:</span>
                    <span class="c1"># apply adjusted cap as in Part III of Worksheet 12-A</span>
                    <span class="c1"># in 2018 IRS Publication 535 (Chapter 12)</span>
                    <span class="n">prt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">lower_thd</span><span class="p">)</span> <span class="o">/</span> <span class="n">pre_qbid_taxinc_gap</span>
                    <span class="n">adj</span> <span class="o">=</span> <span class="n">prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">qbid_before_limits</span> <span class="o">-</span> <span class="n">full_cap</span><span class="p">)</span>
                    <span class="n">qbided</span> <span class="o">=</span> <span class="n">qbid_before_limits</span> <span class="o">-</span> <span class="n">adj</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># PT_SSTB_income == 1 and pre_qbid_taxinc &lt; upper_thd</span>
                    <span class="n">prti</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_thd</span> <span class="o">-</span> <span class="n">pre_qbid_taxinc</span><span class="p">)</span> <span class="o">/</span> <span class="n">pre_qbid_taxinc_gap</span>
                    <span class="n">qbid_adjusted</span> <span class="o">=</span> <span class="n">prti</span> <span class="o">*</span> <span class="n">qbid_before_limits</span>
                    <span class="n">cap_adjusted</span> <span class="o">=</span> <span class="n">prti</span> <span class="o">*</span> <span class="n">full_cap</span>
                    <span class="n">prt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">lower_thd</span><span class="p">)</span> <span class="o">/</span> <span class="n">pre_qbid_taxinc_gap</span>
                    <span class="n">adj</span> <span class="o">=</span> <span class="n">prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">qbid_adjusted</span> <span class="o">-</span> <span class="n">cap_adjusted</span><span class="p">)</span>
                    <span class="n">qbided</span> <span class="o">=</span> <span class="n">qbid_adjusted</span> <span class="o">-</span> <span class="n">adj</span>
        <span class="c1"># apply taxinc cap (assuming cap rate is equal to PT_qbid_rt)</span>
        <span class="c1">#   net_cg is defined on line 34 of 2018 Pub 535 Worksheet 12-A</span>
        <span class="n">net_cg</span> <span class="o">=</span> <span class="n">e00650</span> <span class="o">+</span> <span class="n">c01000</span>
        <span class="n">taxinc_cap</span> <span class="o">=</span> <span class="n">PT_qbid_rt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">net_cg</span><span class="p">)</span>
        <span class="n">qbided</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">qbided</span><span class="p">,</span> <span class="n">taxinc_cap</span><span class="p">)</span>
        <span class="c1"># apply qbid phaseout</span>
        <span class="k">if</span> <span class="n">qbided</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&gt;</span> <span class="n">PT_qbid_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">PT_qbid_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">qbided</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">qbided</span> <span class="o">-</span> <span class="n">PT_qbid_prt</span> <span class="o">*</span> <span class="n">excess</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if PT_qbid_limited is false</span>
        <span class="n">qbided</span> <span class="o">=</span> <span class="n">qbid_before_limits</span>
    <span class="c1"># apply minimum QBID logic</span>
    <span class="k">if</span> <span class="n">qbinc</span> <span class="o">&gt;=</span> <span class="n">PT_qbid_min_qbi</span> <span class="ow">and</span> <span class="n">qbided</span> <span class="o">&lt;</span> <span class="n">PT_qbid_min_ded</span><span class="p">:</span>
        <span class="n">qbided</span> <span class="o">=</span> <span class="n">PT_qbid_min_ded</span>

    <span class="c1"># calculate taxable income after qbided</span>
    <span class="n">c04800</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">qbided</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c04800</span><span class="p">,</span> <span class="n">qbided</span><span class="p">)</span>


<div class="viewcode-block" id="SchXYZ">
<a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.SchXYZ">[docs]</a>
<span class="nd">@JIT</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">SchXYZ</span><span class="p">(</span><span class="n">taxable_income</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
           <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span>
           <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
           <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span>
           <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Taxes function returns tax amount given the progressive tax rate</span>
<span class="sd">    schedule specified by the II_rt? and (upper) II_brk? parameters and</span>
<span class="sd">    given taxable income and filing status (MARS).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    taxable_income: float</span>
<span class="sd">        Regular taxable income</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    II_rt1: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 1</span>
<span class="sd">    II_rt2: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 2</span>
<span class="sd">    II_rt3: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 3</span>
<span class="sd">    II_rt4: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 4</span>
<span class="sd">    II_rt5: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 5</span>
<span class="sd">    II_rt6: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 6</span>
<span class="sd">    II_rt7: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 7</span>
<span class="sd">    II_rt8: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 8</span>
<span class="sd">    II_brk1: list</span>
<span class="sd">        Personal income (regular/non-AMT) tax bracket (upper threshold) 1</span>
<span class="sd">    II_brk2: list</span>
<span class="sd">        Personal income (regular/non-AMT) tax bracket (upper threshold) 2</span>
<span class="sd">    II_brk3: list</span>
<span class="sd">        Personal income (regular/non-AMT) tax bracket (upper threshold) 3</span>
<span class="sd">    II_brk4: list</span>
<span class="sd">        Personal income (regular/non-AMT) tax bracket (upper threshold) 4</span>
<span class="sd">    II_brk5: list</span>
<span class="sd">        Personal income (regular/non-AMT) tax bracket (upper threshold) 5</span>
<span class="sd">    II_brk6: list</span>
<span class="sd">        Personal income (regular/non-AMT) tax bracket (upper threshold) 6</span>
<span class="sd">    II_brk7: list</span>
<span class="sd">        Personal income (regular/non-AMT) tax bracket (upper threshold) 7</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Regular individual income tax liability on all taxable income</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-return-statements</span>
    <span class="k">if</span> <span class="n">taxable_income</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">brk0</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">brk1</span> <span class="o">=</span> <span class="n">II_brk1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">taxable_income</span> <span class="o">&lt;=</span> <span class="n">brk1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt1</span> <span class="o">*</span> <span class="p">(</span><span class="n">taxable_income</span> <span class="o">-</span> <span class="n">brk0</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt1</span> <span class="o">*</span> <span class="p">(</span><span class="n">brk1</span> <span class="o">-</span> <span class="n">brk0</span><span class="p">)</span>
    <span class="n">brk2</span> <span class="o">=</span> <span class="n">II_brk2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">taxable_income</span> <span class="o">&lt;=</span> <span class="n">brk2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt2</span> <span class="o">*</span> <span class="p">(</span><span class="n">taxable_income</span> <span class="o">-</span> <span class="n">brk1</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt2</span> <span class="o">*</span> <span class="p">(</span><span class="n">brk2</span> <span class="o">-</span> <span class="n">brk1</span><span class="p">)</span>
    <span class="n">brk3</span> <span class="o">=</span> <span class="n">II_brk3</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">taxable_income</span> <span class="o">&lt;=</span> <span class="n">brk3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt3</span> <span class="o">*</span> <span class="p">(</span><span class="n">taxable_income</span> <span class="o">-</span> <span class="n">brk2</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt3</span> <span class="o">*</span> <span class="p">(</span><span class="n">brk3</span> <span class="o">-</span> <span class="n">brk2</span><span class="p">)</span>
    <span class="n">brk4</span> <span class="o">=</span> <span class="n">II_brk4</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">taxable_income</span> <span class="o">&lt;=</span> <span class="n">brk4</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt4</span> <span class="o">*</span> <span class="p">(</span><span class="n">taxable_income</span> <span class="o">-</span> <span class="n">brk3</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt4</span> <span class="o">*</span> <span class="p">(</span><span class="n">brk4</span> <span class="o">-</span> <span class="n">brk3</span><span class="p">)</span>
    <span class="n">brk5</span> <span class="o">=</span> <span class="n">II_brk5</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">taxable_income</span> <span class="o">&lt;=</span> <span class="n">brk5</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt5</span> <span class="o">*</span> <span class="p">(</span><span class="n">taxable_income</span> <span class="o">-</span> <span class="n">brk4</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt5</span> <span class="o">*</span> <span class="p">(</span><span class="n">brk5</span> <span class="o">-</span> <span class="n">brk4</span><span class="p">)</span>
    <span class="n">brk6</span> <span class="o">=</span> <span class="n">II_brk6</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">taxable_income</span> <span class="o">&lt;=</span> <span class="n">brk6</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt6</span> <span class="o">*</span> <span class="p">(</span><span class="n">taxable_income</span> <span class="o">-</span> <span class="n">brk5</span><span class="p">)</span>
    <span class="n">tax</span> <span class="o">=</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt6</span> <span class="o">*</span> <span class="p">(</span><span class="n">brk6</span> <span class="o">-</span> <span class="n">brk5</span><span class="p">)</span>
    <span class="n">brk7</span> <span class="o">=</span> <span class="n">II_brk7</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">taxable_income</span> <span class="o">&lt;=</span> <span class="n">brk7</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt7</span> <span class="o">*</span> <span class="p">(</span><span class="n">taxable_income</span> <span class="o">-</span> <span class="n">brk6</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tax</span> <span class="o">+</span> <span class="n">II_rt8</span> <span class="o">*</span> <span class="p">(</span><span class="n">taxable_income</span> <span class="o">-</span> <span class="n">brk7</span><span class="p">)</span></div>



<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">SchXYZTax</span><span class="p">(</span><span class="n">c04800</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
              <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span>
              <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
              <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span>
              <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">,</span> <span class="n">c05200</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SchXYZTax calls SchXYZ function and sets c05200 to returned amount.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c04800: float</span>
<span class="sd">        Regular taxable income</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    II_rt1: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 1</span>
<span class="sd">    II_rt2: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 2</span>
<span class="sd">    II_rt3: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 3</span>
<span class="sd">    II_rt4: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 4</span>
<span class="sd">    II_rt5: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 5</span>
<span class="sd">    II_rt6: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 6</span>
<span class="sd">    II_rt7: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 7</span>
<span class="sd">    II_rt8: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 8</span>
<span class="sd">    II_brk1: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 1</span>
<span class="sd">    II_brk2: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 2</span>
<span class="sd">    II_brk3: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 3</span>
<span class="sd">    II_brk4: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 4</span>
<span class="sd">    II_brk5: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 5</span>
<span class="sd">    II_brk6: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 6</span>
<span class="sd">    II_brk7: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 7</span>
<span class="sd">    c05200: float</span>
<span class="sd">        Tax amount from Schedule X,Y,Z tables</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c05200: float</span>
<span class="sd">        Tax amount from Schedule X, Y, Z tables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c05200</span> <span class="o">=</span> <span class="n">SchXYZ</span><span class="p">(</span>
        <span class="n">c04800</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
        <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span> <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
        <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span> <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">c05200</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">GainsTax</span><span class="p">(</span><span class="n">e00650</span><span class="p">,</span> <span class="n">c01000</span><span class="p">,</span> <span class="n">c23650</span><span class="p">,</span> <span class="n">p23250</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e58990</span><span class="p">,</span>
             <span class="n">e24515</span><span class="p">,</span> <span class="n">e24518</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c04800</span><span class="p">,</span> <span class="n">c05200</span><span class="p">,</span>
             <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span> <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
             <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span> <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">,</span>
             <span class="n">CG_nodiff</span><span class="p">,</span>
             <span class="n">CG_rt1</span><span class="p">,</span> <span class="n">CG_rt2</span><span class="p">,</span> <span class="n">CG_rt3</span><span class="p">,</span> <span class="n">CG_rt4</span><span class="p">,</span> <span class="n">CG_brk1</span><span class="p">,</span> <span class="n">CG_brk2</span><span class="p">,</span> <span class="n">CG_brk3</span><span class="p">,</span>
             <span class="n">dwks10</span><span class="p">,</span> <span class="n">dwks13</span><span class="p">,</span> <span class="n">dwks14</span><span class="p">,</span> <span class="n">dwks19</span><span class="p">,</span> <span class="n">dwks43</span><span class="p">,</span> <span class="n">c05700</span><span class="p">,</span> <span class="n">taxbc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GainsTax function implements (2015) Schedule D Tax Worksheet logic for</span>
<span class="sd">    the special taxation of long-term capital gains and qualified dividends</span>
<span class="sd">    if CG_nodiff is false.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    e00650: float</span>
<span class="sd">        Qualified dividends included in ordinary dividends</span>
<span class="sd">    c01000: float</span>
<span class="sd">        Limitation on capital losses</span>
<span class="sd">    c23650: float</span>
<span class="sd">        Net capital gain (long term + short term) before exclusion</span>
<span class="sd">    p23250: float</span>
<span class="sd">        Schedule D: net long-term capital gains/losses</span>
<span class="sd">    e01100: float</span>
<span class="sd">        Capital gains distributions not reported on Schedule D</span>
<span class="sd">    e58990: float</span>
<span class="sd">        Investment income elected amount from Form 4952</span>
<span class="sd">    e24515: float</span>
<span class="sd">        Schedule D: un-recaptured section 1250 Gain</span>
<span class="sd">    e24518: float</span>
<span class="sd">        Schedule D: 28% rate gain or loss</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    c04800: float</span>
<span class="sd">        Regular taxable income</span>
<span class="sd">    c05200: float</span>
<span class="sd">        Tax amount from Schedule X,Y,Z tables</span>
<span class="sd">    II_rt1: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 1</span>
<span class="sd">    II_rt2: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 2</span>
<span class="sd">    II_rt3: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 3</span>
<span class="sd">    II_rt4: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 4</span>
<span class="sd">    II_rt5: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 5</span>
<span class="sd">    II_rt6: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 6</span>
<span class="sd">    II_rt7: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 7</span>
<span class="sd">    II_rt8: float</span>
<span class="sd">        Personal income (regular/non-AMT) tax rate 8</span>
<span class="sd">    II_brk1: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 1</span>
<span class="sd">    II_brk2: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 2</span>
<span class="sd">    II_brk3: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 3</span>
<span class="sd">    II_brk4: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 4</span>
<span class="sd">    II_brk5: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 5</span>
<span class="sd">    II_brk6: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 6</span>
<span class="sd">    II_brk7: list</span>
<span class="sd">        Personal income (regular/non-AMT)</span>
<span class="sd">        tax bracket (upper threshold) 7</span>
<span class="sd">    CG_nodiff: bool</span>
<span class="sd">        Long term capital gains and qualified dividends taxed no differently</span>
<span class="sd">        than regular taxable income</span>
<span class="sd">    CG_rt1: float</span>
<span class="sd">        Long term capital gain and qualified dividends (regular/non-AMT) rate 1</span>
<span class="sd">    CG_rt2: float</span>
<span class="sd">        Long term capital gain and qualified dividends (regular/non-AMT) rate 2</span>
<span class="sd">    CG_rt3: float</span>
<span class="sd">        Long term capital gain and qualified dividends (regular/non-AMT) rate 3</span>
<span class="sd">    CG_rt4: float</span>
<span class="sd">        Long term capital gain and qualified dividends (regular/non-AMT) rate 4</span>
<span class="sd">    CG_brk1: list</span>
<span class="sd">        Top of long-term capital gains and qualified dividends</span>
<span class="sd">        (regular/non-AMT) tax bracket 1</span>
<span class="sd">    CG_brk2: list</span>
<span class="sd">        Top of long-term capital gains and qualified dividends</span>
<span class="sd">        (regular/non-AMT) tax bracket 2</span>
<span class="sd">    CG_brk3: list</span>
<span class="sd">        Top of long-term capital gains and qualified dividends</span>
<span class="sd">        (regular/non-AMT) tax bracket 3</span>
<span class="sd">    dwks10: float</span>
<span class="sd">        Sum of dwks6 + dwks9</span>
<span class="sd">    dwks13: float</span>
<span class="sd">        Difference of dwks10 - dwks12</span>
<span class="sd">    dwks14: float</span>
<span class="sd">        Maximum of 0 and dwks1 - dwks13</span>
<span class="sd">    dwks19: float</span>
<span class="sd">        Maximum of dwks17 and dwks16</span>
<span class="sd">    dwks43: float</span>
<span class="sd">        separate tax on long-term capital gains and qualified dividends</span>
<span class="sd">    c05700: float</span>
<span class="sd">        Lump sum distributions</span>
<span class="sd">    taxbc: float</span>
<span class="sd">        Regular tax on regular taxable income before credits</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dwks10: float</span>
<span class="sd">        Sum of dwks6 + dwks9</span>
<span class="sd">    dwks13: float</span>
<span class="sd">        Difference of dwks10 - dwks12</span>
<span class="sd">    dwks14: float</span>
<span class="sd">        Maximum of 0 and dwks1 - dwks13</span>
<span class="sd">    dwks19: float</span>
<span class="sd">        Maximum of dwks17 and dwks16</span>
<span class="sd">    dwks43: float</span>
<span class="sd">        separate tax on long-term capital gains and qualified dividends</span>
<span class="sd">    c05700: float</span>
<span class="sd">        Lump sum distributions</span>
<span class="sd">    taxbc: float</span>
<span class="sd">        Regular tax on regular taxable income before credits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-statements</span>
    <span class="k">if</span> <span class="n">c01000</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">c23650</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">p23250</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">e01100</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">e00650</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">hasqdivltcg</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># has qualified dividends or long-term capital gains</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hasqdivltcg</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># no qualified dividends or long-term capital gains</span>

    <span class="k">if</span> <span class="n">CG_nodiff</span><span class="p">:</span>
        <span class="n">hasqdivltcg</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># no special taxation of qual divids and l-t cap gains</span>

    <span class="k">if</span> <span class="n">hasqdivltcg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

        <span class="n">dwks1</span> <span class="o">=</span> <span class="n">c04800</span>
        <span class="n">dwks2</span> <span class="o">=</span> <span class="n">e00650</span>
        <span class="n">dwks3</span> <span class="o">=</span> <span class="n">e58990</span>
        <span class="n">dwks4</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># always assumed to be zero</span>
        <span class="n">dwks5</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks3</span> <span class="o">-</span> <span class="n">dwks4</span><span class="p">)</span>
        <span class="n">dwks6</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks2</span> <span class="o">-</span> <span class="n">dwks5</span><span class="p">)</span>
        <span class="n">dwks7</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p23250</span><span class="p">,</span> <span class="n">c23650</span><span class="p">)</span>  <span class="c1"># SchD lines 15 and 16, respectively</span>
        <span class="c1"># dwks8 = min(dwks3, dwks4)</span>
        <span class="c1"># dwks9 = max(0., dwks7 - dwks8)</span>
        <span class="c1"># BELOW TWO STATEMENTS ARE UNCLEAR IN LIGHT OF dwks9=... COMMENT</span>
        <span class="k">if</span> <span class="n">e01100</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">c24510</span> <span class="o">=</span> <span class="n">e01100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c24510</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks7</span><span class="p">)</span> <span class="o">+</span> <span class="n">e01100</span>
        <span class="n">dwks9</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c24510</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e58990</span><span class="p">))</span>
        <span class="c1"># ABOVE TWO STATEMENTS ARE UNCLEAR IN LIGHT OF dwks9=... COMMENT</span>
        <span class="n">dwks10</span> <span class="o">=</span> <span class="n">dwks6</span> <span class="o">+</span> <span class="n">dwks9</span>
        <span class="n">dwks11</span> <span class="o">=</span> <span class="n">e24515</span> <span class="o">+</span> <span class="n">e24518</span>  <span class="c1"># SchD lines 18 and 19, respectively</span>
        <span class="n">dwks12</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks9</span><span class="p">,</span> <span class="n">dwks11</span><span class="p">)</span>
        <span class="n">dwks13</span> <span class="o">=</span> <span class="n">dwks10</span> <span class="o">-</span> <span class="n">dwks12</span>
        <span class="n">dwks14</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks1</span> <span class="o">-</span> <span class="n">dwks13</span><span class="p">)</span>
        <span class="n">dwks16</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CG_brk1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dwks1</span><span class="p">)</span>
        <span class="n">dwks17</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks14</span><span class="p">,</span> <span class="n">dwks16</span><span class="p">)</span>
        <span class="n">dwks18</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks1</span> <span class="o">-</span> <span class="n">dwks10</span><span class="p">)</span>
        <span class="n">dwks19</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dwks17</span><span class="p">,</span> <span class="n">dwks18</span><span class="p">)</span>
        <span class="n">dwks20</span> <span class="o">=</span> <span class="n">dwks16</span> <span class="o">-</span> <span class="n">dwks17</span>
        <span class="n">lowest_rate_tax</span> <span class="o">=</span> <span class="n">CG_rt1</span> <span class="o">*</span> <span class="n">dwks20</span>
        <span class="c1"># break in worksheet lines</span>
        <span class="n">dwks21</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks1</span><span class="p">,</span> <span class="n">dwks13</span><span class="p">)</span>
        <span class="n">dwks22</span> <span class="o">=</span> <span class="n">dwks20</span>
        <span class="n">dwks23</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks21</span> <span class="o">-</span> <span class="n">dwks22</span><span class="p">)</span>
        <span class="n">dwks25</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CG_brk2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dwks1</span><span class="p">)</span>
        <span class="n">dwks26</span> <span class="o">=</span> <span class="n">dwks19</span> <span class="o">+</span> <span class="n">dwks20</span>
        <span class="n">dwks27</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks25</span> <span class="o">-</span> <span class="n">dwks26</span><span class="p">)</span>
        <span class="n">dwks28</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks23</span><span class="p">,</span> <span class="n">dwks27</span><span class="p">)</span>
        <span class="n">dwks29</span> <span class="o">=</span> <span class="n">CG_rt2</span> <span class="o">*</span> <span class="n">dwks28</span>
        <span class="n">dwks30</span> <span class="o">=</span> <span class="n">dwks22</span> <span class="o">+</span> <span class="n">dwks28</span>
        <span class="n">dwks31</span> <span class="o">=</span> <span class="n">dwks21</span> <span class="o">-</span> <span class="n">dwks30</span>
        <span class="n">dwks32</span> <span class="o">=</span> <span class="n">CG_rt3</span> <span class="o">*</span> <span class="n">dwks31</span>
        <span class="c1"># compute total taxable CG for additional top bracket</span>
        <span class="n">cg_all</span> <span class="o">=</span> <span class="n">dwks20</span> <span class="o">+</span> <span class="n">dwks28</span> <span class="o">+</span> <span class="n">dwks31</span>
        <span class="n">hi_base</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cg_all</span> <span class="o">-</span> <span class="n">CG_brk3</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">hi_incremental_rate</span> <span class="o">=</span> <span class="n">CG_rt4</span> <span class="o">-</span> <span class="n">CG_rt3</span>
        <span class="n">highest_rate_incremental_tax</span> <span class="o">=</span> <span class="n">hi_incremental_rate</span> <span class="o">*</span> <span class="n">hi_base</span>
        <span class="c1"># break in worksheet lines</span>
        <span class="n">dwks33</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks9</span><span class="p">,</span> <span class="n">e24515</span><span class="p">)</span>
        <span class="n">dwks34</span> <span class="o">=</span> <span class="n">dwks10</span> <span class="o">+</span> <span class="n">dwks19</span>
        <span class="n">dwks36</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks34</span> <span class="o">-</span> <span class="n">dwks1</span><span class="p">)</span>
        <span class="n">dwks37</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks33</span> <span class="o">-</span> <span class="n">dwks36</span><span class="p">)</span>
        <span class="n">dwks38</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">dwks37</span>
        <span class="c1"># break in worksheet lines</span>
        <span class="n">dwks39</span> <span class="o">=</span> <span class="n">dwks19</span> <span class="o">+</span> <span class="n">dwks20</span> <span class="o">+</span> <span class="n">dwks28</span> <span class="o">+</span> <span class="n">dwks31</span> <span class="o">+</span> <span class="n">dwks37</span>
        <span class="n">dwks40</span> <span class="o">=</span> <span class="n">dwks1</span> <span class="o">-</span> <span class="n">dwks39</span>
        <span class="n">dwks41</span> <span class="o">=</span> <span class="mf">0.28</span> <span class="o">*</span> <span class="n">dwks40</span>
        <span class="n">dwks42</span> <span class="o">=</span> <span class="n">SchXYZ</span><span class="p">(</span><span class="n">dwks19</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
                        <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span>
                        <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
                        <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span>
                        <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">)</span>
        <span class="n">dwks43</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwks29</span> <span class="o">+</span> <span class="n">dwks32</span> <span class="o">+</span> <span class="n">dwks38</span> <span class="o">+</span> <span class="n">dwks41</span> <span class="o">+</span> <span class="n">dwks42</span> <span class="o">+</span>
                  <span class="n">lowest_rate_tax</span> <span class="o">+</span> <span class="n">highest_rate_incremental_tax</span><span class="p">)</span>
        <span class="n">dwks44</span> <span class="o">=</span> <span class="n">c05200</span>
        <span class="n">dwks45</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks43</span><span class="p">,</span> <span class="n">dwks44</span><span class="p">)</span>
        <span class="n">c24580</span> <span class="o">=</span> <span class="n">dwks45</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if hasqdivltcg is zero</span>

        <span class="n">c24580</span> <span class="o">=</span> <span class="n">c05200</span>
        <span class="n">dwks10</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">p23250</span><span class="p">,</span> <span class="n">c23650</span><span class="p">))</span> <span class="o">+</span> <span class="n">e01100</span>
        <span class="n">dwks13</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dwks14</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dwks19</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dwks43</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># final calculations done no matter what the value of hasqdivltcg</span>
    <span class="n">c05100</span> <span class="o">=</span> <span class="n">c24580</span>  <span class="c1"># because foreign earned income exclusion is assumed zero</span>
    <span class="n">c05700</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># no Form 4972, Lump Sum Distributions</span>
    <span class="n">taxbc</span> <span class="o">=</span> <span class="n">c05700</span> <span class="o">+</span> <span class="n">c05100</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dwks10</span><span class="p">,</span> <span class="n">dwks13</span><span class="p">,</span> <span class="n">dwks14</span><span class="p">,</span> <span class="n">dwks19</span><span class="p">,</span> <span class="n">dwks43</span><span class="p">,</span> <span class="n">c05700</span><span class="p">,</span> <span class="n">taxbc</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">AGIsurtax</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">AGI_surtax_trt</span><span class="p">,</span> <span class="n">AGI_surtax_thd</span><span class="p">,</span> <span class="n">taxbc</span><span class="p">,</span> <span class="n">surtax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes surtax on AGI above some threshold.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    AGI_surtax_trt: float</span>
<span class="sd">        New AGI surtax rate</span>
<span class="sd">    AGI_surtax_thd: list</span>
<span class="sd">        Threshold for the new AGI surtax</span>
<span class="sd">    taxbc: float</span>
<span class="sd">        Regular tax on regular taxable income before credits</span>
<span class="sd">    surtax: float</span>
<span class="sd">        Surtax on AGI above some threshold</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    taxbc: float</span>
<span class="sd">        Regular tax on regular taxable income before credits</span>
<span class="sd">    surtax: float</span>
<span class="sd">        Surtax on AGI above some threshold</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">AGI_surtax_trt</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">hiAGItax</span> <span class="o">=</span> <span class="n">AGI_surtax_trt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">AGI_surtax_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">taxbc</span> <span class="o">+=</span> <span class="n">hiAGItax</span>
        <span class="n">surtax</span> <span class="o">+=</span> <span class="n">hiAGItax</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">taxbc</span><span class="p">,</span> <span class="n">surtax</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">AMT</span><span class="p">(</span><span class="n">e07300</span><span class="p">,</span> <span class="n">dwks13</span><span class="p">,</span> <span class="n">standard</span><span class="p">,</span> <span class="n">f6251</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">c18300</span><span class="p">,</span> <span class="n">taxbc</span><span class="p">,</span>
        <span class="n">c04470</span><span class="p">,</span> <span class="n">c17000</span><span class="p">,</span> <span class="n">c20800</span><span class="p">,</span> <span class="n">c21040</span><span class="p">,</span> <span class="n">e24515</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">dwks19</span><span class="p">,</span>
        <span class="n">dwks14</span><span class="p">,</span> <span class="n">c05700</span><span class="p">,</span> <span class="n">e62900</span><span class="p">,</span> <span class="n">e00700</span><span class="p">,</span> <span class="n">dwks10</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span>
        <span class="n">earned</span><span class="p">,</span> <span class="n">cmbtp</span><span class="p">,</span> <span class="n">qbided</span><span class="p">,</span>
        <span class="n">AMT_child_em_c_age</span><span class="p">,</span> <span class="n">AMT_brk1</span><span class="p">,</span>
        <span class="n">AMT_em</span><span class="p">,</span> <span class="n">AMT_prt</span><span class="p">,</span> <span class="n">AMT_rt1</span><span class="p">,</span> <span class="n">AMT_rt2_addon</span><span class="p">,</span>
        <span class="n">AMT_child_em</span><span class="p">,</span> <span class="n">AMT_em_ps</span><span class="p">,</span> <span class="n">AMT_em_pe</span><span class="p">,</span>
        <span class="n">AMT_CG_brk1</span><span class="p">,</span> <span class="n">AMT_CG_brk2</span><span class="p">,</span> <span class="n">AMT_CG_brk3</span><span class="p">,</span> <span class="n">AMT_CG_rt1</span><span class="p">,</span> <span class="n">AMT_CG_rt2</span><span class="p">,</span>
        <span class="n">AMT_CG_rt3</span><span class="p">,</span> <span class="n">AMT_CG_rt4</span><span class="p">,</span> <span class="n">c05800</span><span class="p">,</span> <span class="n">c09600</span><span class="p">,</span> <span class="n">c62100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Alternative Minimum Tax (AMT) taxable income and liability, where</span>
<span class="sd">    c62100 is AMT taxable income,</span>
<span class="sd">    c09600 is AMT tax liability, and</span>
<span class="sd">    c05800 is total (regular + AMT) income tax liability before credits.</span>

<span class="sd">    Note that line-number variable names refer to 2015 Form 6251.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    e07300: float</span>
<span class="sd">        Foreign tax credit from Form 1116</span>
<span class="sd">    dwks13: float</span>
<span class="sd">        Difference of dwks10 - dwks12</span>
<span class="sd">    standard: float</span>
<span class="sd">        Standard deduction (zero for itemizers)</span>
<span class="sd">    f6251: int</span>
<span class="sd">        1 if Form 6251 (AMT) attached to return, otherwise 0</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    c18300: float</span>
<span class="sd">        Schedule A: state and local taxes plus real estate taxes deducted</span>
<span class="sd">    taxbc: float</span>
<span class="sd">        Regular tax on regular taxable income before credits</span>
<span class="sd">    c04470: float</span>
<span class="sd">        Itemized deductions after phase-out (zero for non-itemizers)</span>
<span class="sd">    c17000: float</span>
<span class="sd">        Schedule A: Medical expenses deducted</span>
<span class="sd">    c20800: float</span>
<span class="sd">        Schedule A: net limited miscellaneous deductions deducted</span>
<span class="sd">    c21040: float</span>
<span class="sd">        Itemized deductions that are phased out</span>
<span class="sd">    e24515: float</span>
<span class="sd">        Schedule D: Un-Recaptured Section 1250 Gain</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    sep: int</span>
<span class="sd">        2 when MARS is 3 (married filing separately), otherwise 1</span>
<span class="sd">    dwks19: float</span>
<span class="sd">        Maximum of 0 and dwks1 - dwks13</span>
<span class="sd">    dwks14: float</span>
<span class="sd">        Maximum of 0 and dwks1 - dwks13</span>
<span class="sd">    c05700: float</span>
<span class="sd">        Lump sum distributions</span>
<span class="sd">    e62900: float</span>
<span class="sd">        Alternative Minimum Tax foreign tax credit from Form 6251</span>
<span class="sd">    e00700: float</span>
<span class="sd">        Taxable refunds of state and local income taxes</span>
<span class="sd">    dwks10: float</span>
<span class="sd">        Sum of dwks6 + dwks9</span>
<span class="sd">    age_head: int</span>
<span class="sd">        Age in years of taxpayer (i.e. primary adult)</span>
<span class="sd">    age_spouse: int</span>
<span class="sd">        Age in years of spouse (i.e. secondary adult if present)</span>
<span class="sd">    earned: float</span>
<span class="sd">        Earned income for filing unit</span>
<span class="sd">    cmbtp: float</span>
<span class="sd">        Estimate of income on (AMT) Form 6251 but not in AGI</span>
<span class="sd">    qbided: float</span>
<span class="sd">        Qualified business income deduction</span>
<span class="sd">    AMT_child_em_c_age: float</span>
<span class="sd">        Age ceiling for special AMT exemption</span>
<span class="sd">    AMT_brk1: float</span>
<span class="sd">        AMT bracket 1 (upper threshold)</span>
<span class="sd">    AMT_em: list</span>
<span class="sd">        AMT exemption amount</span>
<span class="sd">    AMT_prt: float</span>
<span class="sd">        AMT exemption phaseout rate</span>
<span class="sd">    AMT_rt1: float</span>
<span class="sd">        AMT rate 1</span>
<span class="sd">    AMT_rt2_addon: float</span>
<span class="sd">        Additional AMT rate for AMT taxable income above AMT bracket 1</span>
<span class="sd">    AMT_child_em: float</span>
<span class="sd">        Child AMT exemption additional income base</span>
<span class="sd">    AMT_em_ps: list</span>
<span class="sd">        AMT exemption phaseout start</span>
<span class="sd">    AMT_em_pe: float</span>
<span class="sd">        AMT exemption phaseout ending AMT taxable income for</span>
<span class="sd">        married filing separately</span>
<span class="sd">    AMT_CG_brk1: list</span>
<span class="sd">        Top of long-term capital gains and qualified dividends (AMT) tax</span>
<span class="sd">        bracket 1</span>
<span class="sd">    AMT_CG_brk2: list</span>
<span class="sd">        Top of long-term capital gains and qualified dividends (AMT) tax</span>
<span class="sd">        bracket 2</span>
<span class="sd">    AMT_CG_brk3: list</span>
<span class="sd">        Top of long-term capital gains and qualified dividends (AMT) tax</span>
<span class="sd">        bracket 3</span>
<span class="sd">    AMT_CG_rt1: float</span>
<span class="sd">        Long term capital gain and qualified dividends (AMT) rate 1</span>
<span class="sd">    AMT_CG_rt2: float</span>
<span class="sd">        Long term capital gain and qualified dividends (AMT) rate 2</span>
<span class="sd">    AMT_CG_rt3: float</span>
<span class="sd">        Long term capital gain and qualified dividends (AMT) rate 3</span>
<span class="sd">    AMT_CG_rt4: float</span>
<span class="sd">        Long term capital gain and qualified dividends (AMT) rate 4</span>
<span class="sd">    c05800: float</span>
<span class="sd">        Total (regular + AMT) income tax liability before credits</span>
<span class="sd">    c09600: float</span>
<span class="sd">        Alternative Minimum Tax (AMT) liability</span>
<span class="sd">    c62100: float</span>
<span class="sd">        Alternative Minimum Tax (AMT) taxable income</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c62100: float</span>
<span class="sd">        Alternative Minimum Tax (AMT) taxable income</span>
<span class="sd">    c09600: float</span>
<span class="sd">        Alternative Minimum Tax (AMT) tax liability</span>
<span class="sd">    c05800: float</span>
<span class="sd">        Total (regular + AMT) income tax liability before credits</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-statements,too-many-branches</span>
    <span class="c1"># Form 6251, Part I</span>
    <span class="k">if</span> <span class="n">standard</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">c62100</span> <span class="o">=</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">e00700</span> <span class="o">-</span> <span class="n">qbided</span> <span class="o">-</span> <span class="n">c04470</span> <span class="o">+</span>
                  <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c17000</span><span class="p">,</span> <span class="mf">0.025</span> <span class="o">*</span> <span class="n">c00100</span><span class="p">))</span> <span class="o">+</span>
                  <span class="n">c18300</span> <span class="o">+</span> <span class="n">c20800</span> <span class="o">-</span> <span class="n">c21040</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">standard</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">c62100</span> <span class="o">=</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">e00700</span> <span class="o">-</span> <span class="n">qbided</span>
    <span class="n">c62100</span> <span class="o">+=</span> <span class="n">cmbtp</span>  <span class="c1"># add income not in AGI but considered income for AMT</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">amtsepadd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">AMT_em</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">AMT_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c62100</span> <span class="o">-</span> <span class="n">AMT_em_pe</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">amtsepadd</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">c62100</span> <span class="o">=</span> <span class="n">c62100</span> <span class="o">+</span> <span class="n">amtsepadd</span>  <span class="c1"># AMT taxable income, which is line28</span>
    <span class="c1"># Form 6251, Part II top</span>
    <span class="n">line29</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMT_em</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">AMT_prt</span> <span class="o">*</span>
                 <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c62100</span> <span class="o">-</span> <span class="n">AMT_em_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">young_head</span> <span class="o">=</span> <span class="n">age_head</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">age_head</span> <span class="o">&lt;</span> <span class="n">AMT_child_em_c_age</span>
    <span class="n">no_or_young_spouse</span> <span class="o">=</span> <span class="n">age_spouse</span> <span class="o">&lt;</span> <span class="n">AMT_child_em_c_age</span>
    <span class="k">if</span> <span class="n">young_head</span> <span class="ow">and</span> <span class="n">no_or_young_spouse</span><span class="p">:</span>
        <span class="n">line29</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line29</span><span class="p">,</span> <span class="n">earned</span> <span class="o">+</span> <span class="n">AMT_child_em</span><span class="p">)</span>
    <span class="n">line30</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c62100</span> <span class="o">-</span> <span class="n">line29</span><span class="p">)</span>
    <span class="n">line3163</span> <span class="o">=</span> <span class="p">(</span><span class="n">AMT_rt1</span> <span class="o">*</span> <span class="n">line30</span> <span class="o">+</span>
                <span class="n">AMT_rt2_addon</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">line30</span> <span class="o">-</span> <span class="p">(</span><span class="n">AMT_brk1</span> <span class="o">/</span> <span class="n">sep</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">dwks10</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">dwks13</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">dwks14</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">dwks19</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">e24515</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="c1"># complete Form 6251, Part III (line36 is equal to line30)</span>
        <span class="n">line37</span> <span class="o">=</span> <span class="n">dwks13</span>
        <span class="n">line38</span> <span class="o">=</span> <span class="n">e24515</span>
        <span class="n">line39</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line37</span> <span class="o">+</span> <span class="n">line38</span><span class="p">,</span> <span class="n">dwks10</span><span class="p">)</span>
        <span class="n">line40</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line30</span><span class="p">,</span> <span class="n">line39</span><span class="p">)</span>
        <span class="n">line41</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line30</span> <span class="o">-</span> <span class="n">line40</span><span class="p">)</span>
        <span class="n">line42</span> <span class="o">=</span> <span class="p">(</span><span class="n">AMT_rt1</span> <span class="o">*</span> <span class="n">line41</span> <span class="o">+</span>
                  <span class="n">AMT_rt2_addon</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">line41</span> <span class="o">-</span> <span class="p">(</span><span class="n">AMT_brk1</span> <span class="o">/</span> <span class="n">sep</span><span class="p">))))</span>
        <span class="n">line44</span> <span class="o">=</span> <span class="n">dwks14</span>
        <span class="n">line45</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMT_CG_brk1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line44</span><span class="p">)</span>
        <span class="n">line46</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line30</span><span class="p">,</span> <span class="n">line37</span><span class="p">)</span>
        <span class="n">line47</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line45</span><span class="p">,</span> <span class="n">line46</span><span class="p">)</span>  <span class="c1"># line47 is amount taxed at AMT_CG_rt1</span>
        <span class="n">cgtax1</span> <span class="o">=</span> <span class="n">line47</span> <span class="o">*</span> <span class="n">AMT_CG_rt1</span>
        <span class="n">line48</span> <span class="o">=</span> <span class="n">line46</span> <span class="o">-</span> <span class="n">line47</span>
        <span class="n">line51</span> <span class="o">=</span> <span class="n">dwks19</span>
        <span class="n">line52</span> <span class="o">=</span> <span class="n">line45</span> <span class="o">+</span> <span class="n">line51</span>
        <span class="n">line53</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMT_CG_brk2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line52</span><span class="p">)</span>
        <span class="n">line54</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line48</span><span class="p">,</span> <span class="n">line53</span><span class="p">)</span>  <span class="c1"># line54 is amount taxed at AMT_CG_rt2</span>
        <span class="n">cgtax2</span> <span class="o">=</span> <span class="n">line54</span> <span class="o">*</span> <span class="n">AMT_CG_rt2</span>
        <span class="n">line56</span> <span class="o">=</span> <span class="n">line47</span> <span class="o">+</span> <span class="n">line54</span>  <span class="c1"># total amount in lower two brackets</span>
        <span class="k">if</span> <span class="n">line41</span> <span class="o">==</span> <span class="n">line56</span><span class="p">:</span>
            <span class="n">line57</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># line57 is amount taxed at AMT_CG_rt3</span>
            <span class="n">linex2</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># linex2 is amount taxed at AMT_CG_rt4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line57</span> <span class="o">=</span> <span class="n">line46</span> <span class="o">-</span> <span class="n">line56</span>
            <span class="n">linex1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line48</span><span class="p">,</span>
                         <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMT_CG_brk3</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line44</span> <span class="o">-</span> <span class="n">line45</span><span class="p">))</span>
            <span class="n">linex2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line54</span> <span class="o">-</span> <span class="n">linex1</span><span class="p">)</span>
        <span class="n">cgtax3</span> <span class="o">=</span> <span class="n">line57</span> <span class="o">*</span> <span class="n">AMT_CG_rt3</span>
        <span class="n">cgtax4</span> <span class="o">=</span> <span class="n">linex2</span> <span class="o">*</span> <span class="n">AMT_CG_rt4</span>
        <span class="k">if</span> <span class="n">line38</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">line61</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line61</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line30</span> <span class="o">-</span> <span class="n">line41</span> <span class="o">-</span> <span class="n">line56</span> <span class="o">-</span> <span class="n">line57</span> <span class="o">-</span> <span class="n">linex2</span><span class="p">)</span>
        <span class="n">line62</span> <span class="o">=</span> <span class="n">line42</span> <span class="o">+</span> <span class="n">cgtax1</span> <span class="o">+</span> <span class="n">cgtax2</span> <span class="o">+</span> <span class="n">cgtax3</span> <span class="o">+</span> <span class="n">cgtax4</span> <span class="o">+</span> <span class="n">line61</span>
        <span class="n">line64</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line3163</span><span class="p">,</span> <span class="n">line62</span><span class="p">)</span>
        <span class="n">line31</span> <span class="o">=</span> <span class="n">line64</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if not completing Form 6251, Part III</span>
        <span class="n">line31</span> <span class="o">=</span> <span class="n">line3163</span>
    <span class="c1"># Form 6251, Part II bottom</span>
    <span class="k">if</span> <span class="n">f6251</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">line32</span> <span class="o">=</span> <span class="n">e62900</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line32</span> <span class="o">=</span> <span class="n">e07300</span>
    <span class="n">line33</span> <span class="o">=</span> <span class="n">line31</span> <span class="o">-</span> <span class="n">line32</span>
    <span class="n">c09600</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line33</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">taxbc</span> <span class="o">-</span> <span class="n">e07300</span> <span class="o">-</span> <span class="n">c05700</span><span class="p">))</span>
    <span class="n">c05800</span> <span class="o">=</span> <span class="n">taxbc</span> <span class="o">+</span> <span class="n">c09600</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c62100</span><span class="p">,</span> <span class="n">c09600</span><span class="p">,</span> <span class="n">c05800</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">NetInvIncTax</span><span class="p">(</span><span class="n">e00300</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">c01000</span><span class="p">,</span>
                 <span class="n">c00100</span><span class="p">,</span> <span class="n">NIIT_thd</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">NIIT_PT_taxed</span><span class="p">,</span> <span class="n">NIIT_rt</span><span class="p">,</span> <span class="n">niit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Net Investment Income Tax (NIIT) amount assuming that</span>
<span class="sd">    all annuity income is excluded from net investment income.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    e00300: float</span>
<span class="sd">        Tax-exempt interest income</span>
<span class="sd">    e00600: float</span>
<span class="sd">        Ordinary dividends included in AGI</span>
<span class="sd">    e02000: float</span>
<span class="sd">        Schedule E total rental, royalty, parternship, S-corporation,</span>
<span class="sd">        etc, income/loss</span>
<span class="sd">    e26270: float</span>
<span class="sd">        Schedule E: combined partnership and S-corporation net income/loss</span>
<span class="sd">    c01000: float</span>
<span class="sd">        Limitation on capital losses</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    NIIT_thd: list</span>
<span class="sd">        Net Investment Income Tax modified AGI threshold</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    NIIT_PT_taxed: bool</span>
<span class="sd">        Whether or not partnership and S-corp income is NIIT based</span>
<span class="sd">    NIIT_rt: float</span>
<span class="sd">        Net Investment Income Tax rate</span>
<span class="sd">    niit: float</span>
<span class="sd">        Net investment income tax from Form 8960</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    niit: float</span>
<span class="sd">        Net investment income tax from Form 8960</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modAGI</span> <span class="o">=</span> <span class="n">c00100</span>  <span class="c1"># no foreign earned income exclusion to add</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">NIIT_PT_taxed</span><span class="p">:</span>
        <span class="n">NII</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span> <span class="n">c01000</span> <span class="o">+</span> <span class="n">e02000</span> <span class="o">-</span> <span class="n">e26270</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># do not subtract e26270 from e02000</span>
        <span class="n">NII</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span> <span class="n">c01000</span> <span class="o">+</span> <span class="n">e02000</span><span class="p">)</span>
    <span class="n">niit</span> <span class="o">=</span> <span class="n">NIIT_rt</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">NII</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">modAGI</span> <span class="o">-</span> <span class="n">NIIT_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">niit</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">F2441</span><span class="p">(</span><span class="n">MARS</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span> <span class="n">f2441</span><span class="p">,</span> <span class="n">CDCC_c</span><span class="p">,</span> <span class="n">e32800</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span>
          <span class="n">CDCC_ps1</span><span class="p">,</span> <span class="n">CDCC_ps2</span><span class="p">,</span> <span class="n">CDCC_po1_rate_max</span><span class="p">,</span> <span class="n">CDCC_po1_rate_min</span><span class="p">,</span>
          <span class="n">CDCC_po2_rate_min</span><span class="p">,</span> <span class="n">CDCC_po1_step_size</span><span class="p">,</span> <span class="n">CDCC_po2_step_size</span><span class="p">,</span>
          <span class="n">CDCC_po_rate_per_step</span><span class="p">,</span> <span class="n">CDCC_refundable</span><span class="p">,</span>
          <span class="n">c05800</span><span class="p">,</span> <span class="n">e07300</span><span class="p">,</span> <span class="n">c32800</span><span class="p">,</span> <span class="n">c07180</span><span class="p">,</span> <span class="n">CDCC_refund</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Form 2441 child and dependent care expense credit, c07180.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    earned_p: float</span>
<span class="sd">        Earned income for taxpayer</span>
<span class="sd">    earned_s: float</span>
<span class="sd">        Earned income for spouse</span>
<span class="sd">    f2441: int</span>
<span class="sd">        Number of child/dependent care qualifying persons</span>
<span class="sd">    CDCC_c: float</span>
<span class="sd">        Maximum child/dependent care credit per dependent</span>
<span class="sd">    e32800: float</span>
<span class="sd">        Child/dependent care expenses for qualifying persons from Form 2441</span>
<span class="sd">    exact: int</span>
<span class="sd">        Whether or not to do rounding of phaseout fraction</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    CDCC_ps1: float</span>
<span class="sd">        Child/dependent care credit first phaseout start</span>
<span class="sd">    CDCC_ps2: list[float]</span>
<span class="sd">        Child/dependent care credit second phaseout start</span>
<span class="sd">    CDCC_po1_rate_max: float</span>
<span class="sd">        Child/dependent care credit first phaseout rate maximum</span>
<span class="sd">    CDCC_po1_rate_min: float</span>
<span class="sd">        Child/dependent care credit first phaseout rate minimum</span>
<span class="sd">    CDCC_po2_rate_min: float</span>
<span class="sd">        Child/dependent care credit second phaseout rate minimum</span>
<span class="sd">    CDCC_po1_step_size: float</span>
<span class="sd">        Child/dependent care credit first phaseout AGI step size</span>
<span class="sd">    CDCC_po2_step_size: float</span>
<span class="sd">        Child/dependent care credit second phaseout AGI step size</span>
<span class="sd">    CDCC_po_rate_per_step: float</span>
<span class="sd">        Child/dependent care credit phaseout rate per step size</span>
<span class="sd">    CDCC_refundable: bool</span>
<span class="sd">        Indicator for whether CDCC is refundable</span>
<span class="sd">    c05800: float</span>
<span class="sd">        Total (regular + AMT) income tax liability before credits</span>
<span class="sd">    e07300: float</span>
<span class="sd">        Foreign tax credit from Form 1116</span>
<span class="sd">    c32800: float</span>
<span class="sd">        Child and dependent care expenses capped by policy (not by earnings)</span>
<span class="sd">    c07180: float</span>
<span class="sd">        Credit for child and dependent care expenses from Form 2441</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c32800: float</span>
<span class="sd">        Child and dependent care expenses capped by policy (not by earnings)</span>
<span class="sd">    c07180: float</span>
<span class="sd">        Credit for child and dependent care expenses from Form 2441</span>
<span class="sd">    CDCC_refund: float</span>
<span class="sd">        Refundable amount of c07180 amount</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># credit for at most two cared-for individuals and for actual expenses</span>
    <span class="n">max_credit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">f2441</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">CDCC_c</span>
    <span class="n">c32800</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">e32800</span><span class="p">,</span> <span class="n">max_credit</span><span class="p">))</span>
    <span class="c1"># credit is limited to minimum of individuals&#39; earned income</span>
    <span class="n">c32880</span> <span class="o">=</span> <span class="n">earned_p</span>  <span class="c1"># earned income of taxpayer</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">c32890</span> <span class="o">=</span> <span class="n">earned_s</span>  <span class="c1"># earned income of spouse when present</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c32890</span> <span class="o">=</span> <span class="n">earned_p</span>
    <span class="n">c33000</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c32800</span><span class="p">,</span> <span class="n">c32880</span><span class="p">,</span> <span class="n">c32890</span><span class="p">))</span>
    <span class="c1"># credit rate is limited at high AGI</span>
    <span class="n">crate</span> <span class="o">=</span> <span class="n">CDCC_po1_rate_max</span>
    <span class="n">ps1</span> <span class="o">=</span> <span class="n">CDCC_ps1</span>
    <span class="k">if</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">ps1</span><span class="p">:</span>
        <span class="c1"># ... first phase-down from CDCC_po1_rate_max to CDCC_po1_rate_min</span>
        <span class="n">steps_fractional</span> <span class="o">=</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">ps1</span><span class="p">)</span> <span class="o">/</span> <span class="n">CDCC_po1_step_size</span>
        <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">steps_fractional</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">steps_fractional</span>
        <span class="n">crate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">CDCC_po1_rate_min</span><span class="p">,</span>
            <span class="n">CDCC_po1_rate_max</span> <span class="o">-</span> <span class="n">steps</span> <span class="o">*</span> <span class="n">CDCC_po_rate_per_step</span>
        <span class="p">)</span>
        <span class="c1"># ... second phase-down from CDCC_po1_rate_min to CDCC_po2_rate_min</span>
        <span class="n">ps2</span> <span class="o">=</span> <span class="n">CDCC_ps2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">ps2</span> <span class="o">&gt;=</span> <span class="n">ps1</span><span class="p">,</span> <span class="s1">&#39;CDCC_ps2 must be no less than CDCC_ps1&#39;</span>
        <span class="k">if</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">ps2</span><span class="p">:</span>
            <span class="n">steps_fractional</span> <span class="o">=</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">ps2</span><span class="p">)</span> <span class="o">/</span> <span class="n">CDCC_po2_step_size</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">steps_fractional</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="n">steps_fractional</span>
            <span class="n">crate</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">CDCC_po2_rate_min</span><span class="p">,</span>
                <span class="n">CDCC_po1_rate_min</span> <span class="o">-</span> <span class="n">steps</span> <span class="o">*</span> <span class="n">CDCC_po_rate_per_step</span>
            <span class="p">)</span>
    <span class="n">c33200</span> <span class="o">=</span> <span class="n">c33000</span> <span class="o">*</span> <span class="n">crate</span>
    <span class="c1"># credit is limited by tax liability if not refundable</span>
    <span class="k">if</span> <span class="n">CDCC_refundable</span><span class="p">:</span>
        <span class="n">c07180</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">CDCC_refund</span> <span class="o">=</span> <span class="n">c33200</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c07180</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c05800</span> <span class="o">-</span> <span class="n">e07300</span><span class="p">),</span> <span class="n">c33200</span><span class="p">)</span>
        <span class="n">CDCC_refund</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c32800</span><span class="p">,</span> <span class="n">c07180</span><span class="p">,</span> <span class="n">CDCC_refund</span><span class="p">)</span>


<div class="viewcode-block" id="EITCamount">
<a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.EITCamount">[docs]</a>
<span class="nd">@JIT</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">EITCamount</span><span class="p">(</span><span class="n">basic_frac</span><span class="p">,</span> <span class="n">phasein_rate</span><span class="p">,</span> <span class="n">earnings</span><span class="p">,</span> <span class="n">max_amount</span><span class="p">,</span>
               <span class="n">phaseout_start</span><span class="p">,</span> <span class="n">agi</span><span class="p">,</span> <span class="n">phaseout_rate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns EITC amount given specified parameters.</span>
<span class="sd">    English parameter names are used in this function because the</span>
<span class="sd">    EITC formula is not available on IRS forms or in IRS instructions;</span>
<span class="sd">    the extensive IRS EITC look-up table does not reveal the formula.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    basic_frac: float</span>
<span class="sd">        Fraction of maximum earned income credit paid at zero earnings</span>
<span class="sd">    phasein_rate: float</span>
<span class="sd">        Earned income credit phasein rate</span>
<span class="sd">    earnings: float</span>
<span class="sd">        Earned income for filing unit</span>
<span class="sd">    max_amount: float</span>
<span class="sd">        Maximum earned income credit</span>
<span class="sd">    phaseout_start: float</span>
<span class="sd">        Earned income credit phaseout start AGI</span>
<span class="sd">    agi: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    phaseout_rate: float</span>
<span class="sd">        Earned income credit phaseout rate</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    eitc: float</span>
<span class="sd">        Earned Income Credit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate qualified business income de</span>
    <span class="n">eitc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">basic_frac</span> <span class="o">*</span> <span class="n">max_amount</span> <span class="o">+</span>
                <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">basic_frac</span><span class="p">)</span> <span class="o">*</span> <span class="n">phasein_rate</span> <span class="o">*</span> <span class="n">earnings</span><span class="p">),</span> <span class="n">max_amount</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">earnings</span> <span class="o">&gt;</span> <span class="n">phaseout_start</span> <span class="ow">or</span> <span class="n">agi</span> <span class="o">&gt;</span> <span class="n">phaseout_start</span><span class="p">:</span>
        <span class="n">eitcx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">max_amount</span> <span class="o">-</span> <span class="n">phaseout_rate</span> <span class="o">*</span>
                         <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">earnings</span><span class="p">,</span> <span class="n">agi</span><span class="p">)</span> <span class="o">-</span> <span class="n">phaseout_start</span><span class="p">)))</span>
        <span class="n">eitc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">eitc</span><span class="p">,</span> <span class="n">eitcx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eitc</span></div>



<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">EITC</span><span class="p">(</span><span class="n">MARS</span><span class="p">,</span> <span class="n">DSI</span><span class="p">,</span> <span class="n">EIC</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">e00300</span><span class="p">,</span> <span class="n">e00400</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span> <span class="n">c01000</span><span class="p">,</span>
         <span class="n">e02000</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span>
         <span class="n">EITC_ps</span><span class="p">,</span> <span class="n">EITC_MinEligAge</span><span class="p">,</span> <span class="n">EITC_MaxEligAge</span><span class="p">,</span> <span class="n">EITC_ps_addon_MarriedJ</span><span class="p">,</span>
         <span class="n">EITC_rt</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">,</span> <span class="n">EITC_basic_frac</span><span class="p">,</span>
         <span class="n">EITC_InvestIncome_c</span><span class="p">,</span> <span class="n">EITC_excess_InvestIncome_rt</span><span class="p">,</span>
         <span class="n">EITC_indiv</span><span class="p">,</span> <span class="n">EITC_sep_filers_elig</span><span class="p">,</span> <span class="n">c59660</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes EITC amount, c59660.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    DSI: int</span>
<span class="sd">        1 if claimed as dependent on another return, otherwise 0</span>
<span class="sd">    EIC: int</span>
<span class="sd">        Number of EIC qualifying children</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    e00300: float</span>
<span class="sd">        Taxable interest income</span>
<span class="sd">    e00400: float</span>
<span class="sd">        Tax exempt interest income</span>
<span class="sd">    e00600: float</span>
<span class="sd">        Ordinary dividends included in AGI</span>
<span class="sd">    c01000: float</span>
<span class="sd">        Limitation on capital losses</span>
<span class="sd">    e02000: float</span>
<span class="sd">        Schedule E total rental, royalty, partnership, S-corporation,</span>
<span class="sd">        etc, income/loss</span>
<span class="sd">    e26270: float</span>
<span class="sd">        Schedule E combined partnership and S-corporation net income/loss</span>
<span class="sd">    age_head: int</span>
<span class="sd">        Age in years of taxpayer (primary adult)</span>
<span class="sd">    age_spouse: int</span>
<span class="sd">        Age in years of spouse (secondary adult, if present)</span>
<span class="sd">    earned: float</span>
<span class="sd">        Earned income for filing unit</span>
<span class="sd">    earned_p: float</span>
<span class="sd">        Earned income for taxpayer</span>
<span class="sd">    earned_s: float</span>
<span class="sd">        Earned income for spouse</span>
<span class="sd">    EITC_ps: list</span>
<span class="sd">        Earned income credit phaseout start AGI</span>
<span class="sd">    EITC_MinEligAge: int</span>
<span class="sd">        Minimum age for childless EITC eligibility</span>
<span class="sd">    EITC_MaxEligAge: int</span>
<span class="sd">        Maximum age for childless EITC eligibility</span>
<span class="sd">    EITC_ps_addon_MarriedJ: list</span>
<span class="sd">        Extra earned income credit phaseout start AGI for</span>
<span class="sd">        married filling jointly</span>
<span class="sd">    EITC_rt: list</span>
<span class="sd">        Earned income credit phasein rate</span>
<span class="sd">    EITC_c: list</span>
<span class="sd">        Maximum earned income credit</span>
<span class="sd">    EITC_prt: list</span>
<span class="sd">        Earned income credit phaseout rate</span>
<span class="sd">    EITC_basic_frac: float</span>
<span class="sd">        Fraction of maximum earned income credit paid at zero earnings</span>
<span class="sd">    EITC_InvestIncome_c: float</span>
<span class="sd">        Maximum investment income before EITC reduction</span>
<span class="sd">    EITC_excess_InvestIncome_rt: float</span>
<span class="sd">        Rate of EITC reduction when investemtn income exceeds ceiling</span>
<span class="sd">    EITC_indiv: bool</span>
<span class="sd">        EITC is computed for each spouse based in individual earnings</span>
<span class="sd">    EITC_sep_filers_elig: bool</span>
<span class="sd">        Separate filers are eligible for the EITC</span>
<span class="sd">    c59660: float</span>
<span class="sd">        EITC amount</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c59660: float</span>
<span class="sd">        EITC amount</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">eitc</span> <span class="o">=</span> <span class="n">EITCamount</span><span class="p">(</span><span class="n">EITC_basic_frac</span><span class="p">,</span>
                          <span class="n">EITC_rt</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">earned</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span>
                          <span class="n">EITC_ps</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">[</span><span class="n">EIC</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">EIC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># enforce age eligibility rule for those with no EITC-eligible</span>
            <span class="c1"># kids assuming that an unknown age_* value implies EITC age</span>
            <span class="c1"># eligibility</span>
            <span class="n">h_age_elig</span> <span class="o">=</span> <span class="n">EITC_MinEligAge</span> <span class="o">&lt;=</span> <span class="n">age_head</span> <span class="o">&lt;=</span> <span class="n">EITC_MaxEligAge</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">age_head</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h_age_elig</span><span class="p">):</span>
                <span class="n">c59660</span> <span class="o">=</span> <span class="n">eitc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c59660</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if EIC != 0</span>
            <span class="n">c59660</span> <span class="o">=</span> <span class="n">eitc</span>

    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">po_start</span> <span class="o">=</span> <span class="n">EITC_ps</span><span class="p">[</span><span class="n">EIC</span><span class="p">]</span> <span class="o">+</span> <span class="n">EITC_ps_addon_MarriedJ</span><span class="p">[</span><span class="n">EIC</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">EITC_indiv</span><span class="p">:</span>
            <span class="c1"># filing unit EITC rather than individual EITC</span>
            <span class="n">eitc</span> <span class="o">=</span> <span class="n">EITCamount</span><span class="p">(</span><span class="n">EITC_basic_frac</span><span class="p">,</span>
                              <span class="n">EITC_rt</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">earned</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span>
                              <span class="n">po_start</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">[</span><span class="n">EIC</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">EITC_indiv</span><span class="p">:</span>
            <span class="c1"># individual EITC rather than a filing-unit EITC</span>
            <span class="n">eitc_p</span> <span class="o">=</span> <span class="n">EITCamount</span><span class="p">(</span><span class="n">EITC_basic_frac</span><span class="p">,</span>
                                <span class="n">EITC_rt</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span>
                                <span class="n">po_start</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">[</span><span class="n">EIC</span><span class="p">])</span>
            <span class="n">eitc_s</span> <span class="o">=</span> <span class="n">EITCamount</span><span class="p">(</span><span class="n">EITC_basic_frac</span><span class="p">,</span>
                                <span class="n">EITC_rt</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">earned_s</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span>
                                <span class="n">po_start</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">[</span><span class="n">EIC</span><span class="p">])</span>
            <span class="n">eitc</span> <span class="o">=</span> <span class="n">eitc_p</span> <span class="o">+</span> <span class="n">eitc_s</span>

        <span class="k">if</span> <span class="n">EIC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">h_age_elig</span> <span class="o">=</span> <span class="n">EITC_MinEligAge</span> <span class="o">&lt;=</span> <span class="n">age_head</span> <span class="o">&lt;=</span> <span class="n">EITC_MaxEligAge</span>
            <span class="n">s_age_elig</span> <span class="o">=</span> <span class="n">EITC_MinEligAge</span> <span class="o">&lt;=</span> <span class="n">age_spouse</span> <span class="o">&lt;=</span> <span class="n">EITC_MaxEligAge</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">age_head</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">age_spouse</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h_age_elig</span> <span class="ow">or</span> <span class="n">s_age_elig</span><span class="p">):</span>
                <span class="n">c59660</span> <span class="o">=</span> <span class="n">eitc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c59660</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c59660</span> <span class="o">=</span> <span class="n">eitc</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">EITC_sep_filers_elig</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DSI</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">c59660</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># reduce positive EITC if investment income exceeds ceiling</span>
    <span class="k">if</span> <span class="n">c59660</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">invinc</span> <span class="o">=</span> <span class="p">(</span><span class="n">e00400</span> <span class="o">+</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span>
                  <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c01000</span><span class="p">)</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">e02000</span> <span class="o">-</span> <span class="n">e26270</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">invinc</span> <span class="o">&gt;</span> <span class="n">EITC_InvestIncome_c</span><span class="p">:</span>
            <span class="n">eitc</span> <span class="o">=</span> <span class="p">(</span><span class="n">c59660</span> <span class="o">-</span> <span class="n">EITC_excess_InvestIncome_rt</span> <span class="o">*</span>
                    <span class="p">(</span><span class="n">invinc</span> <span class="o">-</span> <span class="n">EITC_InvestIncome_c</span><span class="p">))</span>
            <span class="n">c59660</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">eitc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c59660</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">RefundablePayrollTaxCredit</span><span class="p">(</span><span class="n">was_plus_sey_p</span><span class="p">,</span> <span class="n">was_plus_sey_s</span><span class="p">,</span>
                               <span class="n">RPTC_c</span><span class="p">,</span> <span class="n">RPTC_rt</span><span class="p">,</span>
                               <span class="n">rptc_p</span><span class="p">,</span> <span class="n">rptc_s</span><span class="p">,</span> <span class="n">rptc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes refundable payroll tax credit amounts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    was_plus_sey_p: float</span>
<span class="sd">        Wage and salary income plus taxable self employment income for taxpayer</span>
<span class="sd">    was_plus_sey_s: float</span>
<span class="sd">        Wage and salary income plus taxable self employment income for spouse</span>
<span class="sd">    RPTC_c: float</span>
<span class="sd">        Maximum refundable payroll tax credit</span>
<span class="sd">    RPTC_rt: float</span>
<span class="sd">        Refundable payroll tax credit phasein rate</span>
<span class="sd">    rptc_p: float</span>
<span class="sd">        Refundable Payroll Tax Credit for taxpayer</span>
<span class="sd">    rptc_s: float</span>
<span class="sd">        Refundable Payroll Tax Credit for spouse</span>
<span class="sd">    rptc: float</span>
<span class="sd">        Refundable Payroll Tax Credit for filing unit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rptc_p: float</span>
<span class="sd">        Refundable Payroll Tax Credit for taxpayer</span>
<span class="sd">    rptc_s: float</span>
<span class="sd">        Refundable Payroll Tax Credit for spouse</span>
<span class="sd">    rptc: float</span>
<span class="sd">        Refundable Payroll Tax Credit for filing unit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rptc_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">was_plus_sey_p</span> <span class="o">*</span> <span class="n">RPTC_rt</span><span class="p">,</span> <span class="n">RPTC_c</span><span class="p">)</span>
    <span class="n">rptc_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">was_plus_sey_s</span> <span class="o">*</span> <span class="n">RPTC_rt</span><span class="p">,</span> <span class="n">RPTC_c</span><span class="p">)</span>
    <span class="n">rptc</span> <span class="o">=</span> <span class="n">rptc_p</span> <span class="o">+</span> <span class="n">rptc_s</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rptc_p</span><span class="p">,</span> <span class="n">rptc_s</span><span class="p">,</span> <span class="n">rptc</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ChildDepTaxCredit</span><span class="p">(</span><span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">nu18</span><span class="p">,</span> <span class="n">n24</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span>
                      <span class="n">c05800</span><span class="p">,</span> <span class="n">e07260</span><span class="p">,</span> <span class="n">CR_ResidentialEnergy_hc</span><span class="p">,</span>
                      <span class="n">e07300</span><span class="p">,</span> <span class="n">CR_ForeignTax_hc</span><span class="p">,</span>
                      <span class="n">c07180</span><span class="p">,</span>
                      <span class="n">c07230</span><span class="p">,</span>
                      <span class="n">e07240</span><span class="p">,</span> <span class="n">CR_RetirementSavings_hc</span><span class="p">,</span>
                      <span class="n">c07200</span><span class="p">,</span>
                      <span class="n">CTC_c</span><span class="p">,</span> <span class="n">CTC_ps</span><span class="p">,</span> <span class="n">CTC_prt</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">ODC_c</span><span class="p">,</span>
                      <span class="n">CTC_c_under6_bonus</span><span class="p">,</span> <span class="n">nu06</span><span class="p">,</span>
                      <span class="n">CTC_is_refundable</span><span class="p">,</span> <span class="n">CTC_include17</span><span class="p">,</span>
                      <span class="n">c07220</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span> <span class="n">codtc_limited</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes amounts on &quot;Child Tax Credit and Credit for Other Dependents</span>
<span class="sd">    Worksheet&quot; in 2018 Publication 972, which pertain to these two</span>
<span class="sd">    nonrefundable tax credits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n24: int</span>
<span class="sd">        Number of children who are Child-Tax-Credit eligible, one condition</span>
<span class="sd">        for which is being under age 17</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    XTOT: int</span>
<span class="sd">        Total number of exemptions for filing unit</span>
<span class="sd">    num: int</span>
<span class="sd">        2 when MARS is 2 (married filing jointly), otherwise 1</span>
<span class="sd">    c05800: float</span>
<span class="sd">        Total (regular + AMT) income tax liability before credits</span>
<span class="sd">    e07260: float</span>
<span class="sd">        Residential energy credit from Form 5695</span>
<span class="sd">    CR_ResidentialEnergy_hc: float</span>
<span class="sd">        Credit for residential energy haircut</span>
<span class="sd">    e07300: float</span>
<span class="sd">        Foreign tax credit from Form 1116</span>
<span class="sd">    CR_ForeignTax_hc: float</span>
<span class="sd">        Credit for foreign tax credit</span>
<span class="sd">    c07180: float</span>
<span class="sd">        Credit for child and dependent care expenses from Form 2441</span>
<span class="sd">    c07230: float</span>
<span class="sd">        Education tax credits non-refundable amount from Form 8863</span>
<span class="sd">    e07240: float</span>
<span class="sd">        Retirement savings contributions credit from Form 8880</span>
<span class="sd">    CR_RetirementSavings_hc: float</span>
<span class="sd">        Credit for retirement savings haircut</span>
<span class="sd">    c07200: float</span>
<span class="sd">        Schedule R credit for the elderly and the disabled</span>
<span class="sd">    CTC_c: float</span>
<span class="sd">        Maximum nonrefundable child tax credit per child</span>
<span class="sd">    CTC_ps: list</span>
<span class="sd">        Child tax credit phaseout MAGI start</span>
<span class="sd">    CTC_prt: float</span>
<span class="sd">        Child and dependent tax credit phaseout rate</span>
<span class="sd">    exact: int</span>
<span class="sd">        Whether or not to do rounding of phaseout fraction</span>
<span class="sd">    ODC_c: float</span>
<span class="sd">        Maximum nonrefundable other-dependent credit</span>
<span class="sd">    CTC_c_under6_bonus: float</span>
<span class="sd">        Bonus child tax credit maximum for qualifying children under six</span>
<span class="sd">    nu06: int</span>
<span class="sd">        Number of dependents under 6 years old</span>
<span class="sd">    c07220: float</span>
<span class="sd">        Child tax credit (adjusted) from Form 8812</span>
<span class="sd">    odc: float</span>
<span class="sd">        Other Dependent Credit</span>
<span class="sd">    codtc_limited: float</span>
<span class="sd">        Maximum of 0 and line 10 minus line 16</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c07220: float</span>
<span class="sd">        Child tax credit (adjusted) from Form 8812</span>
<span class="sd">    odc: float</span>
<span class="sd">        Other Dependent Credit</span>
<span class="sd">    codtc_limited: float</span>
<span class="sd">        Maximum of 0 and line 10 minus line 16</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Worksheet Part 1</span>
    <span class="k">if</span> <span class="n">CTC_include17</span><span class="p">:</span>
        <span class="n">tu18</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">age_head</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>   <span class="c1"># taxpayer is under age 18</span>
        <span class="n">su18</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>  <span class="c1"># spouse is under age 18</span>
        <span class="n">childnum</span> <span class="o">=</span> <span class="n">n24</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nu18</span> <span class="o">-</span> <span class="n">tu18</span> <span class="o">-</span> <span class="n">su18</span> <span class="o">-</span> <span class="n">n24</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">childnum</span> <span class="o">=</span> <span class="n">n24</span>
    <span class="n">line1</span> <span class="o">=</span> <span class="n">CTC_c</span> <span class="o">*</span> <span class="n">childnum</span> <span class="o">+</span> <span class="n">CTC_c_under6_bonus</span> <span class="o">*</span> <span class="n">nu06</span>
    <span class="n">line2</span> <span class="o">=</span> <span class="n">ODC_c</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">XTOT</span> <span class="o">-</span> <span class="n">childnum</span> <span class="o">-</span> <span class="n">num</span><span class="p">)</span>
    <span class="n">line3</span> <span class="o">=</span> <span class="n">line1</span> <span class="o">+</span> <span class="n">line2</span>
    <span class="n">modAGI</span> <span class="o">=</span> <span class="n">c00100</span>  <span class="c1"># no foreign earned income exclusion to add to AGI (line6)</span>
    <span class="k">if</span> <span class="n">line3</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">modAGI</span> <span class="o">&gt;</span> <span class="n">CTC_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">modAGI</span> <span class="o">-</span> <span class="n">CTC_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">excess</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">)</span>
        <span class="n">line10</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line3</span> <span class="o">-</span> <span class="n">CTC_prt</span> <span class="o">*</span> <span class="n">excess</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line10</span> <span class="o">=</span> <span class="n">line3</span>
    <span class="k">if</span> <span class="n">line10</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="c1"># Worksheet Part 2</span>
        <span class="n">line11</span> <span class="o">=</span> <span class="n">c05800</span>
        <span class="n">line12</span> <span class="o">=</span> <span class="p">(</span><span class="n">e07260</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_ResidentialEnergy_hc</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">e07300</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_ForeignTax_hc</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">c07180</span> <span class="o">+</span>  <span class="c1"># child &amp; dependent care expense credit</span>
                  <span class="n">c07230</span> <span class="o">+</span>  <span class="c1"># education credit</span>
                  <span class="n">e07240</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_RetirementSavings_hc</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">c07200</span><span class="p">)</span>  <span class="c1"># Schedule R credit</span>
        <span class="n">line13</span> <span class="o">=</span> <span class="n">line11</span> <span class="o">-</span> <span class="n">line12</span>
        <span class="n">line14</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">line15</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line13</span> <span class="o">-</span> <span class="n">line14</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CTC_is_refundable</span><span class="p">:</span>
            <span class="n">c07220</span> <span class="o">=</span> <span class="n">line10</span> <span class="o">*</span> <span class="n">line1</span> <span class="o">/</span> <span class="n">line3</span>
            <span class="n">odc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line10</span> <span class="o">-</span> <span class="n">c07220</span><span class="p">)</span>
            <span class="n">codtc_limited</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line10</span> <span class="o">-</span> <span class="n">c07220</span> <span class="o">-</span> <span class="n">odc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line16</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line10</span><span class="p">,</span> <span class="n">line15</span><span class="p">)</span>  <span class="c1"># credit is capped by tax liability</span>
            <span class="c1"># separate the CTC and ODTC amounts</span>
            <span class="n">c07220</span> <span class="o">=</span> <span class="n">line16</span> <span class="o">*</span> <span class="n">line1</span> <span class="o">/</span> <span class="n">line3</span>
            <span class="n">odc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line16</span> <span class="o">-</span> <span class="n">c07220</span><span class="p">)</span>
            <span class="c1"># compute codtc_limited for use in AdditionalCTC function</span>
            <span class="n">codtc_limited</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line10</span> <span class="o">-</span> <span class="n">line16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line16</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">c07220</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">odc</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">codtc_limited</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c07220</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span> <span class="n">codtc_limited</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">PersonalTaxCredit</span><span class="p">(</span><span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">,</span> <span class="n">nu18</span><span class="p">,</span>
                      <span class="n">II_credit</span><span class="p">,</span> <span class="n">II_credit_ps</span><span class="p">,</span> <span class="n">II_credit_prt</span><span class="p">,</span>
                      <span class="n">II_credit_nr</span><span class="p">,</span> <span class="n">II_credit_nr_ps</span><span class="p">,</span> <span class="n">II_credit_nr_prt</span><span class="p">,</span>
                      <span class="n">RRC_c</span><span class="p">,</span> <span class="n">RRC_ps</span><span class="p">,</span> <span class="n">RRC_pe</span><span class="p">,</span> <span class="n">RRC_prt</span><span class="p">,</span> <span class="n">RRC_c_kids</span><span class="p">,</span> <span class="n">RRC_c_unit</span><span class="p">,</span>
                      <span class="n">personal_refundable_credit</span><span class="p">,</span>
                      <span class="n">personal_nonrefundable_credit</span><span class="p">,</span>
                      <span class="n">recovery_rebate_credit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes personal_refundable_credit and personal_nonrefundable_credit,</span>
<span class="sd">    neither of which are part of current-law policy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    XTOT: int</span>
<span class="sd">        Total number of exemptions for filing unit</span>
<span class="sd">    nu18: int</span>
<span class="sd">        Number of people under 18 years old in the filing unit</span>
<span class="sd">    II_credit: list</span>
<span class="sd">        Personal refundable credit maximum amount</span>
<span class="sd">    II_credit_ps: list</span>
<span class="sd">        Personal refundable credit phaseout start</span>
<span class="sd">    II_credit_prt: float</span>
<span class="sd">        Personal refundable credit phaseout rate</span>
<span class="sd">    II_credit_nr: list</span>
<span class="sd">        Personal nonrefundable credit maximum amount</span>
<span class="sd">    II_credit_nr_ps: list</span>
<span class="sd">        Personal nonrefundable credit phaseout start</span>
<span class="sd">    II_credit_nr_prt: float</span>
<span class="sd">        Personal nonrefundable credit phaseout rate</span>
<span class="sd">    RRC_c: float</span>
<span class="sd">        Maximum amount of Recovery Rebate Credit</span>
<span class="sd">    RRC_ps: list</span>
<span class="sd">        Recovery Rebate Credit phase out start</span>
<span class="sd">    RRC_pe: list</span>
<span class="sd">        Recovery Rebate Credit phase out end</span>
<span class="sd">    RRC_prt: float</span>
<span class="sd">        Recovery Rebate Credit phase out rate</span>
<span class="sd">    RRC_c_kids: float</span>
<span class="sd">        Credit amount per child as part of the Recovery Rebate Credit</span>
<span class="sd">    RRC_c_unit: list</span>
<span class="sd">        Maximum credit for filing unit as part of the Recovery Rebate Credit</span>
<span class="sd">    personal_refundable_credit: float</span>
<span class="sd">        Personal refundable credit</span>
<span class="sd">    personal_nonrefundable_credit: float</span>
<span class="sd">        Personal nonrefundable credit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    personal_refundable_credit: float</span>
<span class="sd">        Personal refundable credit</span>
<span class="sd">    personal_nonrefundable_credit: float</span>
<span class="sd">        Personal nonrefundable credit</span>
<span class="sd">    personal_rebate_credit: float</span>
<span class="sd">        Personal rebate credit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate personal refundable credit amount with phase-out</span>
    <span class="n">personal_refundable_credit</span> <span class="o">=</span> <span class="n">II_credit</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">II_credit_prt</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">II_credit_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">pout</span> <span class="o">=</span> <span class="n">II_credit_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">II_credit_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">fully_phasedout</span> <span class="o">=</span> <span class="n">personal_refundable_credit</span> <span class="o">-</span> <span class="n">pout</span>
        <span class="n">personal_refundable_credit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fully_phasedout</span><span class="p">)</span>
    <span class="c1"># calculate personal nonrefundable credit amount with phase-out</span>
    <span class="n">personal_nonrefundable_credit</span> <span class="o">=</span> <span class="n">II_credit_nr</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">II_credit_nr_prt</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">II_credit_nr_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">pout</span> <span class="o">=</span> <span class="n">II_credit_nr_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">II_credit_nr_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">fully_phasedout</span> <span class="o">=</span> <span class="n">personal_nonrefundable_credit</span> <span class="o">-</span> <span class="n">pout</span>
        <span class="n">personal_nonrefundable_credit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fully_phasedout</span><span class="p">)</span>
    <span class="c1"># calculate Recovery Rebate Credit from CARES Act 2020 and/or ARPA 2021</span>
    <span class="k">if</span> <span class="n">c00100</span> <span class="o">&lt;</span> <span class="n">RRC_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">recovery_rebate_credit</span> <span class="o">=</span> <span class="n">RRC_c</span> <span class="o">*</span> <span class="n">XTOT</span>
        <span class="n">recovery_rebate_credit</span> <span class="o">+=</span> <span class="n">RRC_c_unit</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">RRC_c_kids</span> <span class="o">*</span> <span class="n">nu18</span>
    <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">c00100</span> <span class="o">&lt;</span> <span class="n">RRC_pe</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">prt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">RRC_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span>
            <span class="p">(</span><span class="n">RRC_pe</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">RRC_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">recovery_rebate_credit</span> <span class="o">=</span> <span class="n">RRC_c</span> <span class="o">*</span> <span class="n">XTOT</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">recovery_rebate_credit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">RRC_c_unit</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">RRC_c_kids</span> <span class="o">*</span> <span class="n">nu18</span> <span class="o">-</span> <span class="n">RRC_prt</span> <span class="o">*</span>
            <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">RRC_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">personal_refundable_credit</span><span class="p">,</span> <span class="n">personal_nonrefundable_credit</span><span class="p">,</span>
            <span class="n">recovery_rebate_credit</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">AmOppCreditParts</span><span class="p">(</span><span class="n">exact</span><span class="p">,</span> <span class="n">e87521</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">CR_AmOppRefundable_hc</span><span class="p">,</span>
                     <span class="n">CR_AmOppNonRefundable_hc</span><span class="p">,</span> <span class="n">c10960</span><span class="p">,</span> <span class="n">c87668</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a phaseout to the Form 8863, line 1, American Opportunity Credit</span>
<span class="sd">    amount, e87521, and then applies the 0.4 refundable rate.</span>
<span class="sd">    Logic corresponds to Form 8863, Part I.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exact: int</span>
<span class="sd">        Whether or not to do rounding of phaseout fraction</span>
<span class="sd">    e87521: float</span>
<span class="sd">        Total tentative AmOppCredit amount for all students.</span>
<span class="sd">        From Form 8863, line 1.</span>
<span class="sd">    num: int</span>
<span class="sd">        2 when MARS is 2 (married filing jointly), otherwise 1</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    CR_AmOppRefundable_hc: float</span>
<span class="sd">        Refundable portion of the American Opportunity Credit haircut</span>
<span class="sd">    CR_AmOppNonRefundable_hc: float</span>
<span class="sd">        Nonrefundable portion of the American Opportunity Credit haircut</span>
<span class="sd">    c10960: float</span>
<span class="sd">        American Opportunity Credit refundable amount from Form 8863</span>
<span class="sd">    c87668: float</span>
<span class="sd">        American Opportunity Credit non-refundable amount from Form 8863</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c10960: float</span>
<span class="sd">        American Opportunity Credit refundable amount from Form 8863</span>
<span class="sd">    c87668: float</span>
<span class="sd">        American Opportunity Credit non-refundable amount from Form 8863</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Tax Law Paramters that are not parameterized:</span>
<span class="sd">        90000: American Opportunity phaseout income base</span>
<span class="sd">        10000: American Opportunity Credit phaseout income range length</span>
<span class="sd">        1/1000: American Opportunity Credit phaseout rate</span>
<span class="sd">        0.3: American Opportunity Credit refundable rate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">e87521</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">c87658</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">90000.</span> <span class="o">*</span> <span class="n">num</span> <span class="o">-</span> <span class="n">c00100</span><span class="p">)</span>
        <span class="n">c87660</span> <span class="o">=</span> <span class="mf">10000.</span> <span class="o">*</span> <span class="n">num</span>
        <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
            <span class="n">c87662</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">c87658</span> <span class="o">/</span> <span class="n">c87660</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c87662</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">c87658</span> <span class="o">/</span> <span class="n">c87660</span><span class="p">)</span>
        <span class="n">c87664</span> <span class="o">=</span> <span class="n">c87662</span> <span class="o">*</span> <span class="n">e87521</span> <span class="o">/</span> <span class="mf">1000.</span>
        <span class="n">c10960</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">c87664</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_AmOppRefundable_hc</span><span class="p">)</span>
        <span class="n">c87668</span> <span class="o">=</span> <span class="n">c87664</span> <span class="o">-</span> <span class="n">c10960</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_AmOppNonRefundable_hc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c10960</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">c87668</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c10960</span><span class="p">,</span> <span class="n">c87668</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">SchR</span><span class="p">(</span><span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span>
         <span class="n">c05800</span><span class="p">,</span> <span class="n">e07300</span><span class="p">,</span> <span class="n">c07180</span><span class="p">,</span> <span class="n">e02400</span><span class="p">,</span> <span class="n">c02500</span><span class="p">,</span> <span class="n">e01500</span><span class="p">,</span> <span class="n">e01700</span><span class="p">,</span> <span class="n">CR_SchR_hc</span><span class="p">,</span>
         <span class="n">c07200</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Schedule R credit for the elderly and the disabled, c07200.</span>

<span class="sd">    Note that no Schedule R policy parameters are inflation indexed.</span>

<span class="sd">    Note that all Schedule R policy parameters are hard-coded, and therefore,</span>
<span class="sd">    are not able to be changed using Policy class parameters.</span>

<span class="sd">    Note that the CR_SchR_hc policy parameter allows the user to eliminate</span>
<span class="sd">    or reduce total Schedule R credits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    age_head: int</span>
<span class="sd">        Age in years of taxpayer (primary adult)</span>
<span class="sd">    age_spouse: int</span>
<span class="sd">        Age in years of spouse (secondary adult, if present)</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    c05800: float</span>
<span class="sd">        Total (regular + AMT) income tax liability before credit</span>
<span class="sd">    e07300: float</span>
<span class="sd">        Foreign tax credit from Form 1116</span>
<span class="sd">    c07180: float</span>
<span class="sd">        Credit for child and dependent care expenses from Form 2441</span>
<span class="sd">    e02400: float</span>
<span class="sd">        Total social security (OASDI) benefits</span>
<span class="sd">    c02500: float</span>
<span class="sd">        Social security (OASDI) benefits included in AGI</span>
<span class="sd">    e01500: float</span>
<span class="sd">        Total pensions and annuities</span>
<span class="sd">    e01700: float</span>
<span class="sd">        Taxable pensions and annuities</span>
<span class="sd">    CR_SchR_hc: float</span>
<span class="sd">        Schedule R credit haircut</span>
<span class="sd">    c07200: float</span>
<span class="sd">        Schedule R credit for the elderly and the disabled</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c07200: float</span>
<span class="sd">        Schedule R credit for the elderly and the disabled</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="ow">or</span> <span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">):</span>
        <span class="c1"># calculate credit assuming nobody is disabled (so line12 = line10)</span>
        <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
                <span class="n">schr12</span> <span class="o">=</span> <span class="mf">7500.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">schr12</span> <span class="o">=</span> <span class="mf">5000.</span>
            <span class="n">schr15</span> <span class="o">=</span> <span class="mf">10000.</span>
        <span class="k">elif</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">schr12</span> <span class="o">=</span> <span class="mf">3750.</span>
            <span class="n">schr15</span> <span class="o">=</span> <span class="mf">5000.</span>
        <span class="k">elif</span> <span class="n">MARS</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">schr12</span> <span class="o">=</span> <span class="mf">5000.</span>
            <span class="n">schr15</span> <span class="o">=</span> <span class="mf">7500.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schr12</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">schr15</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1"># nontaxable portion of OASDI benefits, line 13a</span>
        <span class="n">schr13a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e02400</span> <span class="o">-</span> <span class="n">c02500</span><span class="p">)</span>
        <span class="c1"># nontaxable portion of pension benefits, line 13b</span>
        <span class="c1"># NOTE: the following approximation (required because of inadequate IRS</span>
        <span class="c1">#       data) will be accurate if all pensions are partially taxable</span>
        <span class="c1">#       or if all pensions are fully taxable.  But if a filing unit</span>
        <span class="c1">#       receives at least one partially taxable pension and at least</span>
        <span class="c1">#       one fully taxable pension, then the approximation in the</span>
        <span class="c1">#       following line is not exactly correct.</span>
        <span class="n">schr13b</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e01500</span> <span class="o">-</span> <span class="n">e01700</span><span class="p">)</span>
        <span class="n">schr13c</span> <span class="o">=</span> <span class="n">schr13a</span> <span class="o">+</span> <span class="n">schr13b</span>
        <span class="n">schr16</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">schr15</span><span class="p">)</span>
        <span class="n">schr17</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">schr16</span>
        <span class="n">schr18</span> <span class="o">=</span> <span class="n">schr13c</span> <span class="o">+</span> <span class="n">schr17</span>
        <span class="n">schr19</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">schr12</span> <span class="o">-</span> <span class="n">schr18</span><span class="p">)</span>
        <span class="n">schr20</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">schr19</span>
        <span class="n">schr21</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">c05800</span> <span class="o">-</span> <span class="n">e07300</span> <span class="o">-</span> <span class="n">c07180</span><span class="p">))</span>
        <span class="n">c07200</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">schr20</span><span class="p">,</span> <span class="n">schr21</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_SchR_hc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if not calculating Schedule R credit</span>
        <span class="n">c07200</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">c07200</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">EducationTaxCredit</span><span class="p">(</span><span class="n">exact</span><span class="p">,</span> <span class="n">e87530</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">c05800</span><span class="p">,</span>
                       <span class="n">e07300</span><span class="p">,</span> <span class="n">c07180</span><span class="p">,</span> <span class="n">c07200</span><span class="p">,</span> <span class="n">c87668</span><span class="p">,</span>
                       <span class="n">LLC_Expense_c</span><span class="p">,</span> <span class="n">ETC_pe_Single</span><span class="p">,</span> <span class="n">ETC_pe_Married</span><span class="p">,</span>
                       <span class="n">CR_Education_hc</span><span class="p">,</span>
                       <span class="n">c07230</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Education Tax Credits (Form 8863) nonrefundable amount, c07230.</span>
<span class="sd">    Logic corresponds to Form 8863, Part II.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exact: int</span>
<span class="sd">        Whether or not to do rounding of phaseout fraction</span>
<span class="sd">    e87530: float</span>
<span class="sd">        Adjusted qualified lifetime learning expenses for all students</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    c05800: float</span>
<span class="sd">        Total (regular + AMT) income tax liability before credits</span>
<span class="sd">    e07300: float</span>
<span class="sd">        Foreign tax credit from Form 1116</span>
<span class="sd">    c07180: float</span>
<span class="sd">        Credit for child and dependent care expenses from Form 2441</span>
<span class="sd">    c07200: float</span>
<span class="sd">        Schedule R credit for the elderly and the disabled</span>
<span class="sd">    c87668: float</span>
<span class="sd">        American Opportunity Credit non-refundalbe amount from Form 8863</span>
<span class="sd">    LLC_Expense_c: float</span>
<span class="sd">        Lifetime learning credit expense limit</span>
<span class="sd">    ETC_pe_Single: float</span>
<span class="sd">        Education tax credit phaseout ends (single)</span>
<span class="sd">    ETC_pe_Married: float</span>
<span class="sd">        Education tax credit phaseout ends (married)</span>
<span class="sd">    CR_Education_hc: float</span>
<span class="sd">        Education Credits haircut</span>
<span class="sd">    c07230: float</span>
<span class="sd">        Education tax credits non-refundable amount from Form 8863</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c07230: float</span>
<span class="sd">        Education tax credits non-refundable amount from Form 8863</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Tax Law Parameters that are not parameterized:</span>
<span class="sd">        0.2: Lifetime Learning Credit ratio against expense</span>
<span class="sd">        10000.0: AGI range bewteen ETC_pe_Single and single phase-out start;</span>
<span class="sd">                 twice this amount for ETC_pe_Married</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c87560</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">e87530</span><span class="p">,</span> <span class="n">LLC_Expense_c</span><span class="p">)</span>
    <span class="c1"># on the following credit phase-out law see:</span>
    <span class="c1"># https://www.law.cornell.edu/uscode/text/26/25A#d_1</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">c87570</span> <span class="o">=</span> <span class="n">ETC_pe_Married</span> <span class="o">*</span> <span class="mf">1000.</span>
        <span class="n">c87600</span> <span class="o">=</span> <span class="mf">20000.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c87570</span> <span class="o">=</span> <span class="n">ETC_pe_Single</span> <span class="o">*</span> <span class="mf">1000.</span>
        <span class="n">c87600</span> <span class="o">=</span> <span class="mf">10000.</span>
    <span class="n">c87590</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c87570</span> <span class="o">-</span> <span class="n">c00100</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
        <span class="n">c87610</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">c87590</span> <span class="o">/</span> <span class="n">c87600</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c87610</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">c87590</span> <span class="o">/</span> <span class="n">c87600</span><span class="p">)</span>
    <span class="n">c87620</span> <span class="o">=</span> <span class="n">c87560</span> <span class="o">*</span> <span class="n">c87610</span>
    <span class="n">xline4</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c05800</span> <span class="o">-</span> <span class="p">(</span><span class="n">e07300</span> <span class="o">+</span> <span class="n">c07180</span> <span class="o">+</span> <span class="n">c07200</span><span class="p">))</span>
    <span class="n">xline5</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c87620</span><span class="p">,</span> <span class="n">xline4</span><span class="p">)</span>
    <span class="n">xline9</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c05800</span> <span class="o">-</span> <span class="p">(</span><span class="n">e07300</span> <span class="o">+</span> <span class="n">c07180</span> <span class="o">+</span> <span class="n">c07200</span> <span class="o">+</span> <span class="n">xline5</span><span class="p">))</span>
    <span class="n">xline10</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c87668</span><span class="p">,</span> <span class="n">xline9</span><span class="p">)</span>
    <span class="n">c87680</span> <span class="o">=</span> <span class="n">xline5</span> <span class="o">+</span> <span class="n">xline10</span>
    <span class="n">c07230</span> <span class="o">=</span> <span class="n">c87680</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_Education_hc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c07230</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CharityCredit</span><span class="p">(</span><span class="n">e19800</span><span class="p">,</span> <span class="n">e20100</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">CR_Charity_rt</span><span class="p">,</span> <span class="n">CR_Charity_f</span><span class="p">,</span>
                  <span class="n">CR_Charity_frt</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">charity_credit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes nonrefundable charity credit, charity_credit.</span>
<span class="sd">    This credit is not part of current-law policy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    e19800: float</span>
<span class="sd">        Itemizable charitable giving for cash and check contributions</span>
<span class="sd">    e20100: float</span>
<span class="sd">        Itemizable charitable giving other than cash and check contributions</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    CR_Charity_rt: float</span>
<span class="sd">        Charity credit rate</span>
<span class="sd">    CR_Charity_f: list</span>
<span class="sd">        Charity credit floor</span>
<span class="sd">    CR_Charity_frt: float</span>
<span class="sd">        Charity credit floor rate</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    charity_credit: float</span>
<span class="sd">        Credit for charitable giving</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    charity_credit: float</span>
<span class="sd">        Credit for charitable giving</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_charity</span> <span class="o">=</span> <span class="n">e19800</span> <span class="o">+</span> <span class="n">e20100</span>
    <span class="n">floor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">CR_Charity_frt</span> <span class="o">*</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">CR_Charity_f</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">charity_cr_floored</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">total_charity</span> <span class="o">-</span> <span class="n">floor</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">charity_credit</span> <span class="o">=</span> <span class="n">CR_Charity_rt</span> <span class="o">*</span> <span class="p">(</span><span class="n">charity_cr_floored</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">charity_credit</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">NonrefundableCredits</span><span class="p">(</span><span class="n">c05800</span><span class="p">,</span> <span class="n">e07240</span><span class="p">,</span> <span class="n">e07260</span><span class="p">,</span> <span class="n">e07300</span><span class="p">,</span> <span class="n">e07400</span><span class="p">,</span>
                         <span class="n">e07600</span><span class="p">,</span> <span class="n">p08000</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span>
                         <span class="n">personal_nonrefundable_credit</span><span class="p">,</span>
                         <span class="n">CTC_is_refundable</span><span class="p">,</span>
                         <span class="n">CR_RetirementSavings_hc</span><span class="p">,</span> <span class="n">CR_ForeignTax_hc</span><span class="p">,</span>
                         <span class="n">CR_ResidentialEnergy_hc</span><span class="p">,</span> <span class="n">CR_GeneralBusiness_hc</span><span class="p">,</span>
                         <span class="n">CR_MinimumTax_hc</span><span class="p">,</span> <span class="n">CR_OtherCredits_hc</span><span class="p">,</span> <span class="n">charity_credit</span><span class="p">,</span>
                         <span class="n">c07180</span><span class="p">,</span> <span class="n">c07200</span><span class="p">,</span> <span class="n">c07220</span><span class="p">,</span> <span class="n">c07230</span><span class="p">,</span> <span class="n">c07240</span><span class="p">,</span>
                         <span class="n">c07260</span><span class="p">,</span> <span class="n">c07300</span><span class="p">,</span> <span class="n">c07400</span><span class="p">,</span> <span class="n">c07600</span><span class="p">,</span> <span class="n">c08000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NonRefundableCredits function sequentially limits credits to tax liability.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c05800: float</span>
<span class="sd">        Total (regular + AMT) income tax liability before credits</span>
<span class="sd">    e07240: float</span>
<span class="sd">        Retirement savings contributions credit from Form 8880</span>
<span class="sd">    e07260: float</span>
<span class="sd">        Residential energy credit from Form 5695</span>
<span class="sd">    e07300: float</span>
<span class="sd">        Foreign tax credit from Form 1116</span>
<span class="sd">    e07400: float</span>
<span class="sd">        General business credit from Form 3800</span>
<span class="sd">    e07600: float</span>
<span class="sd">        Prior year minimum tax credit from Form 8801</span>
<span class="sd">    p08000: float</span>
<span class="sd">        Other tax credits</span>
<span class="sd">    odc: float</span>
<span class="sd">        Other Dependent Credit</span>
<span class="sd">    personal_nonrefundable_credit: float</span>
<span class="sd">        Personal nonrefundable credit</span>
<span class="sd">    CTC_is_refundable: bool</span>
<span class="sd">        Whether the child tax credit is fully refundable</span>
<span class="sd">    CR_RetirementSavings_hc: float</span>
<span class="sd">        Credit for retirement savings haircut</span>
<span class="sd">    CR_ForeignTax_hc: float</span>
<span class="sd">        Credit for foreign tax credit</span>
<span class="sd">    CR_ResidentialEnergy_hc: float</span>
<span class="sd">        Credit for residential energy haircut</span>
<span class="sd">    CR_GeneralBusiness_hc: float</span>
<span class="sd">        Credit for general business haircut</span>
<span class="sd">    CR_MinimumTax_hc: float</span>
<span class="sd">        Credit for previous year minimum tax credit haircut</span>
<span class="sd">    CR_OtherCredits_hc: float</span>
<span class="sd">        Other Credit haircut</span>
<span class="sd">    charity_credit: float</span>
<span class="sd">        Credit for charitable giving</span>
<span class="sd">    c07180: float</span>
<span class="sd">        Credit for child and dependent care expenses from Form 2441</span>
<span class="sd">    c07200: float</span>
<span class="sd">        Schedule R credit for the elderly and the disabled</span>
<span class="sd">    c07220: float</span>
<span class="sd">        Child tax credit (adjusted) from From 8812</span>
<span class="sd">    c07230: float</span>
<span class="sd">        Education tax credits non-refundable amount from Form 8863</span>
<span class="sd">    c07240: float</span>
<span class="sd">        Retirement savings credit - Form 8880</span>
<span class="sd">    c07260: float</span>
<span class="sd">        Residential energy credit - Form 5695</span>
<span class="sd">    c07300: float</span>
<span class="sd">        Foreign tax credit - Form 1116</span>
<span class="sd">    c07400: float</span>
<span class="sd">        General business credit - Form 3800</span>
<span class="sd">    c07600: float</span>
<span class="sd">        Prior year minimum tax credit - Form 8801</span>
<span class="sd">    c08000: float</span>
<span class="sd">        Other credits</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c07180: float</span>
<span class="sd">        Credit for child and dependent care expenses from Form 2441</span>
<span class="sd">    c07200: float</span>
<span class="sd">        Schedule R credit for the elderly and the disabled</span>
<span class="sd">    c07220: float</span>
<span class="sd">        Child tax credit (adjusted) from From 8812</span>
<span class="sd">    c07230: float</span>
<span class="sd">        Education tax credits non-refundable amount from Form 8863</span>
<span class="sd">    c07240: float</span>
<span class="sd">        Retirement savings credit - Form 8880</span>
<span class="sd">    odc: float</span>
<span class="sd">        Other Dependent Credit</span>
<span class="sd">    c07260: float</span>
<span class="sd">        Residential energy credit - Form 5695</span>
<span class="sd">    c07300: float</span>
<span class="sd">        Foreign tax credit - Form 1116</span>
<span class="sd">    c07400: float</span>
<span class="sd">        General business credit - Form 3800</span>
<span class="sd">    c07600: float</span>
<span class="sd">        Prior year minimum tax credit - Form 8801</span>
<span class="sd">    c08000: float</span>
<span class="sd">        Other credits</span>
<span class="sd">    charity_credit: float</span>
<span class="sd">        Credit for charitable giving</span>
<span class="sd">    personal_nonrefundable_credit: float</span>
<span class="sd">        Personal nonrefundable credit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># limit tax credits to tax liability in order they are on 2015 1040 form</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">c05800</span>
    <span class="c1"># Foreign tax credit - Form 1116</span>
    <span class="n">c07300</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07300</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_ForeignTax_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07300</span>
    <span class="c1"># Child &amp; dependent care expense credit</span>
    <span class="n">c07180</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c07180</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07180</span>
    <span class="c1"># Education tax credit</span>
    <span class="n">c07230</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c07230</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07230</span>
    <span class="c1"># Retirement savings credit - Form 8880</span>
    <span class="n">c07240</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07240</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_RetirementSavings_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07240</span>
    <span class="c1"># Child tax credit</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">CTC_is_refundable</span><span class="p">:</span>
        <span class="n">c07220</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c07220</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
        <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07220</span>
        <span class="c1"># Other dependent credit</span>
        <span class="n">odc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">odc</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
        <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">odc</span>
    <span class="c1"># Residential energy credit - Form 5695</span>
    <span class="n">c07260</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07260</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_ResidentialEnergy_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07260</span>
    <span class="c1"># General business credit - Form 3800</span>
    <span class="n">c07400</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07400</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_GeneralBusiness_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07400</span>
    <span class="c1"># Prior year minimum tax credit - Form 8801</span>
    <span class="n">c07600</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07600</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_MinimumTax_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07600</span>
    <span class="c1"># Schedule R credit</span>
    <span class="n">c07200</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c07200</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07200</span>
    <span class="c1"># Other credits</span>
    <span class="n">c08000</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p08000</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_OtherCredits_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c08000</span>
    <span class="n">charity_credit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">charity_credit</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">charity_credit</span>
    <span class="c1"># Personal nonrefundable credit</span>
    <span class="n">personal_nonrefundable_credit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">personal_nonrefundable_credit</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">personal_nonrefundable_credit</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c07180</span><span class="p">,</span> <span class="n">c07200</span><span class="p">,</span> <span class="n">c07220</span><span class="p">,</span> <span class="n">c07230</span><span class="p">,</span> <span class="n">c07240</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span>
            <span class="n">c07260</span><span class="p">,</span> <span class="n">c07300</span><span class="p">,</span> <span class="n">c07400</span><span class="p">,</span> <span class="n">c07600</span><span class="p">,</span> <span class="n">c08000</span><span class="p">,</span> <span class="n">charity_credit</span><span class="p">,</span>
            <span class="n">personal_nonrefundable_credit</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">AdditionalCTC</span><span class="p">(</span><span class="n">codtc_limited</span><span class="p">,</span> <span class="n">ACTC_c</span><span class="p">,</span> <span class="n">n24</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span> <span class="n">ACTC_Income_thd</span><span class="p">,</span>
                  <span class="n">ACTC_rt</span><span class="p">,</span> <span class="n">nu06</span><span class="p">,</span> <span class="n">ACTC_rt_bonus_under6family</span><span class="p">,</span> <span class="n">ACTC_ChildNum</span><span class="p">,</span>
                  <span class="n">CTC_is_refundable</span><span class="p">,</span> <span class="n">CTC_include17</span><span class="p">,</span> <span class="n">CTC_c</span><span class="p">,</span>
                  <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">nu18</span><span class="p">,</span>
                  <span class="n">ptax_was</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span> <span class="n">e09800</span><span class="p">,</span> <span class="n">c59660</span><span class="p">,</span> <span class="n">e11200</span><span class="p">,</span>
                  <span class="n">c11070</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates refundable Additional Child Tax Credit (ACTC), c11070,</span>
<span class="sd">    following 2018 Form 8812 logic.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    codtc_limited: float</span>
<span class="sd">        Maximum of 0 and line 10 minus line 16</span>
<span class="sd">    ACTC_c: float</span>
<span class="sd">        Maximum refundable additional child tax credit</span>
<span class="sd">    n24: int</span>
<span class="sd">        Number of children who are Child-Tax-Credit eligible, one condition</span>
<span class="sd">        for which is being under age 17</span>
<span class="sd">    earned: float</span>
<span class="sd">        Earned income for filing unit</span>
<span class="sd">    ACTC_Income_thd: float</span>
<span class="sd">        Additional Child Tax Credit income threshold</span>
<span class="sd">    ACTC_rt: float</span>
<span class="sd">        Additional Child Tax Credit rate</span>
<span class="sd">    nu06: int</span>
<span class="sd">        Number of dependents under 6 years old</span>
<span class="sd">    ACTC_rt_bonus_under6family: float</span>
<span class="sd">        Bonus additional child tax credit rate for families with qualifying</span>
<span class="sd">        children under 6</span>
<span class="sd">    ACTC_ChildNum: float</span>
<span class="sd">        Additional Child Tax Credit minimum number of qualified children for</span>
<span class="sd">        different formula</span>
<span class="sd">    ptax_was: float</span>
<span class="sd">        Employee and employer OASDI plus HI FICA tax</span>
<span class="sd">    c03260: float</span>
<span class="sd">        Self-employment tax deduction (after haircut)</span>
<span class="sd">    e09800: float</span>
<span class="sd">        Unreported payroll taxes from Form 4137 or 8919</span>
<span class="sd">    c59660: float</span>
<span class="sd">        EITC amount</span>
<span class="sd">    e11200: float</span>
<span class="sd">        Excess payroll (FICA/RRTA) tax withheld</span>
<span class="sd">    c11070: float</span>
<span class="sd">        Child tax credit (refunded) from Form 8812</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c11070: float</span>
<span class="sd">        Child tax credit (refunded) from Form 8812</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Part I</span>
    <span class="n">line3</span> <span class="o">=</span> <span class="n">codtc_limited</span>

    <span class="k">if</span> <span class="n">CTC_is_refundable</span><span class="p">:</span>
        <span class="n">line4</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">CTC_include17</span><span class="p">:</span>
            <span class="n">tu18</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">age_head</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>   <span class="c1"># taxpayer is under age 18</span>
            <span class="n">su18</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>  <span class="c1"># spouse is under age 18</span>
            <span class="n">childnum</span> <span class="o">=</span> <span class="n">n24</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nu18</span> <span class="o">-</span> <span class="n">tu18</span> <span class="o">-</span> <span class="n">su18</span> <span class="o">-</span> <span class="n">n24</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">childnum</span> <span class="o">=</span> <span class="n">n24</span>
        <span class="n">line4</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ACTC_c</span><span class="p">,</span> <span class="n">CTC_c</span><span class="p">)</span> <span class="o">*</span> <span class="n">childnum</span>
    <span class="n">c11070</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># line15</span>
    <span class="k">if</span> <span class="n">line3</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">line4</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">line5</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line3</span><span class="p">,</span> <span class="n">line4</span><span class="p">)</span>
        <span class="n">line7</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">earned</span> <span class="o">-</span> <span class="n">ACTC_Income_thd</span><span class="p">)</span>
        <span class="c1"># accommodate ACTC rate bonus for families with children under 5</span>
        <span class="k">if</span> <span class="n">nu06</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ACTC_rate</span> <span class="o">=</span> <span class="n">ACTC_rt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ACTC_rate</span> <span class="o">=</span> <span class="n">ACTC_rt</span> <span class="o">+</span> <span class="n">ACTC_rt_bonus_under6family</span>
        <span class="n">line8</span> <span class="o">=</span> <span class="n">ACTC_rate</span> <span class="o">*</span> <span class="n">line7</span>
        <span class="k">if</span> <span class="n">childnum</span> <span class="o">&lt;</span> <span class="n">ACTC_ChildNum</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line8</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">c11070</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line5</span><span class="p">,</span> <span class="n">line8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if childnum &gt;= ACTC_ChildNum</span>
            <span class="k">if</span> <span class="n">line8</span> <span class="o">&gt;=</span> <span class="n">line5</span><span class="p">:</span>
                <span class="n">c11070</span> <span class="o">=</span> <span class="n">line5</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># complete Part II</span>
                <span class="n">line9</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ptax_was</span>
                <span class="n">line10</span> <span class="o">=</span> <span class="n">c03260</span> <span class="o">+</span> <span class="n">e09800</span>
                <span class="n">line11</span> <span class="o">=</span> <span class="n">line9</span> <span class="o">+</span> <span class="n">line10</span>
                <span class="n">line12</span> <span class="o">=</span> <span class="n">c59660</span> <span class="o">+</span> <span class="n">e11200</span>
                <span class="n">line13</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line11</span> <span class="o">-</span> <span class="n">line12</span><span class="p">)</span>
                <span class="n">line14</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line8</span><span class="p">,</span> <span class="n">line13</span><span class="p">)</span>
                <span class="n">c11070</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line5</span><span class="p">,</span> <span class="n">line14</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c11070</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">C1040</span><span class="p">(</span><span class="n">c05800</span><span class="p">,</span> <span class="n">c07180</span><span class="p">,</span> <span class="n">c07200</span><span class="p">,</span> <span class="n">c07220</span><span class="p">,</span> <span class="n">c07230</span><span class="p">,</span> <span class="n">c07240</span><span class="p">,</span> <span class="n">c07260</span><span class="p">,</span> <span class="n">c07300</span><span class="p">,</span>
          <span class="n">c07400</span><span class="p">,</span> <span class="n">c07600</span><span class="p">,</span> <span class="n">c08000</span><span class="p">,</span> <span class="n">e09700</span><span class="p">,</span> <span class="n">e09800</span><span class="p">,</span> <span class="n">e09900</span><span class="p">,</span> <span class="n">niit</span><span class="p">,</span> <span class="n">setax</span><span class="p">,</span>
          <span class="n">ptax_amc</span><span class="p">,</span> <span class="n">othertaxes</span><span class="p">,</span> <span class="n">c07100</span><span class="p">,</span> <span class="n">c09200</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span> <span class="n">charity_credit</span><span class="p">,</span>
          <span class="n">personal_nonrefundable_credit</span><span class="p">,</span>
          <span class="n">CTC_is_refundable</span><span class="p">,</span> <span class="n">ODC_is_refundable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes total used nonrefundable credits, c07100, othertaxes, and</span>
<span class="sd">    income tax before refundable credits, c09200.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c05800: float</span>
<span class="sd">        Total (regular + AMT) income tax liability before credits</span>
<span class="sd">    c07180: float</span>
<span class="sd">        Credit for child and dependent care expenses from Form 2441</span>
<span class="sd">    c07200: float</span>
<span class="sd">        Schedule R credit for the elderly and the disabled</span>
<span class="sd">    c07220: float</span>
<span class="sd">        Child tax credit (adjusted) from Form 8812</span>
<span class="sd">    c07230: float</span>
<span class="sd">        Education tax credit non-refundable amount from Form 8863</span>
<span class="sd">    c07240: float</span>
<span class="sd">        Retirement savings credit - Form 8880</span>
<span class="sd">    c07260: float</span>
<span class="sd">        Residential energy credit - Form 5695</span>
<span class="sd">    c07300: float</span>
<span class="sd">        Foreign tax credit - Form 1116</span>
<span class="sd">    c07400: float</span>
<span class="sd">        General business credit - Form 3800</span>
<span class="sd">    c07600: float</span>
<span class="sd">        Prior year minimum tax credit - Form 8801</span>
<span class="sd">    c08000: float</span>
<span class="sd">        Other credits</span>
<span class="sd">    e09700: float</span>
<span class="sd">        Recapture of Investment Credit</span>
<span class="sd">    e09800: float</span>
<span class="sd">        Unreported payroll taxes from Form 4137 or 8919</span>
<span class="sd">    e09900: float</span>
<span class="sd">        Penalty tax on qualified retirement plans</span>
<span class="sd">    niit: float</span>
<span class="sd">        Net Investment Income Tax from Form 8960</span>
<span class="sd">    setax: float</span>
<span class="sd">        Self-employment tax</span>
<span class="sd">    ptax_amc: float</span>
<span class="sd">        Additional Medicare tax</span>
<span class="sd">    othertaxes: float</span>
<span class="sd">        Sum of niit, setax, ptax_amc, e09700, e09800, and e09900</span>
<span class="sd">    c07100: float</span>
<span class="sd">        Total non-refundable credits used to reduce positive tax liability</span>
<span class="sd">    c09200: float</span>
<span class="sd">        Income tax liabilities (including othertaxes) after non-refundable</span>
<span class="sd">        credits are used, but before refundable credits are applied</span>
<span class="sd">    odc: float</span>
<span class="sd">        Other Dependent Credit</span>
<span class="sd">    charity_credit: float</span>
<span class="sd">        Credit for charitable giving</span>
<span class="sd">    personal_nonrefundable_credit: float</span>
<span class="sd">        Personal nonrefundable credit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c07100: float</span>
<span class="sd">        Total non-refundable credits used to reduce positive tax liability</span>
<span class="sd">    othertaxes: float</span>
<span class="sd">        Sum of niit, e09700, e09800, and e09900</span>
<span class="sd">    c09200: float</span>
<span class="sd">        Income tax liabilities (including othertaxes) after non-refundable</span>
<span class="sd">        credits are used, but before refundable credits are applied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># total used nonrefundable credits (as computed in NonrefundableCredits)</span>
    <span class="n">c07100</span> <span class="o">=</span> <span class="p">(</span><span class="n">c07180</span> <span class="o">+</span> <span class="n">c07200</span> <span class="o">+</span> <span class="n">c07600</span> <span class="o">+</span> <span class="n">c07300</span> <span class="o">+</span> <span class="n">c07400</span> <span class="o">+</span>
              <span class="n">c07220</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CTC_is_refundable</span><span class="p">)</span> <span class="o">+</span> <span class="n">c08000</span> <span class="o">+</span>
              <span class="n">c07230</span> <span class="o">+</span> <span class="n">c07240</span> <span class="o">+</span> <span class="n">c07260</span> <span class="o">+</span>
              <span class="n">odc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ODC_is_refundable</span><span class="p">)</span> <span class="o">+</span> <span class="n">charity_credit</span> <span class="o">+</span>
              <span class="n">personal_nonrefundable_credit</span><span class="p">)</span>
    <span class="c1"># tax after credits (2016 Form 1040, line 56)</span>
    <span class="n">tax_net_nonrefundable_credits</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c05800</span> <span class="o">-</span> <span class="n">c07100</span><span class="p">)</span>
    <span class="c1"># tax (including othertaxes) before refundable credits</span>
    <span class="n">othertaxes</span> <span class="o">=</span> <span class="n">e09700</span> <span class="o">+</span> <span class="n">e09800</span> <span class="o">+</span> <span class="n">e09900</span> <span class="o">+</span> <span class="n">niit</span> <span class="o">+</span> <span class="n">setax</span> <span class="o">+</span> <span class="n">ptax_amc</span>
    <span class="n">c09200</span> <span class="o">=</span> <span class="n">othertaxes</span> <span class="o">+</span> <span class="n">tax_net_nonrefundable_credits</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c07100</span><span class="p">,</span> <span class="n">othertaxes</span><span class="p">,</span> <span class="n">c09200</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CTC_new</span><span class="p">(</span><span class="n">CTC_new_c</span><span class="p">,</span> <span class="n">CTC_new_rt</span><span class="p">,</span> <span class="n">CTC_new_c_under6_bonus</span><span class="p">,</span>
            <span class="n">CTC_new_ps</span><span class="p">,</span> <span class="n">CTC_new_prt</span><span class="p">,</span> <span class="n">CTC_new_for_all</span><span class="p">,</span> <span class="n">CTC_include17</span><span class="p">,</span>
            <span class="n">CTC_new_refund_limited</span><span class="p">,</span> <span class="n">CTC_new_refund_limit_payroll_rt</span><span class="p">,</span>
            <span class="n">CTC_new_refund_limited_all_payroll</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span>
            <span class="n">n24</span><span class="p">,</span> <span class="n">nu06</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">nu18</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">ptax_oasdi</span><span class="p">,</span>
            <span class="n">c09200</span><span class="p">,</span> <span class="n">ctc_new</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes new refundable child tax credit using specified parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    CTC_new_c: float</span>
<span class="sd">        New refundable child tax credit maximum amount per child</span>
<span class="sd">    CTC_new_rt: float</span>
<span class="sd">        New refundalbe child tax credit amount phasein rate</span>
<span class="sd">    CTC_new_c_under6_bonus: float</span>
<span class="sd">        Bonus new refundable child tax credit maximum for qualifying</span>
<span class="sd">        children under six</span>
<span class="sd">    CTC_new_ps: list</span>
<span class="sd">        New refundable child tax credit phaseout starting AGI</span>
<span class="sd">    CTC_new_prt: float</span>
<span class="sd">        New refundable child tax credit amount phaseout rate</span>
<span class="sd">    CTC_new_for_all: bool</span>
<span class="sd">        Whether or not maximum amount of the new refundable child tax credit</span>
<span class="sd">        is available to all</span>
<span class="sd">    CTC_new_refund_limited: bool</span>
<span class="sd">        New child tax credit refund limited to a decimal fraction of</span>
<span class="sd">        payroll taxes</span>
<span class="sd">    CTC_new_refund_limit_payroll_rt: float</span>
<span class="sd">        New child tax credit refund limit rate (decimal fraction of</span>
<span class="sd">        payroll taxes)</span>
<span class="sd">    CTC_new_refund_limited_all_payroll: bool</span>
<span class="sd">        New child tax credit refund limit applies to all FICA taxes, not</span>
<span class="sd">        just OASDI</span>
<span class="sd">    payrolltax: float</span>
<span class="sd">        Total (employee + employer) payroll tax liability</span>
<span class="sd">    exact: int</span>
<span class="sd">        Whether or not exact phase-out calculation is being done</span>
<span class="sd">    n24: int</span>
<span class="sd">        Number of children who are Child-Tax-Credit eligible, one</span>
<span class="sd">        condition for which is being under age 17</span>
<span class="sd">    nu06: int</span>
<span class="sd">        Number of dependents under 6 years old</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    ptax_oasdi: float</span>
<span class="sd">        Employee and employer OASDI FICA tax plus self employment tax</span>
<span class="sd">        Excludes HI FICA so positive ptax_oasdi is less than ptax_was + setax</span>
<span class="sd">    c09200: float</span>
<span class="sd">        Income tax liabilities (including othertaxes) after non-refundable</span>
<span class="sd">        credits are used, but before refundable credits are applied</span>
<span class="sd">    ctc_new: float</span>
<span class="sd">        New refundable child tax credit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ctc_new: float</span>
<span class="sd">        New refundable child tax credit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">CTC_include17</span><span class="p">:</span>
        <span class="n">tu18</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">age_head</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>   <span class="c1"># taxpayer is under age 18</span>
        <span class="n">su18</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">)</span>  <span class="c1"># spouse is under age 18</span>
        <span class="n">childnum</span> <span class="o">=</span> <span class="n">n24</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nu18</span> <span class="o">-</span> <span class="n">tu18</span> <span class="o">-</span> <span class="n">su18</span> <span class="o">-</span> <span class="n">n24</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">childnum</span> <span class="o">=</span> <span class="n">n24</span>
    <span class="k">if</span> <span class="n">childnum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">posagi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">ctc_new</span> <span class="o">=</span> <span class="n">CTC_new_c</span> <span class="o">*</span> <span class="n">childnum</span> <span class="o">+</span> <span class="n">CTC_new_c_under6_bonus</span> <span class="o">*</span> <span class="n">nu06</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">CTC_new_for_all</span><span class="p">:</span>
            <span class="n">ctc_new</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CTC_new_rt</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">,</span> <span class="n">ctc_new</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">CTC_new_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">posagi</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">:</span>
            <span class="n">over</span> <span class="o">=</span> <span class="n">posagi</span> <span class="o">-</span> <span class="n">ymax</span>
            <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax form</span>
                <span class="n">excess</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">over</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1000.</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># smoothed calculation</span>
                <span class="n">excess</span> <span class="o">=</span> <span class="n">over</span>
            <span class="n">ctc_new_reduced</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ctc_new</span> <span class="o">-</span> <span class="n">CTC_new_prt</span> <span class="o">*</span> <span class="n">excess</span><span class="p">)</span>
            <span class="n">ctc_new</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ctc_new</span><span class="p">,</span> <span class="n">ctc_new_reduced</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctc_new</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">CTC_new_refund_limited</span><span class="p">:</span>
            <span class="n">refund_new</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ctc_new</span> <span class="o">-</span> <span class="n">c09200</span><span class="p">)</span>
            <span class="n">limit_new</span> <span class="o">=</span> <span class="n">CTC_new_refund_limit_payroll_rt</span> <span class="o">*</span> <span class="n">ptax_oasdi</span>
            <span class="k">if</span> <span class="n">CTC_new_refund_limited_all_payroll</span><span class="p">:</span>
                <span class="n">limit_new</span> <span class="o">=</span> <span class="n">CTC_new_refund_limit_payroll_rt</span> <span class="o">*</span> <span class="n">payrolltax</span>
            <span class="n">limited_new</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">refund_new</span> <span class="o">-</span> <span class="n">limit_new</span><span class="p">)</span>
            <span class="n">ctc_new</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ctc_new</span> <span class="o">-</span> <span class="n">limited_new</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctc_new</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">ctc_new</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">IITAX</span><span class="p">(</span><span class="n">c59660</span><span class="p">,</span> <span class="n">c11070</span><span class="p">,</span> <span class="n">c10960</span><span class="p">,</span> <span class="n">personal_refundable_credit</span><span class="p">,</span> <span class="n">ctc_new</span><span class="p">,</span> <span class="n">rptc</span><span class="p">,</span>
          <span class="n">c09200</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">,</span> <span class="n">CDCC_refund</span><span class="p">,</span> <span class="n">recovery_rebate_credit</span><span class="p">,</span>
          <span class="n">eitc</span><span class="p">,</span> <span class="n">c07220</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span> <span class="n">CTC_is_refundable</span><span class="p">,</span> <span class="n">ODC_is_refundable</span><span class="p">,</span> <span class="n">refund</span><span class="p">,</span>
          <span class="n">ctc_total</span><span class="p">,</span> <span class="n">ctc_refundable</span><span class="p">,</span> <span class="n">ctc_nonrefundable</span><span class="p">,</span> <span class="n">iitax</span><span class="p">,</span> <span class="n">combined</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes final taxes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c59660: float</span>
<span class="sd">        EITC amount</span>
<span class="sd">    c11070: float</span>
<span class="sd">        Child tax credit (refunded) from Form 8812</span>
<span class="sd">    c10960: float</span>
<span class="sd">        American Opportunity Credit refundable amount from Form 8863</span>
<span class="sd">    personal_refundable_credit: float</span>
<span class="sd">        Personal refundable credit</span>
<span class="sd">    ctc_new: float</span>
<span class="sd">        New refundable child tax credit</span>
<span class="sd">    rptc: float</span>
<span class="sd">        Refundable Payroll Tax Credit for filing unit</span>
<span class="sd">    c09200: float</span>
<span class="sd">        Income tax liabilities (including othertaxes) after non-refundable</span>
<span class="sd">        credits are used, but before refundable credits are applied</span>
<span class="sd">    payrolltax: float</span>
<span class="sd">        Total (employee + employer) payroll tax liability</span>
<span class="sd">    eitc: float</span>
<span class="sd">        Earned Income Credit</span>
<span class="sd">    refund: float</span>
<span class="sd">        Total refundable income tax credits</span>
<span class="sd">    ctc_total: float</span>
<span class="sd">        Total CTC amount (c07220 + c11070 + odc + ctc_new)</span>
<span class="sd">    ctc_refundable: float</span>
<span class="sd">        Portion of total CTC amount that is refundable</span>
<span class="sd">    iitax: float</span>
<span class="sd">        Total federal individual income tax liability</span>
<span class="sd">    combined: float</span>
<span class="sd">        Sum of iitax and payrolltax and lumpsum_tax</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    eitc: float</span>
<span class="sd">        Earned Income Credit</span>
<span class="sd">    refund: float</span>
<span class="sd">        Total refundable income tax credits</span>
<span class="sd">    ctc_total: float</span>
<span class="sd">        Total CTC amount (c07220 + c11070 + odc + ctc_new)</span>
<span class="sd">    ctc_refundable: float</span>
<span class="sd">        Portion of total CTC amount that is refundable</span>
<span class="sd">    ctc_nonrefundable: float</span>
<span class="sd">        Portion of total CTC amount that is nonrefundable</span>
<span class="sd">    iitax: float</span>
<span class="sd">        Total federal individual income tax liability</span>
<span class="sd">    combined: float</span>
<span class="sd">        Sum of iitax and payrolltax and lumpsum_tax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eitc</span> <span class="o">=</span> <span class="n">c59660</span>
    <span class="k">if</span> <span class="n">CTC_is_refundable</span><span class="p">:</span>
        <span class="n">ctc_refund</span> <span class="o">=</span> <span class="n">c07220</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctc_refund</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">ODC_is_refundable</span><span class="p">:</span>
        <span class="n">odc_refund</span> <span class="o">=</span> <span class="n">odc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">odc_refund</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">refund</span> <span class="o">=</span> <span class="p">(</span><span class="n">eitc</span> <span class="o">+</span> <span class="n">c11070</span> <span class="o">+</span> <span class="n">c10960</span> <span class="o">+</span> <span class="n">CDCC_refund</span> <span class="o">+</span> <span class="n">recovery_rebate_credit</span> <span class="o">+</span>
              <span class="n">personal_refundable_credit</span> <span class="o">+</span> <span class="n">ctc_new</span> <span class="o">+</span> <span class="n">rptc</span> <span class="o">+</span> <span class="n">ctc_refund</span> <span class="o">+</span>
              <span class="n">odc_refund</span><span class="p">)</span>
    <span class="n">ctc_total</span> <span class="o">=</span> <span class="n">c07220</span> <span class="o">+</span> <span class="n">c11070</span> <span class="o">+</span> <span class="n">odc</span> <span class="o">+</span> <span class="n">ctc_new</span>
    <span class="n">ctc_refundable</span> <span class="o">=</span> <span class="n">ctc_refund</span> <span class="o">+</span> <span class="n">c11070</span> <span class="o">+</span> <span class="n">odc_refund</span> <span class="o">+</span> <span class="n">ctc_new</span>
    <span class="n">ctc_nonrefundable</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ctc_total</span> <span class="o">-</span> <span class="n">ctc_refundable</span><span class="p">)</span>
    <span class="n">iitax</span> <span class="o">=</span> <span class="n">c09200</span> <span class="o">-</span> <span class="n">refund</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">iitax</span> <span class="o">+</span> <span class="n">payrolltax</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">eitc</span><span class="p">,</span> <span class="n">refund</span><span class="p">,</span> <span class="n">ctc_total</span><span class="p">,</span> <span class="n">ctc_refundable</span><span class="p">,</span> <span class="n">ctc_nonrefundable</span><span class="p">,</span>
            <span class="n">iitax</span><span class="p">,</span> <span class="n">combined</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">FairShareTax</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span> <span class="n">setax</span><span class="p">,</span> <span class="n">ptax_amc</span><span class="p">,</span>
                 <span class="n">FST_AGI_trt</span><span class="p">,</span> <span class="n">FST_AGI_thd_lo</span><span class="p">,</span> <span class="n">FST_AGI_thd_hi</span><span class="p">,</span>
                 <span class="n">fstax</span><span class="p">,</span> <span class="n">iitax</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="n">surtax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Fair Share Tax, or &quot;Buffet Rule&quot;, types of reforms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    c00100: float</span>
<span class="sd">        Adjusted Gross Income (AGI)</span>
<span class="sd">    MARS: int</span>
<span class="sd">        Filing (marital) status. (1=single, 2=joint, 3=separate,</span>
<span class="sd">                                  4=household-head, 5=widow(er))</span>
<span class="sd">    ptax_was: float</span>
<span class="sd">        Employee and employer OASDI plus HI FICA tax</span>
<span class="sd">    setax: float</span>
<span class="sd">        Self-employment tax</span>
<span class="sd">    ptax_amc: float</span>
<span class="sd">        Additional Medicare Tax</span>
<span class="sd">    FST_AGI_trt: float</span>
<span class="sd">        New minimum tax; rate as a decimal fraction of AGI</span>
<span class="sd">    FST_AGI_thd_lo: list</span>
<span class="sd">        Minimum AGI needed to be subject to the new minimum tax</span>
<span class="sd">    FST_AGI_thd_hi: list</span>
<span class="sd">        AGI level at which the New Minimum Tax is fully phased in</span>
<span class="sd">    fstax: float</span>
<span class="sd">        Fair Share Tax amount</span>
<span class="sd">    iitax: float</span>
<span class="sd">        Total federal individual income tax liability</span>
<span class="sd">    combined: float</span>
<span class="sd">        Sum of iitax and payrolltax and lumpsum_tax</span>
<span class="sd">    surtax: float</span>
<span class="sd">        Individual income tax subtotal augmented by fstax</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fstax: float</span>
<span class="sd">        Fair Share Tax amount</span>
<span class="sd">    iitax: float</span>
<span class="sd">        Total federal individual income tax liability</span>
<span class="sd">    combined: float</span>
<span class="sd">        Sum of iitax and payrolltax and lumpsum_tax</span>
<span class="sd">    surtax: float</span>
<span class="sd">        Individual income tax subtotal augmented by fstax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FST_AGI_trt</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;=</span> <span class="n">FST_AGI_thd_lo</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">employee_share</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ptax_was</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">setax</span> <span class="o">+</span> <span class="n">ptax_amc</span>
        <span class="n">fstax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span> <span class="o">*</span> <span class="n">FST_AGI_trt</span> <span class="o">-</span> <span class="n">iitax</span> <span class="o">-</span> <span class="n">employee_share</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">thd_gap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">FST_AGI_thd_hi</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">FST_AGI_thd_lo</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thd_gap</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&lt;</span> <span class="n">FST_AGI_thd_hi</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">fstax</span> <span class="o">*=</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">FST_AGI_thd_lo</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">thd_gap</span>
        <span class="n">iitax</span> <span class="o">+=</span> <span class="n">fstax</span>
        <span class="n">combined</span> <span class="o">+=</span> <span class="n">fstax</span>
        <span class="n">surtax</span> <span class="o">+=</span> <span class="n">fstax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fstax</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">fstax</span><span class="p">,</span> <span class="n">iitax</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="n">surtax</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">LumpSumTax</span><span class="p">(</span><span class="n">DSI</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">,</span>
               <span class="n">LST</span><span class="p">,</span>
               <span class="n">lumpsum_tax</span><span class="p">,</span> <span class="n">combined</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes lump-sum tax and add it to combined taxes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    DSI: int</span>
<span class="sd">        1 if claimed as dependent on another return, otherwise 0</span>
<span class="sd">    num: int</span>
<span class="sd">        2 when MARS is 2 (married filing jointly); otherwise 1</span>
<span class="sd">    XTOT: int</span>
<span class="sd">        Total number of exemptions for filing unit</span>
<span class="sd">    LST: float</span>
<span class="sd">        Dollar amount of lump-sum tax</span>
<span class="sd">    lumpsum_tax: float</span>
<span class="sd">        Lumpsum (or head) tax</span>
<span class="sd">    combined: float</span>
<span class="sd">        Sum of iitax and payrolltax and lumpsum_tax</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lumpsum_tax: float</span>
<span class="sd">        Lumpsum (or head) tax</span>
<span class="sd">    combined: float</span>
<span class="sd">        Sum of iitax and payrolltax and lumpsum_tax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">LST</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">DSI</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lumpsum_tax</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lumpsum_tax</span> <span class="o">=</span> <span class="n">LST</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">+=</span> <span class="n">lumpsum_tax</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lumpsum_tax</span><span class="p">,</span> <span class="n">combined</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ExpandIncome</span><span class="p">(</span><span class="n">e00200</span><span class="p">,</span> <span class="n">pencon_p</span><span class="p">,</span> <span class="n">pencon_s</span><span class="p">,</span> <span class="n">e00300</span><span class="p">,</span> <span class="n">e00400</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span>
                 <span class="n">e00700</span><span class="p">,</span> <span class="n">e00800</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e01200</span><span class="p">,</span> <span class="n">e01400</span><span class="p">,</span> <span class="n">e01500</span><span class="p">,</span>
                 <span class="n">e02000</span><span class="p">,</span> <span class="n">e02100</span><span class="p">,</span> <span class="n">p22250</span><span class="p">,</span> <span class="n">p23250</span><span class="p">,</span> <span class="n">cmbtp</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span>
                 <span class="n">benefit_value_total</span><span class="p">,</span> <span class="n">expanded_income</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates expanded_income from component income types.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    e00200: float</span>
<span class="sd">        Wages, salaries, and tips for filing unit net of pension contributions</span>
<span class="sd">    pencon_p: float</span>
<span class="sd">        Contributions to defined-contribution pension plans for taxpayer</span>
<span class="sd">    pencon_s: float</span>
<span class="sd">        Contributions to defined-contribution pension plans for spouse</span>
<span class="sd">    e00300: float</span>
<span class="sd">        Taxable interest income</span>
<span class="sd">    e00400: float</span>
<span class="sd">        Tax-exempt interest income</span>
<span class="sd">    e00600: float</span>
<span class="sd">        Ordinary dividends included in AGI</span>
<span class="sd">    e00700: float</span>
<span class="sd">        Taxable refunds of state and local income taxes</span>
<span class="sd">    e00800: float</span>
<span class="sd">        Alimony received</span>
<span class="sd">    e00900: float</span>
<span class="sd">        Schedule C business net profit/loss for filing unit</span>
<span class="sd">    e01100: float</span>
<span class="sd">        Capital gain distributions not reported on Schedule D</span>
<span class="sd">    e01200: float</span>
<span class="sd">        Other net gain/loss from Form 4797</span>
<span class="sd">    e01400: float</span>
<span class="sd">        Taxable IRA distributions</span>
<span class="sd">    e01500: float</span>
<span class="sd">        Total pensions and annuities</span>
<span class="sd">    e02000: float</span>
<span class="sd">        Schedule E total rental, royalty, partnership, S-corporation,</span>
<span class="sd">        etc, income/loss</span>
<span class="sd">    e02100: float</span>
<span class="sd">        Farm net income/loss for filing unit from Schedule F</span>
<span class="sd">    p22250: float</span>
<span class="sd">        Schedule D net short term capital gains/losses</span>
<span class="sd">    p23250:float</span>
<span class="sd">        Schedule D net long term capital gains/losses</span>
<span class="sd">    cmbtp: float</span>
<span class="sd">        Estimate of inome on (AMT) Form 6251 but not in AGI</span>
<span class="sd">    ptax_was: float</span>
<span class="sd">        Employee and employer OASDI and HI FICA tax</span>
<span class="sd">    benefit_value_total: float</span>
<span class="sd">        Consumption value of all benefits received by tax unit, which</span>
<span class="sd">        is included in expanded income</span>
<span class="sd">    expanded_income: float</span>
<span class="sd">        Broad income measure that includes benefit_value_total</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    expanded_income: float</span>
<span class="sd">        Broad income measure that includes benefit_value_total</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expanded_income</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">e00200</span> <span class="o">+</span>  <span class="c1"># wage and salary income net of DC pension contributions</span>
        <span class="n">pencon_p</span> <span class="o">+</span>  <span class="c1"># tax-advantaged DC pension contributions for taxpayer</span>
        <span class="n">pencon_s</span> <span class="o">+</span>  <span class="c1"># tax-advantaged DC pension contributions for spouse</span>
        <span class="n">e00300</span> <span class="o">+</span>  <span class="c1"># taxable interest income</span>
        <span class="n">e00400</span> <span class="o">+</span>  <span class="c1"># non-taxable interest income</span>
        <span class="n">e00600</span> <span class="o">+</span>  <span class="c1"># dividends</span>
        <span class="n">e00700</span> <span class="o">+</span>  <span class="c1"># state and local income tax refunds</span>
        <span class="n">e00800</span> <span class="o">+</span>  <span class="c1"># alimony received</span>
        <span class="n">e00900</span> <span class="o">+</span>  <span class="c1"># Sch C business net income/loss</span>
        <span class="n">e01100</span> <span class="o">+</span>  <span class="c1"># capital gain distributions not reported on Sch D</span>
        <span class="n">e01200</span> <span class="o">+</span>  <span class="c1"># Form 4797 other net gain/loss</span>
        <span class="n">e01400</span> <span class="o">+</span>  <span class="c1"># taxable IRA distributions</span>
        <span class="n">e01500</span> <span class="o">+</span>  <span class="c1"># total pension &amp; annuity income (including DB-plan benefits)</span>
        <span class="n">e02000</span> <span class="o">+</span>  <span class="c1"># Sch E total rental, ..., partnership, S-corp income/loss</span>
        <span class="n">e02100</span> <span class="o">+</span>  <span class="c1"># Sch F farm net income/loss</span>
        <span class="n">p22250</span> <span class="o">+</span>  <span class="c1"># Sch D: net short-term capital gain/loss</span>
        <span class="n">p23250</span> <span class="o">+</span>  <span class="c1"># Sch D: net long-term capital gain/loss</span>
        <span class="n">cmbtp</span> <span class="o">+</span>  <span class="c1"># other AMT taxable income items from Form 6251</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ptax_was</span> <span class="o">+</span>  <span class="c1"># employer share of FICA taxes on wages/salaries</span>
        <span class="n">benefit_value_total</span>  <span class="c1"># consumption value of all benefits received;</span>
        <span class="c1"># see the BenefitPrograms function in this file for details on</span>
        <span class="c1"># exactly how the benefit_value_total variable is computed</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">expanded_income</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">AfterTaxIncome</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">expanded_income</span><span class="p">,</span> <span class="n">aftertax_income</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates after-tax expanded income.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    combined: float</span>
<span class="sd">        Sum of iitax and payrolltax and lumpsum_tax</span>
<span class="sd">    expanded_income: float</span>
<span class="sd">        Broad income measure that includes benefit_value_total</span>
<span class="sd">    aftertax_income: float</span>
<span class="sd">        After tax income is equal to expanded_income minus combined</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aftertax_income: float</span>
<span class="sd">        After tax income is equal to expanded_income minus combined</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aftertax_income</span> <span class="o">=</span> <span class="n">expanded_income</span> <span class="o">-</span> <span class="n">combined</span>
    <span class="k">return</span> <span class="n">aftertax_income</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Policy Simulation Library
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>