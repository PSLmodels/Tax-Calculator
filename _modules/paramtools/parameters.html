
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>paramtools.parameters &#8212; Tax-Calculator</title>
    
  <link rel="stylesheet" href="../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/PSL.svg" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Tax-Calculator</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../index.html">
   Tax-Calculator
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Usage
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../usage/starting.html">
   Getting started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../usage/overview.html">
   Structural overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../guide/index.html">
   User guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../recipes/index.html">
   Recipes
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  About
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/history.html">
   History
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/roadmap.html">
   Roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/releases.html">
   Release history
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/upgrading.html">
   Upgrading to Tax-Calculator 2.0
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/license.html">
   License
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Contributing
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../contributing/contributor_guide.html">
   Contributor guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../contributing/pr_workflow.html">
   Pull request workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../contributing/param_naming.html">
   Policy parameter naming and placing conventions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../contributing/testing.html">
   Testing
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  API
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../api/public_api.html">
   Tax-Calculator Python API
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/PSLmodels/Tax-Calculator"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/PSLmodels/Tax-Calculator/issues/new?title=Issue%20on%20page%20%2F_modules/paramtools/parameters.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <h1>Source code for paramtools.parameters</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Mapping</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">MarshmallowValidationError</span>

<span class="kn">from</span> <span class="nn">paramtools</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">paramtools.schema</span> <span class="kn">import</span> <span class="n">ParamToolsSchema</span>
<span class="kn">from</span> <span class="nn">paramtools.schema_factory</span> <span class="kn">import</span> <span class="n">SchemaFactory</span>
<span class="kn">from</span> <span class="nn">paramtools.select</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">,</span>
    <span class="n">select_eq</span><span class="p">,</span>
    <span class="n">select_ne</span><span class="p">,</span>
    <span class="n">select_gt</span><span class="p">,</span>
    <span class="n">select_gte</span><span class="p">,</span>
    <span class="n">select_lt</span><span class="p">,</span>
    <span class="n">select_lte</span><span class="p">,</span>
    <span class="n">make_cmp_func</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">paramtools.tree</span> <span class="kn">import</span> <span class="n">Tree</span>
<span class="kn">from</span> <span class="nn">paramtools.typing</span> <span class="kn">import</span> <span class="n">ValueObject</span><span class="p">,</span> <span class="n">FileDictStringLike</span>
<span class="kn">from</span> <span class="nn">paramtools.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ParamToolsError</span><span class="p">,</span>
    <span class="n">SparseValueObjectsException</span><span class="p">,</span>
    <span class="n">ValidationError</span><span class="p">,</span>
    <span class="n">InconsistentLabelsException</span><span class="p">,</span>
    <span class="n">collision_list</span><span class="p">,</span>
    <span class="n">ParameterNameCollisionException</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">Parameters</span><span class="p">:</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">array_first</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">label_to_extend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">uses_extend_func</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">index_rates</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">initial_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">index_rates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">ops</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">schemafactory</span> <span class="o">=</span> <span class="n">SchemaFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_defaults_schema</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">schemafactory</span><span class="o">.</span><span class="n">schemas</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_validators</span> <span class="o">=</span> <span class="n">schemafactory</span><span class="o">.</span><span class="n">label_validators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_validators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_labels</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">initial_state</span> <span class="ow">or</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_rates</span> <span class="o">=</span> <span class="n">index_rates</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_rates</span>

        <span class="c1"># set operators in order of importance:</span>
        <span class="c1"># __init__ arg: most important</span>
        <span class="c1"># class attribute: middle importance</span>
        <span class="c1"># schema action: least important</span>
        <span class="c1"># default value if three above are not specified.</span>
        <span class="n">default_ops</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;array_first&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;label_to_extend&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;uses_extend_func&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">schema_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operators&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">default_ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ops</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">default</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">schema_ops</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema_ops</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span><span class="p">:</span>
            <span class="n">prev_array_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">prev_array_first</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;operators&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">[</span><span class="s2">&quot;operators&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">[</span><span class="s2">&quot;operators&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operators</span><span class="p">)</span>

<div class="viewcode-block" id="Parameters.set_state"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets state for the Parameters instance. The `_state`, `label_grid`, and</span>
<span class="sd">        parameter attributes are all updated with the new state.</span>

<span class="sd">        Use the `view_state` method to inspect the current state of the instance,</span>
<span class="sd">        and use the `clear_state` method to revert to the default state.</span>

<span class="sd">        **Raises**</span>

<span class="sd">          - `ValidationError` if the labels kwargs contain labels that are not</span>
<span class="sd">            specified in schema.json or if the label values fail the</span>
<span class="sd">            validator set for the corresponding label in schema.json.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_state</span><span class="p">(</span><span class="o">**</span><span class="n">labels</span><span class="p">)</span></div>

<div class="viewcode-block" id="Parameters.clear_state"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.clear_state">[docs]</a>    <span class="k">def</span> <span class="nf">clear_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the state of the `Parameters` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_state</span><span class="p">()</span></div>

<div class="viewcode-block" id="Parameters.view_state"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.view_state">[docs]</a>    <span class="k">def</span> <span class="nf">view_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Access the label state of the ``Parameters`` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span></div>

<div class="viewcode-block" id="Parameters.read_params"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.read_params">[docs]</a>    <span class="k">def</span> <span class="nf">read_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params_or_path</span><span class="p">:</span> <span class="n">FileDictStringLike</span><span class="p">,</span>
        <span class="n">storage_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read JSON data of the form:</span>

<span class="sd">        - Python `dict`.</span>
<span class="sd">        - JSON string.</span>
<span class="sd">        - Local file path.</span>
<span class="sd">        - Any URL readable by fsspec. For example:</span>
<span class="sd">            - s3: `s3://paramtools-test/defaults.json`</span>
<span class="sd">            - gcs: `gs://paramtools-dev/defaults.json`</span>
<span class="sd">            - http: `https://somedomain.com/defaults.json`</span>
<span class="sd">            - github: `github://PSLmodels:ParamTools@master/paramtools/tests/defaults.json`</span>

<span class="sd">        **Returns**</span>
<span class="sd">        - `params`: Python Dict created from JSON file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">params_or_path</span><span class="p">,</span> <span class="n">storage_options</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">adjust</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params_or_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ValueObject</span><span class="p">]]],</span>
        <span class="n">ignore_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">raise_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">extend_adj</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">clobber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deserialize and validate parameter adjustments. `params_or_path`</span>
<span class="sd">        can be a file path or a `dict` that has not been fully deserialized.</span>
<span class="sd">        The adjusted values replace the current values stored in the</span>
<span class="sd">        corresponding parameter attributes.</span>

<span class="sd">        If `clobber` is `True` and extend mode is on, then all future values</span>
<span class="sd">        for a given parameter be replaced by the values in the adjustment.</span>
<span class="sd">        If `clobber` is `False` and extend mode is on, then user-defined values</span>
<span class="sd">        will not be replaced by values in this adjustment. Only values that</span>
<span class="sd">        were added automatically via the extend method will be updated.</span>

<span class="sd">        This simply calls a private method `_adjust` to do the upate. Creating</span>
<span class="sd">        this layer on top of `_adjust` makes it easy to subclass `Parameters` and</span>
<span class="sd">        implement custom `adjust` methods.</span>

<span class="sd">        **Parameters**</span>

<span class="sd">          - `params_or_path`: Adjustment that is either a `dict`, file path, or</span>
<span class="sd">            JSON string.</span>
<span class="sd">          - `ignore_warnings`: Whether to raise an error on warnings or ignore them.</span>
<span class="sd">          - `raise_errors`: Either raise errors or simply store the error messages.</span>
<span class="sd">          - `extend_adj`: If in extend mode, this is a flag indicating whether to</span>
<span class="sd">            extend the adjustment values or not.</span>
<span class="sd">          - `clobber`: If in extend mode, this is a flag indicating whether to</span>
<span class="sd">            override all values, including user-defined values, or to only</span>
<span class="sd">            override automatically created values.</span>

<span class="sd">        **Returns**</span>

<span class="sd">          - `params`: Parsed, validated parameters.</span>

<span class="sd">        **Raises**</span>

<span class="sd">          - `marshmallow.exceptions.ValidationError` if data is not valid.</span>

<span class="sd">          - `ParameterUpdateException` if label values do not match at</span>
<span class="sd">            least one existing value item&#39;s corresponding label values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjust</span><span class="p">(</span>
            <span class="n">params_or_path</span><span class="p">,</span>
            <span class="n">ignore_warnings</span><span class="o">=</span><span class="n">ignore_warnings</span><span class="p">,</span>
            <span class="n">raise_errors</span><span class="o">=</span><span class="n">raise_errors</span><span class="p">,</span>
            <span class="n">extend_adj</span><span class="o">=</span><span class="n">extend_adj</span><span class="p">,</span>
            <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_adjust</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params_or_path</span><span class="p">,</span>
        <span class="n">ignore_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extend_adj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">is_deserialized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method for performing adjustments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate user adjustments.</span>
        <span class="k">if</span> <span class="n">is_deserialized</span><span class="p">:</span>
            <span class="n">parsed_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">params_or_path</span><span class="p">,</span> <span class="n">ignore_warnings</span><span class="p">,</span> <span class="n">is_deserialized</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">MarshmallowValidationError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_validation_messages</span><span class="p">(</span><span class="n">ve</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">params_or_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_params</span><span class="p">(</span><span class="n">params_or_path</span><span class="p">)</span>
            <span class="n">parsed_params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parsed_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">params</span><span class="p">,</span> <span class="n">ignore_warnings</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">MarshmallowValidationError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_validation_messages</span><span class="p">(</span><span class="n">ve</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extend_adj</span><span class="p">:</span>
                <span class="n">extend_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span><span class="p">]</span>
                <span class="n">to_delete</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
                <span class="n">backup</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">cmp_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_validators</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span>
                <span class="p">]</span><span class="o">.</span><span class="n">cmp_funcs</span><span class="p">()</span>
                <span class="n">gt_cmp_func</span> <span class="o">=</span> <span class="n">make_cmp_func</span><span class="p">(</span><span class="n">cmp_funcs</span><span class="p">[</span><span class="s2">&quot;gt&quot;</span><span class="p">],</span> <span class="n">all_or_any</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">vos</span> <span class="ow">in</span> <span class="n">parsed_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">vo</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">grid_sort</span><span class="p">(</span>
                        <span class="n">vos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span><span class="p">,</span> <span class="n">extend_grid</span>
                    <span class="p">):</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span> <span class="ow">in</span> <span class="n">vo</span><span class="p">:</span>
                            <span class="n">query_args</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span><span class="p">:</span> <span class="n">vo</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span><span class="p">]</span>
                            <span class="p">}</span>
                            <span class="k">if</span> <span class="n">clobber</span><span class="p">:</span>
                                <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                                <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_eq</span><span class="p">(</span>
                                    <span class="n">param</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_auto</span><span class="o">=</span><span class="kc">True</span>
                                <span class="p">)</span>
                                <span class="n">tree</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">gt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
                                <span class="n">queryset</span><span class="p">,</span>
                                <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">cmp_func</span><span class="o">=</span><span class="n">gt_cmp_func</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="n">query_args</span><span class="p">,</span>
                                <span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">to_delete</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">+=</span> <span class="n">select_eq</span><span class="p">(</span>
                                <span class="n">gt</span><span class="p">,</span>
                                <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">labels</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_labels</span><span class="p">(</span>
                                    <span class="n">vo</span><span class="p">,</span>
                                    <span class="n">drop</span><span class="o">=</span><span class="p">[</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span><span class="p">,</span>
                                        <span class="s2">&quot;value&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;_auto&quot;</span><span class="p">,</span>
                                    <span class="p">],</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                    <span class="c1"># make copy of value objects since they</span>
                    <span class="c1"># are about to be modified</span>
                    <span class="n">backup</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">array_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># delete params that will be overwritten out by extend.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                        <span class="n">to_delete</span><span class="p">,</span>
                        <span class="n">extend_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">ignore_warnings</span><span class="o">=</span><span class="n">ignore_warnings</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># set user adjustments.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_adjust</span><span class="p">(</span>
                        <span class="n">parsed_params</span><span class="p">,</span>
                        <span class="n">extend_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">ignore_warnings</span><span class="o">=</span><span class="n">ignore_warnings</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">params</span><span class="o">=</span><span class="n">parsed_params</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                        <span class="n">ignore_warnings</span><span class="o">=</span><span class="n">ignore_warnings</span><span class="p">,</span>
                        <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">backup</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span> <span class="o">=</span> <span class="n">array_first</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">parsed_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_param</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">has_errors</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">))</span>
        <span class="n">has_warnings</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">))</span>
        <span class="c1"># throw error if raise_errors is True or ignore_warnings is False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">raise_errors</span> <span class="ow">and</span> <span class="n">has_errors</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">ignore_warnings</span> <span class="ow">and</span> <span class="n">has_warnings</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_error</span>

        <span class="c1"># Update attrs for params that were adjusted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_state</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">parsed_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">parsed_params</span>

<div class="viewcode-block" id="Parameters.delete"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params_or_path</span><span class="p">,</span>
        <span class="n">ignore_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extend_adj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete value objects in params_or_path.</span>

<span class="sd">        Returns: adjustment for deleting parameters.</span>

<span class="sd">        Raises:</span>
<span class="sd">            marshmallow.exceptions.ValidationError if data is not valid.</span>

<span class="sd">            ParameterUpdateException if label values do not match at</span>
<span class="sd">                least one existing value item&#39;s corresponding label values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete</span><span class="p">(</span>
            <span class="n">params_or_path</span><span class="p">,</span>
            <span class="n">ignore_warnings</span><span class="o">=</span><span class="n">ignore_warnings</span><span class="p">,</span>
            <span class="n">raise_errors</span><span class="o">=</span><span class="n">raise_errors</span><span class="p">,</span>
            <span class="n">extend_adj</span><span class="o">=</span><span class="n">extend_adj</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_delete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params_or_path</span><span class="p">,</span>
        <span class="n">ignore_warnings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extend_adj</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method that sets the &#39;value&#39; member for all value objects</span>
<span class="sd">        to None. Value objects with &#39;value&#39; set to None are deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_params</span><span class="p">(</span><span class="n">params_or_path</span><span class="p">)</span>
        <span class="c1"># Validate user adjustments.</span>
        <span class="n">parsed_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">ignore_warnings</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">MarshmallowValidationError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_validation_messages</span><span class="p">(</span><span class="n">ve</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="n">to_delete</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">vos</span> <span class="ow">in</span> <span class="n">parsed_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">to_delete</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">vo</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span> <span class="k">for</span> <span class="n">vo</span> <span class="ow">in</span> <span class="n">vos</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_param</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">to_delete</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extend_adj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extend</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">has_errors</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">))</span>
        <span class="n">has_warnings</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">))</span>
        <span class="c1"># throw error if raise_errors is True or ignore_warnings is False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">raise_errors</span> <span class="ow">and</span> <span class="n">has_errors</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">ignore_warnings</span> <span class="ow">and</span> <span class="n">has_warnings</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_error</span>

        <span class="c1"># Update attrs for params that were adjusted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_state</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">to_delete</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">to_delete</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">param</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">messages</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">param</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">messages</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">validation_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="p">}</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="s2">&quot;warnings&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>
        <span class="n">pre</span><span class="p">[</span><span class="s2">&quot;operators&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span>
        <span class="k">return</span> <span class="n">ParamToolsSchema</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">operators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;array_first&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span><span class="p">,</span>
            <span class="s2">&quot;label_to_extend&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span><span class="p">,</span>
            <span class="s2">&quot;uses_extend_func&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_extend_func</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">use_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump a representation of this instance to JSON. This makes it</span>
<span class="sd">        possible to load this instance&#39;s data after sending the data</span>
<span class="sd">        across the wire or from another programming language. The</span>
<span class="sd">        dumped values will be queried using this instance&#39;s state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specification</span><span class="p">(</span>
            <span class="n">meta_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">include_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">serializable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">sort_values</span><span class="o">=</span><span class="n">sort_values</span><span class="p">,</span>
            <span class="n">use_state</span><span class="o">=</span><span class="n">use_state</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">}</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="Parameters.specification"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.specification">[docs]</a>    <span class="k">def</span> <span class="nf">specification</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">use_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">meta_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">include_empty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">serializable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">sort_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">labels</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query value(s) of all parameters along labels specified in</span>
<span class="sd">        `labels`.</span>

<span class="sd">        **Parameters**</span>

<span class="sd">          - `use_state`: Use the instance&#39;s state for the select operation.</span>
<span class="sd">          - `meta_data`: Include information like the parameter</span>
<span class="sd">            `description` and title.</span>
<span class="sd">          - `include_empty`: Include parameters that do not meet the label query.</span>
<span class="sd">          - `serializable`: Return data that is compatible with `json.dumps`.</span>
<span class="sd">          - `sort_values`: Sort values by the `label` order.</span>

<span class="sd">        **Returns**</span>

<span class="sd">          - `dict` of parameter names and data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_state</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>

        <span class="n">all_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_eq</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sort_values</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">result</span><span class="p">},</span> <span class="n">has_meta_data</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)[</span><span class="n">param</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">or</span> <span class="n">include_empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">meta_data</span><span class="p">:</span>
                    <span class="n">param_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">param_data</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">})</span>
                <span class="c1"># Add &quot;value&quot; key to match marshmallow schema format.</span>
                <span class="k">elif</span> <span class="n">serializable</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
                <span class="n">all_params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">serializable</span><span class="p">:</span>
            <span class="n">ser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults_schema</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">all_params</span><span class="p">)</span>
            <span class="c1"># Unpack the values after serialization if meta_data not specified.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">meta_data</span><span class="p">:</span>
                <span class="n">ser</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ser</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">return</span> <span class="n">ser</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">all_params</span></div>

<div class="viewcode-block" id="Parameters.to_array"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.to_array">[docs]</a>    <span class="k">def</span> <span class="nf">to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a Value object to an n-labelal array. The list of Value</span>
<span class="sd">        objects must span the specified parameter space. The parameter space</span>
<span class="sd">        is defined by inspecting the label validators in schema.json</span>
<span class="sd">        and the state attribute of the Parameters instance.</span>

<span class="sd">        **Parameters**</span>
<span class="sd">          - `param`: Name of parameter that will be used to create array.</span>
<span class="sd">          - `labels`: Optionally, override instance state.</span>

<span class="sd">        **Returns**</span>

<span class="sd">          - `arr`: NumPy array created from list of value objects.</span>

<span class="sd">        **Raises**</span>

<span class="sd">          - `InconsistentLabelsException`: Value objects do not have consistent</span>
<span class="sd">            labels.</span>
<span class="sd">          - `SparseValueObjectsException`: Value object does not span the</span>
<span class="sd">            entire space specified by the Order object.</span>
<span class="sd">          - `ParamToolsError`: Parameter is an array type and has labels.</span>
<span class="sd">            This is not supported by ParamTools when using array_first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label_grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_grid</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">parsed_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_labels</span><span class="p">(</span><span class="o">**</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">label_grid</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parsed_labels</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parsed_labels</span><span class="p">)</span>
        <span class="n">value_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_eq</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_items</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="n">label_order</span><span class="p">,</span> <span class="n">value_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_order</span><span class="p">(</span>
            <span class="n">param</span><span class="p">,</span> <span class="n">value_items</span><span class="p">,</span> <span class="n">label_grid</span>
        <span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_order</span><span class="p">:</span>
            <span class="n">shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value_order</span><span class="p">[</span><span class="n">label</span><span class="p">]))</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># Compare len value items with the expected length if they are full.</span>
        <span class="c1"># In the futute, sparse objects should be supported by filling in the</span>
        <span class="c1"># unspecified labels.</span>
        <span class="n">number_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;number_dims&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shape</span> <span class="ow">and</span> <span class="n">number_dims</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">value_items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_numpy_type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">shape</span> <span class="ow">and</span> <span class="n">number_dims</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParamToolsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parameter &#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&#39; is an array parameter with </span><span class="si">{</span><span class="n">number_dims</span><span class="si">}</span><span class="s2"> dimension(s) and &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;has labels: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_order</span><span class="p">)</span><span class="si">}</span><span class="s2">.</span><span class="se">\n\n</span><span class="s2">ParamTools does not &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;support the use of &#39;array_first&#39; with array parameters that use labels. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You may be able to describe this parameter&#39;s values with additional &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;labels</span><span class="se">\n</span><span class="s2">and the &#39;label_to_extend&#39; operator.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">shape</span> <span class="ow">and</span> <span class="n">number_dims</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_numpy_type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value_items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="nb">object</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">exp_full_shape</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
        <span class="n">act_full_shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_items</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">act_full_shape</span> <span class="o">!=</span> <span class="n">exp_full_shape</span><span class="p">:</span>
            <span class="c1"># maintains label value order over value objects.</span>
            <span class="n">exp_grid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">value_order</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="c1"># preserve label value order for each value object by</span>
            <span class="c1"># iterating over label_order.</span>
            <span class="n">actual</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">vo</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">label_order</span><span class="p">)</span> <span class="k">for</span> <span class="n">vo</span> <span class="ow">in</span> <span class="n">value_items</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">exp_grid</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">actual</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">SparseValueObjectsException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The Value objects for </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2"> do not span the specified &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;parameter space. Missing combinations:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">list_2_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_numpy_type</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">vi</span> <span class="ow">in</span> <span class="n">value_items</span><span class="p">:</span>
            <span class="c1"># ix stores the indices of `arr` that need to be filled in.</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">label_order</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">label_pos</span><span class="p">,</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_order</span><span class="p">):</span>
                <span class="c1"># assume value_items is dense in the sense that it spans</span>
                <span class="c1"># the label space.</span>
                <span class="n">ix</span><span class="p">[</span><span class="n">label_pos</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">value_order</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="n">label_name</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">list_2_tuple</span><span class="p">,</span> <span class="n">ix</span><span class="p">))</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">vi</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">arr</span></div>

<div class="viewcode-block" id="Parameters.from_array"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.from_array">[docs]</a>    <span class="k">def</span> <span class="nf">from_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert NumPy array to a Value object.</span>

<span class="sd">        **Parameters**</span>

<span class="sd">          - `param`: Name of parameter to convert to a list of value objects.</span>
<span class="sd">          - `array`: Optionally, provide a NumPy array to convert into a list</span>
<span class="sd">            of value objects. If not specified, the value at `self.param` will</span>
<span class="sd">            be used.</span>
<span class="sd">          - `labels`: Optionally, override instance state.</span>


<span class="sd">        **Returns**</span>

<span class="sd">          - List of `ValueObjects`</span>

<span class="sd">        **Raises**</span>

<span class="sd">          - `InconsistentLabelsException`: Value objects do not have consistent</span>
<span class="sd">            labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;A NumPy Ndarray should be passed to this method &quot;</span>
                    <span class="s2">&quot;or the instance attribute should be an array.&quot;</span>
                <span class="p">)</span>

        <span class="n">label_grid</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_grid</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">parsed_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_labels</span><span class="p">(</span><span class="o">**</span><span class="n">labels</span><span class="p">)</span>
            <span class="n">label_grid</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parsed_labels</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parsed_labels</span><span class="p">)</span>

        <span class="n">value_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_eq</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">state</span><span class="p">)</span>
        <span class="n">label_order</span><span class="p">,</span> <span class="n">value_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_order</span><span class="p">(</span>
            <span class="n">param</span><span class="p">,</span> <span class="n">value_items</span><span class="p">,</span> <span class="n">label_grid</span>
        <span class="p">)</span>
        <span class="n">label_values</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">value_order</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">label_indices</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
            <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">value_order</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">value_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dv</span><span class="p">,</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">label_values</span><span class="p">,</span> <span class="n">label_indices</span><span class="p">):</span>
            <span class="n">vi</span> <span class="o">=</span> <span class="p">{</span><span class="n">label_order</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> <span class="n">dv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="p">))}</span>
            <span class="n">vi</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">di</span><span class="p">]</span>
            <span class="n">value_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value_items</span></div>

<div class="viewcode-block" id="Parameters.extend"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">label_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raise_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ignore_warnings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extend parameters along `label`.</span>

<span class="sd">        **Parameters**</span>

<span class="sd">        - `label`: Label to extend values along. By default, `label_to_extend`</span>
<span class="sd">          is used.</span>
<span class="sd">        - `label_values`: values of `label` to extend. By default, this is a grid</span>
<span class="sd">          created from the valid values of `label_to_extend`.</span>
<span class="sd">        - `params`: Parameters to extend. By default, all parameters are extended.</span>
<span class="sd">        - `raise_errors`: Whether `adjust` should raise or store errors.</span>
<span class="sd">        - `ignore_warnings`: Whether `adjust` should raise or ignore warnings.</span>

<span class="sd">        **Raises**</span>

<span class="sd">          - `InconsistentLabelsException`: Value objects do not have consistent</span>
<span class="sd">            labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_extend</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">label</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specification</span><span class="p">(</span><span class="n">meta_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">param</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span>
            <span class="p">}</span>
        <span class="n">full_extend_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_labels</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">label_values</span><span class="p">})</span>
            <span class="n">extend_grid</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extend_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

        <span class="n">cmp_funcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_validators</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">cmp_funcs</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">extend_grid</span><span class="p">)</span>
        <span class="n">gt_cmp_func</span> <span class="o">=</span> <span class="n">make_cmp_func</span><span class="p">(</span><span class="n">cmp_funcs</span><span class="p">[</span><span class="s2">&quot;gt&quot;</span><span class="p">],</span> <span class="n">all_or_any</span><span class="o">=</span><span class="nb">all</span><span class="p">)</span>

        <span class="n">adjustment</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">label</span> <span class="ow">in</span> <span class="n">vo</span> <span class="k">for</span> <span class="n">vo</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">extended_vos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vo</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">cmp_funcs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">](</span><span class="n">val</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">hashable_vo</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">hashable_value_object</span><span class="p">(</span><span class="n">vo</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hashable_vo</span> <span class="ow">in</span> <span class="n">extended_vos</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extended_vos</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hashable_vo</span><span class="p">)</span>
                <span class="n">gt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">gt_cmp_func</span><span class="p">,</span>
                    <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">vo</span><span class="p">[</span><span class="n">label</span><span class="p">]},</span>
                    <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="n">select_eq</span><span class="p">(</span>
                    <span class="n">gt</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">filter_labels</span><span class="p">(</span><span class="n">vo</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s2">&quot;_auto&quot;</span><span class="p">]),</span>
                <span class="p">)</span>
                <span class="n">extended_vos</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">hashable_value_object</span><span class="p">,</span> <span class="n">eq</span><span class="p">))</span>
                <span class="n">eq</span> <span class="o">+=</span> <span class="p">[</span><span class="n">vo</span><span class="p">]</span>

                <span class="n">defined_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">eq_vo</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">eq_vo</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">}</span>

                <span class="n">missing_vals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">extend_grid</span><span class="p">)</span> <span class="o">-</span> <span class="n">defined_vals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">cmp_funcs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_vals</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">extended</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">vo</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">:</span>
                    <span class="n">extended</span><span class="p">[</span><span class="n">vo</span><span class="p">[</span><span class="n">label</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vo</span><span class="p">)</span>

                <span class="n">skl</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">SortedKeyList</span><span class="p">(</span><span class="n">extended</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">cmp_funcs</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">])</span>

                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">missing_vals</span><span class="p">:</span>
                    <span class="n">lte_val</span> <span class="o">=</span> <span class="n">skl</span><span class="o">.</span><span class="n">lte</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lte_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">closest_val</span> <span class="o">=</span> <span class="n">lte_val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">closest_val</span> <span class="o">=</span> <span class="n">skl</span><span class="o">.</span><span class="n">gte</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">closest_val</span> <span class="ow">in</span> <span class="n">extended</span><span class="p">:</span>
                        <span class="n">value_objects</span> <span class="o">=</span> <span class="n">extended</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closest_val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value_objects</span> <span class="o">=</span> <span class="n">select_eq</span><span class="p">(</span>
                            <span class="n">eq</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">closest_val</span><span class="p">}</span>
                        <span class="p">)</span>
                    <span class="c1"># In practice, value_objects has length one.</span>
                    <span class="c1"># Theoretically, there could be multiple if the inital value</span>
                    <span class="c1"># object had less labels than later value objects and thus</span>
                    <span class="c1"># matched multiple value objects.</span>
                    <span class="k">for</span> <span class="n">value_object</span> <span class="ow">in</span> <span class="n">value_objects</span><span class="p">:</span>
                        <span class="n">ext</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value_object</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
                        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extend_func</span><span class="p">(</span>
                            <span class="n">param</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">value_object</span><span class="p">,</span> <span class="n">full_extend_grid</span><span class="p">,</span> <span class="n">label</span>
                        <span class="p">)</span>
                        <span class="n">extended_vos</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                            <span class="n">utils</span><span class="o">.</span><span class="n">hashable_value_object</span><span class="p">(</span><span class="n">value_object</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">extended</span><span class="p">[</span><span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                        <span class="n">skl</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="n">adjustment</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">_auto</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="c1"># Ensure that the adjust method of paramtools.Parameter is used</span>
        <span class="c1"># in case the child class also implements adjust.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adjust</span><span class="p">(</span>
            <span class="n">adjustment</span><span class="p">,</span>
            <span class="n">extend_adj</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ignore_warnings</span><span class="o">=</span><span class="n">ignore_warnings</span><span class="p">,</span>
            <span class="n">raise_errors</span><span class="o">=</span><span class="n">raise_errors</span><span class="p">,</span>
            <span class="n">is_deserialized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Parameters.extend_func"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.extend_func">[docs]</a>    <span class="k">def</span> <span class="nf">extend_func</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">extend_vo</span><span class="p">:</span> <span class="n">ValueObject</span><span class="p">,</span>
        <span class="n">known_vo</span><span class="p">:</span> <span class="n">ValueObject</span><span class="p">,</span>
        <span class="n">extend_grid</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
        <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for applying indexing rates to parameter values as they</span>
<span class="sd">        are extended. Projects may implement their own `extend_func` by</span>
<span class="sd">        overriding this one. Projects need to write their own `indexing_rate`</span>
<span class="sd">        method for returning the correct indexing rate for a given parameter</span>
<span class="sd">        and value of `label`.</span>

<span class="sd">        **Returns**</span>

<span class="sd">          - `extend_vo`: New `ValueObject`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_extend_func</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;indexed&quot;</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">extend_vo</span>

        <span class="n">known_val</span> <span class="o">=</span> <span class="n">known_vo</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="n">known_ix</span> <span class="o">=</span> <span class="n">extend_grid</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">known_val</span><span class="p">)</span>

        <span class="n">toext_val</span> <span class="o">=</span> <span class="n">extend_vo</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="n">toext_ix</span> <span class="o">=</span> <span class="n">extend_grid</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">toext_val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">toext_ix</span> <span class="o">&gt;</span> <span class="n">known_ix</span><span class="p">:</span>
            <span class="c1"># grow value according to the index rate supplied by the user defined</span>
            <span class="c1"># self.indexing_rate method.</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">known_ix</span><span class="p">,</span> <span class="n">toext_ix</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">extend_vo</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_rate</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">extend_grid</span><span class="p">[</span><span class="n">ix</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">extend_vo</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">9e99</span> <span class="k">else</span> <span class="mf">9e99</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># shrink value according to the index rate supplied by the user defined</span>
            <span class="c1"># self.indexing_rate method.</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">toext_ix</span><span class="p">,</span> <span class="n">known_ix</span><span class="p">)):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">extend_vo</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                    <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_index_rate</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">extend_grid</span><span class="p">[</span><span class="n">ix</span><span class="p">]))</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">extend_vo</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">9e99</span> <span class="k">else</span> <span class="mf">9e99</span>
        <span class="k">return</span> <span class="n">extend_vo</span></div>

    <span class="k">def</span> <span class="nf">get_index_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lte_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the value of the index_rates dictionary matching the</span>
<span class="sd">        label to extend value, `lte_val`.</span>
<span class="sd">        Projects may find it convenient to override this method with their own</span>
<span class="sd">        `index_rate` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_rates</span><span class="p">[</span><span class="n">lte_val</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse and validate labels.</span>

<span class="sd">        **Returns**</span>

<span class="sd">        - Parsed and validated labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_validators</span><span class="p">:</span>
                <span class="n">messages</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not a valid label.&quot;</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">list_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">list_values</span> <span class="o">=</span> <span class="n">values</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">list_values</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parsed</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">label_validators</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">MarshmallowValidationError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
                    <span class="n">messages</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ve</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">({</span><span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">},</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parsed</span>

    <span class="k">def</span> <span class="nf">_set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method for setting the state on a Parameters instance. Internal</span>
<span class="sd">        methods can set which params will be updated. This is helpful when a set</span>
<span class="sd">        of parameters are adjusted and only their attributes need to be updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_labels</span><span class="p">(</span><span class="o">**</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label_name</span><span class="p">,</span> <span class="n">label_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label_grid</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_value</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specification</span><span class="p">(</span><span class="n">include_empty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">spec</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">collision_list</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterNameCollisionException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The paramter name, &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, is already used by the Parameters object.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value_items</span><span class="p">,</span> <span class="n">label_grid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve the order of the labels and their values by</span>
<span class="sd">        inspecting data in the label grid values.</span>

<span class="sd">        The labels to be used are the ones that are specified</span>
<span class="sd">        for each value object. Note that the labels must be specified</span>
<span class="sd">        _consistently_ for all value objects, i.e. none can be added or omitted</span>
<span class="sd">        for any value object in the list.</span>

<span class="sd">        **Returns**</span>

<span class="sd">            - `label_order`: The label order.</span>
<span class="sd">            - `value_order`: The values, in order, for each label.</span>

<span class="sd">        **Raises**</span>

<span class="sd">            - `InconsistentLabelsException`: Value objects do not have consistent</span>
<span class="sd">                labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">used</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">consistent_labels</span><span class="p">(</span><span class="n">value_items</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">used</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InconsistentLabelsException</span><span class="p">(</span>
                <span class="s2">&quot;Labels were added or omitted for some value object(s).&quot;</span>
            <span class="p">)</span>
        <span class="n">label_order</span><span class="p">,</span> <span class="n">value_order</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">label_name</span><span class="p">,</span> <span class="n">label_values</span> <span class="ow">in</span> <span class="n">label_grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">label_name</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
                <span class="n">label_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_name</span><span class="p">)</span>
                <span class="n">value_order</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_values</span>
        <span class="k">return</span> <span class="n">label_order</span><span class="p">,</span> <span class="n">value_order</span>

    <span class="k">def</span> <span class="nf">_numpy_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the numpy type for a given parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validator_schema</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">np_type</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">select_eq</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="n">strict</span><span class="p">,</span>
            <span class="n">labels</span><span class="p">,</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_ne</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">select_ne</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="n">strict</span><span class="p">,</span>
            <span class="n">labels</span><span class="p">,</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_gt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">select_gt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="n">strict</span><span class="p">,</span>
            <span class="n">labels</span><span class="p">,</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_gte</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">select_gte</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="n">strict</span><span class="p">,</span>
            <span class="n">labels</span><span class="p">,</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_lt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">select_lt</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="n">strict</span><span class="p">,</span>
            <span class="n">labels</span><span class="p">,</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_lte</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">select_lte</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span>
            <span class="n">strict</span><span class="p">,</span>
            <span class="n">labels</span><span class="p">,</span>
            <span class="n">tree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">new_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the current parameter values with those specified by</span>
<span class="sd">        the adjustment. The values that need to be updated are chosen</span>
<span class="sd">        by finding all value items with label values matching the</span>
<span class="sd">        label values specified in the adjustment. If the value is</span>
<span class="sd">        set to None, then that value object will be removed.</span>

<span class="sd">        Note: _update_param used to raise a ParameterUpdateException if one of the new</span>
<span class="sd">            values did not match at least one of the current value objects. However,</span>
<span class="sd">            this was dropped to better support the case where the parameters are being</span>
<span class="sd">            extended along some label to fill the parameter space. An exception could</span>
<span class="sd">            be raised if a new value object contains a label that is not used in the</span>
<span class="sd">            current value objects for the parameter. However, it seems like it could be</span>
<span class="sd">            expensive to check this case, especially when a project is extending parameters.</span>
<span class="sd">            For now, no exceptions are raised by this method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">curr_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="p">:</span>
            <span class="n">curr_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curr_tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="n">vos</span><span class="o">=</span><span class="n">curr_values</span><span class="p">,</span> <span class="n">label_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label_grid</span><span class="p">)</span>
        <span class="n">new_tree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">(</span><span class="n">vos</span><span class="o">=</span><span class="n">new_values</span><span class="p">,</span> <span class="n">label_grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label_grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_tree</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_trees</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_tree</span>

    <span class="k">def</span> <span class="nf">_parse_validation_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse validation messages from marshmallow&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">messages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warnings&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_errors</span><span class="p">(</span><span class="n">messages</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;warnings&quot;</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_errors</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_parse_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the error messages given by marshmallow.</span>

<span class="sd">        Marshamllow error structure:</span>

<span class="sd">        {</span>
<span class="sd">            &quot;list_param&quot;: {</span>
<span class="sd">                0: {</span>
<span class="sd">                    &quot;value&quot;: {</span>
<span class="sd">                        0: [err message for first item in value list]</span>
<span class="sd">                        i: [err message for i-th item in value list]</span>
<span class="sd">                    }</span>
<span class="sd">                },</span>
<span class="sd">                i-th value object: {</span>
<span class="sd">                    &quot;value&quot;: {</span>
<span class="sd">                        0: [...],</span>
<span class="sd">                        ...</span>
<span class="sd">                    }</span>
<span class="sd">                },</span>
<span class="sd">            }</span>
<span class="sd">            &quot;nonlist_param&quot;: {</span>
<span class="sd">                0: {</span>
<span class="sd">                    &quot;value&quot;: [err message]</span>
<span class="sd">                },</span>
<span class="sd">                ...</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">        self._errors structure:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;messages&quot;: {</span>
<span class="sd">                &quot;param&quot;: [</span>
<span class="sd">                    [&quot;value&quot;: {0: [msg0, msg1, ...], other_bad_ix: ...},</span>
<span class="sd">                     &quot;label0&quot;: {0: msg, ...} // if errors on label values.</span>
<span class="sd">                ],</span>
<span class="sd">                ...</span>
<span class="sd">            },</span>
<span class="sd">            &quot;label&quot;: {</span>
<span class="sd">                &quot;param&quot;: [</span>
<span class="sd">                    {label_name: label_value, other_label_name: other_label_value},</span>
<span class="sd">                    ...</span>
<span class="sd">                    // list indices correspond to the error messages&#39; indices</span>
<span class="sd">                    // of the error messages caused by the value of this value</span>
<span class="sd">                    // object.</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">messages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">pname</span> <span class="o">==</span> <span class="s2">&quot;_schema&quot;</span><span class="p">:</span>
                <span class="n">error_info</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;Data format error: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;Unknown field.&quot;</span><span class="p">]:</span>
                <span class="n">error_info</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Unknown field: </span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="n">param_data</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ensure_value_object</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">pname</span><span class="p">])</span>
            <span class="n">error_labels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">formatted_errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">marshmessages</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">error_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">utils</span><span class="o">.</span><span class="n">filter_labels</span><span class="p">(</span><span class="n">param_data</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">formatted_errors_ix</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">messages</span> <span class="ow">in</span> <span class="n">marshmessages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">messages</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">formatted_errors_ix</span> <span class="o">+=</span> <span class="n">messages</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">messagelist</span> <span class="ow">in</span> <span class="n">messages</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">formatted_errors_ix</span> <span class="o">+=</span> <span class="n">messagelist</span>
                <span class="n">formatted_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted_errors_ix</span><span class="p">)</span>
            <span class="n">error_info</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted_errors</span>
            <span class="n">error_info</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">][</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_labels</span>

        <span class="k">return</span> <span class="n">error_info</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

<div class="viewcode-block" id="Parameters.keys"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return parameter names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>

<div class="viewcode-block" id="Parameters.items"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate using python dictionary .items() syntax.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">param</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Parameters.to_dict"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return instance as python dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>

<div class="viewcode-block" id="Parameters.sort_values"><a class="viewcode-back" href="../../api/parameters.html#taxcalc.parameters.Parameters.sort_values">[docs]</a>    <span class="k">def</span> <span class="nf">sort_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">has_meta_data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort value objects for all parameters in `data` according</span>
<span class="sd">        to the order specified in `schema`.</span>


<span class="sd">        **Parameters**</span>

<span class="sd">          - `data`: Parameter data to be sorted. This should be a</span>
<span class="sd">            `dict` of parameter names and values. If `data` is `None`,</span>
<span class="sd">            the current values will be sorted.</span>
<span class="sd">          - `has_meta_data`: Whether parameter values should be accessed</span>
<span class="sd">            directly or through the &quot;value&quot; attribute.</span>

<span class="sd">        **Returns**</span>

<span class="sd">          - Sorted data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">keyfunc</span><span class="p">(</span><span class="n">vo</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">label_values</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">vo</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">label_values</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vo</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
            <span class="n">update_attrs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_meta_data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParamToolsError</span><span class="p">(</span>
                    <span class="s2">&quot;has_meta_data must be True if data is not specified.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update_attrs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># nothing to do if labels aren&#39;t specified</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># iterate over labels so that the first label&#39;s order</span>
        <span class="c1"># takes precedence.</span>
        <span class="n">label_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stateless_label_grid</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">label_grid</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
                <span class="n">label_values</span> <span class="o">=</span> <span class="n">label_grid</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="n">pfunc</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                    <span class="n">keyfunc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">label_values</span><span class="o">=</span><span class="n">label_values</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">has_meta_data</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">pfunc</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">pfunc</span><span class="p">)</span>

            <span class="c1"># Only update attributes when array first is off, since</span>
            <span class="c1"># value order will not affect how arrays are constructed.</span>
            <span class="k">if</span> <span class="n">update_attrs</span> <span class="ow">and</span> <span class="n">has_meta_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">array_first</span><span class="p">:</span>
                <span class="n">attr_vals</span> <span class="o">=</span> <span class="n">select_eq</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span>
                <span class="p">)</span>
                <span class="n">sorted_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">attr_vals</span><span class="p">},</span> <span class="n">has_meta_data</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)[</span><span class="n">param</span><span class="p">]</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">sorted_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>
</pre></div>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Policy Simulation Library<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>